"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const heap_snapshot_parser_1 = require("../lib/heap_snapshot_parser");
const chrome_debugging_client_1 = require("chrome-debugging-client");
const tot_1 = require("chrome-debugging-client/dist/protocol/tot");
const fs_1 = require("fs");
const path_1 = require("path");
const repl = require("repl");
const esprima_1 = require("esprima");
const childProcess = require("child_process");
const mitmproxy_1 = require("mitmproxy");
const os_1 = require("os");
const util_1 = require("../common/util");
// HACK: Patch spawn to work around chrome-debugging-client limitation
// https://github.com/krisselden/chrome-debugging-client/issues/10
const originalSpawn = childProcess.spawn;
childProcess.spawn = function (command, args, options) {
    if (args && Array.isArray(args)) {
        const index = args.indexOf("--no-proxy-server");
        if (index !== -1) {
            args.splice(index, 1);
        }
    }
    return originalSpawn.call(this, command, args, options);
};
function exceptionDetailsToString(e) {
    return `${e.url}:${e.lineNumber}:${e.columnNumber} ${e.text} ${e.exception ? e.exception.description : ""}\n${e.stackTrace ? e.stackTrace.description : ""}\n  ${e.stackTrace ? e.stackTrace.callFrames.filter((f) => f.url !== "").map((f) => `${f.functionName ? `${f.functionName} at ` : ""}${f.url}:${f.lineNumber}:${f.columnNumber}`).join("\n  ") : ""}\n`;
}
/**
 * Spawns a chrome instance with a tmp user data and the debugger open to an ephemeral port
 */
function spawnChromeBrowser(session, headless, width, height) {
    const additionalChromeArgs = [`--proxy-server=127.0.0.1:8080`, `--disable-background-timer-throttling`, `--disable-renderer-backgrounding`, `--disable-renderer-priority-management`];
    if (headless) {
        // --disable-gpu required for Windows
        additionalChromeArgs.push(`--headless`, `--disable-gpu`);
    }
    const baseOptions = {
        // additionalArguments: ['--headless'],
        windowSize: { width: width, height: height },
        additionalArguments: additionalChromeArgs
    };
    switch (os_1.platform()) {
        case 'darwin':
            return session.spawnBrowser("system", baseOptions);
        case 'freebsd':
        case 'linux':
        case 'openbsd': {
            // *nix; need to find the exact path to Chrome / Chromium
            // .trim() removes trailing newline from `which` output.
            let chromePath = childProcess.execSync(`which google-chrome`).toString().trim();
            if (chromePath === "") {
                // Try Chromium
                chromePath = childProcess.execSync(`which chromium`).toString().trim();
            }
            if (chromePath === "") {
                return Promise.reject(`Unable to find a Google Chrome or Chromium installation.`);
            }
            return session.spawnBrowser("exact", Object.assign({
                executablePath: chromePath
            }, baseOptions));
        }
        case 'win32': {
            // Inspired by karma-chrome-launcher
            // https://github.com/karma-runner/karma-chrome-launcher/blob/master/index.js
            const suffix = `\\Google\\Chrome\\Application\\chrome.exe`;
            const prefixes = [process.env.LOCALAPPDATA, process.env.PROGRAMFILES, process.env['PROGRAMFILES(X86)']];
            for (const prefix of prefixes) {
                try {
                    let chromeLocation = path_1.join(prefix, suffix);
                    fs_1.accessSync(chromeLocation);
                    return session.spawnBrowser("exact", Object.assign({
                        executablePath: chromeLocation
                    }, baseOptions));
                }
                catch (e) { }
            }
            return Promise.reject(`Unable to find a Chrome installation`);
        }
        default:
            // Esoteric options
            return Promise.reject(`Unsupported platform: ${os_1.platform()}`);
    }
}
class ChromeDriver {
    constructor(log, headless, width, height, interceptPaths, quiet, mitmProxy, process, page, runtime, heapProfiler, console) {
        this._loadedFrames = new Set();
        this._shutdown = false;
        this._log = log;
        this._headless = headless;
        this.mitmProxy = mitmProxy;
        this._process = process;
        this._runtime = runtime;
        this._page = page;
        this._heapProfiler = heapProfiler;
        this._console = console;
        this._width = width;
        this._height = height;
        this._interceptPaths = interceptPaths;
        this._quiet = quiet;
        this._console.messageAdded = (evt) => {
            const m = evt.message;
            log.debug(`[${m.level}] [${m.source}] ${m.url}:${m.line}:${m.column} ${m.text}`);
        };
        this._runtime.exceptionThrown = (evt) => {
            const e = evt.exceptionDetails;
            log.error(exceptionDetailsToString(e));
        };
        this._page.frameStoppedLoading = (e) => {
            this._loadedFrames.add(e.frameId);
        };
    }
    static async Launch(log, headless, width, height, interceptPaths = [], quiet = true) {
        const mitmProxy = await mitmproxy_1.default.Create(undefined, interceptPaths, quiet);
        // Tell mitmProxy to stash data requested through the proxy.
        mitmProxy.stashEnabled = true;
        const session = await new Promise((res, rej) => chrome_debugging_client_1.createSession(res));
        let chromeProcess = await spawnChromeBrowser(session, headless, width, height);
        // open the REST API for tabs
        const client = session.createAPIClient("localhost", chromeProcess.remoteDebuggingPort);
        const tabs = await client.listTabs();
        const tab = tabs[0];
        await client.activateTab(tab.id);
        // open the debugger protocol
        // https://chromedevtools.github.io/devtools-protocol/
        const debugClient = await session.openDebuggingProtocol(tab.webSocketDebuggerUrl);
        const heapProfiler = new tot_1.HeapProfiler(debugClient);
        const network = new tot_1.Network(debugClient);
        const chromeConsole = new tot_1.Console(debugClient);
        const page = new tot_1.Page(debugClient);
        const runtime = new tot_1.Runtime(debugClient);
        const dom = new tot_1.DOM(debugClient);
        await Promise.all([heapProfiler.enable(), network.enable({}), chromeConsole.enable(), page.enable(), runtime.enable(), dom.enable()]);
        // Intercept network requests.
        // await network.setRequestInterceptionEnabled({ enabled: true });
        // Disable cache
        await network.setCacheDisabled({ cacheDisabled: true });
        // Disable service workers
        await network.setBypassServiceWorker({ bypass: true });
        const driver = new ChromeDriver(log, headless, width, height, interceptPaths, quiet, mitmProxy, chromeProcess, page, runtime, heapProfiler, chromeConsole);
        return driver;
    }
    async takeScreenshot() {
        const ss = await this._page.captureScreenshot({});
        return Buffer.from(ss.data, 'base64');
    }
    async relaunch() {
        await this.shutdown();
        const driver = await ChromeDriver.Launch(this._log, this._headless, this._width, this._height, this._interceptPaths, this._quiet);
        driver.mitmProxy.cb = this.mitmProxy.cb;
        return driver;
    }
    async navigateTo(url) {
        this._loadedFrames.clear();
        const f = await this._page.navigate({ url });
        while (!this._loadedFrames.has(f.frameId)) {
            if (this._shutdown) {
                return Promise.reject(`Cannot navigate to URL; Chrome has shut down.`);
            }
            await util_1.wait(5);
        }
    }
    async runCode(expression) {
        const e = await this._runtime.evaluate({ expression, returnByValue: true });
        this._log.debug(`${expression} => ${JSON.stringify(e.result.value)}`);
        if (e.exceptionDetails) {
            return Promise.reject(exceptionDetailsToString(e.exceptionDetails));
        }
        return e.result.value;
    }
    takeHeapSnapshot() {
        const parser = new heap_snapshot_parser_1.default();
        // 200 KB chunks
        this._heapProfiler.addHeapSnapshotChunk = (evt) => {
            parser.addSnapshotChunk(evt.chunk);
        };
        // Always take a DOM snapshot before taking a real snapshot.
        this._takeDOMSnapshot().then(() => {
            this._heapProfiler.takeHeapSnapshot({ reportProgress: false });
        });
        return parser;
    }
    async _takeDOMSnapshot() {
        const response = await this._runtime.evaluate({
            expression: "$$$SERIALIZE_DOM$$$()", returnByValue: true
        });
        return response.result.value;
    }
    async debugLoop() {
        const evalJavascript = (cmd, context, filename, callback) => {
            try {
                esprima_1.parse(cmd);
                this.runCode(cmd).then((result) => {
                    callback(null, `${result}`);
                }).catch(callback);
            }
            catch (e) {
                callback(new repl.Recoverable(e));
            }
        };
        return new Promise((resolve, reject) => {
            const r = repl.start({ prompt: "> ", eval: evalJavascript });
            r.on('exit', resolve);
        });
    }
    async shutdown() {
        this._shutdown = true;
        await Promise.all([this._process.dispose(), this.mitmProxy.shutdown()]);
    }
}
exports.default = ChromeDriver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hyb21lX2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvY2hyb21lX2RyaXZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNFQUE2RDtBQUM3RCxxRUFBc0Q7QUFFdEQsbUVBQWlOO0FBQ2pOLDJCQUE4QjtBQUM5QiwrQkFBMEI7QUFDMUIsNkJBQTZCO0FBQzdCLHFDQUFpRDtBQUNqRCw4Q0FBOEM7QUFDOUMseUNBQWtDO0FBQ2xDLDJCQUE0QjtBQUU1Qix5Q0FBb0M7QUFFcEMsc0VBQXNFO0FBQ3RFLGtFQUFrRTtBQUNsRSxNQUFNLGFBQWEsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO0FBQ2xDLFlBQWEsQ0FBQyxLQUFLLEdBQUcsVUFBUyxPQUFlLEVBQUUsSUFBZSxFQUFFLE9BQW1DO0lBQ3pHLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDaEQsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixDQUFDO0lBQ0gsQ0FBQztJQUNELE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzFELENBQUMsQ0FBQTtBQU1ELGtDQUFrQyxDQUFpQztJQUNqRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxD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b3RQYXJzZXIgZnJvbSAnLi4vbGliL2hlYXBfc25hcHNob3RfcGFyc2VyJztcbmltcG9ydCB7Y3JlYXRlU2Vzc2lvbn0gZnJvbSAnY2hyb21lLWRlYnVnZ2luZy1jbGllbnQnO1xuaW1wb3J0IHtJU2Vzc2lvbiBhcyBDaHJvbWVTZXNzaW9uLCBJQnJvd3NlclByb2Nlc3MgYXMgQ2hyb21lUHJvY2Vzc30gZnJvbSAnY2hyb21lLWRlYnVnZ2luZy1jbGllbnQvZGlzdC9saWIvdHlwZXMnO1xuaW1wb3J0IHtIZWFwUHJvZmlsZXIgYXMgQ2hyb21lSGVhcFByb2ZpbGVyLCBOZXR3b3JrIGFzIENocm9tZU5ldHdvcmssIENvbnNvbGUgYXMgQ2hyb21lQ29uc29sZSwgUGFnZSBhcyBDaHJvbWVQYWdlLCBSdW50aW1lIGFzIENocm9tZVJ1bnRpbWUsIERPTSBhcyBDaHJvbWVET019IGZyb20gXCJjaHJvbWUtZGVidWdnaW5nLWNsaWVudC9kaXN0L3Byb3RvY29sL3RvdFwiO1xuaW1wb3J0IHthY2Nlc3NTeW5jfSBmcm9tICdmcyc7XG5pbXBvcnQge2pvaW59IGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgcmVwbCBmcm9tICdyZXBsJztcbmltcG9ydCB7cGFyc2UgYXMgcGFyc2VKYXZhU2NyaXB0fSBmcm9tICdlc3ByaW1hJztcbmltcG9ydCAqIGFzIGNoaWxkUHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBNSVRNUHJveHkgZnJvbSAnbWl0bXByb3h5JztcbmltcG9ydCB7cGxhdGZvcm19IGZyb20gJ29zJztcbmltcG9ydCB7TG9nfSBmcm9tICcuLi9jb21tb24vaW50ZXJmYWNlcyc7XG5pbXBvcnQge3dhaXR9IGZyb20gJy4uL2NvbW1vbi91dGlsJztcblxuLy8gSEFDSzogUGF0Y2ggc3Bhd24gdG8gd29yayBhcm91bmQgY2hyb21lLWRlYnVnZ2luZy1jbGllbnQgbGltaXRhdGlvblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2tyaXNzZWxkZW4vY2hyb21lLWRlYnVnZ2luZy1jbGllbnQvaXNzdWVzLzEwXG5jb25zdCBvcmlnaW5hbFNwYXduID0gY2hpbGRQcm9jZXNzLnNwYXduO1xuKDxhbnk+IGNoaWxkUHJvY2Vzcykuc3Bhd24gPSBmdW5jdGlvbihjb21tYW5kOiBzdHJpbmcsIGFyZ3M/OiBzdHJpbmdbXSwgb3B0aW9ucz86IGNoaWxkUHJvY2Vzcy5TcGF3bk9wdGlvbnMpOiBjaGlsZFByb2Nlc3MuQ2hpbGRQcm9jZXNzIHtcbiAgaWYgKGFyZ3MgJiYgQXJyYXkuaXNBcnJheShhcmdzKSkge1xuICAgIGNvbnN0IGluZGV4ID0gYXJncy5pbmRleE9mKFwiLS1uby1wcm94eS1zZXJ2ZXJcIik7XG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgYXJncy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb3JpZ2luYWxTcGF3bi5jYWxsKHRoaXMsIGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERPTU5vZGUgZXh0ZW5kcyBDaHJvbWVET00uTm9kZSB7XG4gIGV2ZW50TGlzdGVuZXJDb3VudHM6IHtbbmFtZTogc3RyaW5nXTogbnVtYmVyfTtcbn1cblxuZnVuY3Rpb24gZXhjZXB0aW9uRGV0YWlsc1RvU3RyaW5nKGU6IENocm9tZVJ1bnRpbWUuRXhjZXB0aW9uRGV0YWlscyk6IHN0cmluZyB7XG4gIHJldHVybiBgJHtlLnVybH06JHtlLmxpbmVOdW1iZXJ9OiR7ZS5jb2x1bW5OdW1iZXJ9ICR7ZS50ZXh0fSAke2UuZXhjZXB0aW9uID8gZS5leGNlcHRpb24uZGVzY3JpcHRpb24gOiBcIlwifVxcbiR7ZS5zdGFja1RyYWNlID8gZS5zdGFja1RyYWNlLmRlc2NyaXB0aW9uIDogXCJcIn1cXG4gICR7ZS5zdGFja1RyYWNlID8gZS5zdGFja1RyYWNlLmNhbGxGcmFtZXMuZmlsdGVyKChmKSA9PiBmLnVybCAhPT0gXCJcIikubWFwKChmKSA9PiBgJHtmLmZ1bmN0aW9uTmFtZSA/IGAke2YuZnVuY3Rpb25OYW1lfSBhdCBgIDogXCJcIn0ke2YudXJsfToke2YubGluZU51bWJlcn06JHtmLmNvbHVtbk51bWJlcn1gKS5qb2luKFwiXFxuICBcIikgOiBcIlwifVxcbmA7XG59XG5cbi8qKlxuICogU3Bhd25zIGEgY2hyb21lIGluc3RhbmNlIHdpdGggYSB0bXAgdXNlciBkYXRhIGFuZCB0aGUgZGVidWdnZXIgb3BlbiB0byBhbiBlcGhlbWVyYWwgcG9ydFxuICovXG5mdW5jdGlvbiBzcGF3bkNocm9tZUJyb3dzZXIoc2Vzc2lvbjogQ2hyb21lU2Vzc2lvbiwgaGVhZGxlc3M6IGJvb2xlYW4sIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKTogUHJvbWlzZTxDaHJvbWVQcm9jZXNzPiB7XG4gIGNvbnN0IGFkZGl0aW9uYWxDaHJvbWVBcmdzID0gW2AtLXByb3h5LXNlcnZlcj0xMjcuMC4wLjE6ODA4MGAsIGAtLWRpc2FibGUtYmFja2dyb3VuZC10aW1lci10aHJvdHRsaW5nYCwgYC0tZGlzYWJsZS1yZW5kZXJlci1iYWNrZ3JvdW5kaW5nYCwgYC0tZGlzYWJsZS1yZW5kZXJlci1wcmlvcml0eS1tYW5hZ2VtZW50YF07XG4gIGlmIChoZWFkbGVzcykge1xuICAgIC8vIC0tZGlzYWJsZS1ncHUgcmVxdWlyZWQgZm9yIFdpbmRvd3NcbiAgICBhZGRpdGlvbmFsQ2hyb21lQXJncy5wdXNoKGAtLWhlYWRsZXNzYCwgYC0tZGlzYWJsZS1ncHVgKTtcbiAgfVxuICBjb25zdCBiYXNlT3B0aW9ucyA9IHtcbiAgICAvLyBhZGRpdGlvbmFsQXJndW1lbnRzOiBbJy0taGVhZGxlc3MnXSxcbiAgICB3aW5kb3dTaXplOiB7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfSxcbiAgICBhZGRpdGlvbmFsQXJndW1lbnRzOiBhZGRpdGlvbmFsQ2hyb21lQXJnc1xuICB9O1xuICBzd2l0Y2ggKHBsYXRmb3JtKCkpIHtcbiAgICBjYXNlICdkYXJ3aW4nOlxuICAgICAgcmV0dXJuIHNlc3Npb24uc3Bhd25Ccm93c2VyKFwic3lzdGVtXCIsIGJhc2VPcHRpb25zKTtcbiAgICBjYXNlICdmcmVlYnNkJzpcbiAgICBjYXNlICdsaW51eCc6XG4gICAgY2FzZSAnb3BlbmJzZCc6IHtcbiAgICAgIC8vICpuaXg7IG5lZWQgdG8gZmluZCB0aGUgZXhhY3QgcGF0aCB0byBDaHJvbWUgLyBDaHJvbWl1bVxuICAgICAgLy8gLnRyaW0oKSByZW1vdmVzIHRyYWlsaW5nIG5ld2xpbmUgZnJvbSBgd2hpY2hgIG91dHB1dC5cbiAgICAgIGxldCBjaHJvbWVQYXRoID0gY2hpbGRQcm9jZXNzLmV4ZWNTeW5jKGB3aGljaCBnb29nbGUtY2hyb21lYCkudG9TdHJpbmcoKS50cmltKCk7XG4gICAgICBpZiAoY2hyb21lUGF0aCA9PT0gXCJcIikge1xuICAgICAgICAvLyBUcnkgQ2hyb21pdW1cbiAgICAgICAgY2hyb21lUGF0aCA9IGNoaWxkUHJvY2Vzcy5leGVjU3luYyhgd2hpY2ggY2hyb21pdW1gKS50b1N0cmluZygpLnRyaW0oKTtcbiAgICAgIH1cbiAgICAgIGlmIChjaHJvbWVQYXRoID09PSBcIlwiKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgVW5hYmxlIHRvIGZpbmQgYSBHb29nbGUgQ2hyb21lIG9yIENocm9taXVtIGluc3RhbGxhdGlvbi5gKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHNlc3Npb24uc3Bhd25Ccm93c2VyKFwiZXhhY3RcIiwgT2JqZWN0LmFzc2lnbih7XG4gICAgICAgIGV4ZWN1dGFibGVQYXRoOiBjaHJvbWVQYXRoXG4gICAgICB9LCBiYXNlT3B0aW9ucykpO1xuICAgIH1cbiAgICBjYXNlICd3aW4zMic6IHtcbiAgICAgIC8vIEluc3BpcmVkIGJ5IGthcm1hLWNocm9tZS1sYXVuY2hlclxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2thcm1hLXJ1bm5lci9rYXJtYS1jaHJvbWUtbGF1bmNoZXIvYmxvYi9tYXN0ZXIvaW5kZXguanNcbiAgICAgIGNvbnN0IHN1ZmZpeCA9IGBcXFxcR29vZ2xlXFxcXENocm9tZVxcXFxBcHBsaWNhdGlvblxcXFxjaHJvbWUuZXhlYDtcbiAgICAgIGNvbnN0IHByZWZpeGVzID0gW3Byb2Nlc3MuZW52LkxPQ0FMQVBQREFUQSwgcHJvY2Vzcy5lbnYuUFJPR1JBTUZJTEVTLCBwcm9jZXNzLmVudlsnUFJPR1JBTUZJTEVTKFg4NiknXV07XG4gICAgICBmb3IgKGNvbnN0IHByZWZpeCBvZiBwcmVmaXhlcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBjaHJvbWVMb2NhdGlvbiA9IGpvaW4ocHJlZml4LCBzdWZmaXgpO1xuICAgICAgICAgIGFjY2Vzc1N5bmMoY2hyb21lTG9jYXRpb24pO1xuICAgICAgICAgIHJldHVybiBzZXNzaW9uLnNwYXduQnJvd3NlcihcImV4YWN0XCIsIE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgZXhlY3V0YWJsZVBhdGg6IGNocm9tZUxvY2F0aW9uXG4gICAgICAgICAgfSwgYmFzZU9wdGlvbnMpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICAgIH1cbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgVW5hYmxlIHRvIGZpbmQgYSBDaHJvbWUgaW5zdGFsbGF0aW9uYCk7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICAvLyBFc290ZXJpYyBvcHRpb25zXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYFVuc3VwcG9ydGVkIHBsYXRmb3JtOiAke3BsYXRmb3JtKCl9YCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2hyb21lRHJpdmVyIHtcbiAgcHVibGljIHN0YXRpYyBhc3luYyBMYXVuY2gobG9nOiBMb2csIGhlYWRsZXNzOiBib29sZWFuLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgaW50ZXJjZXB0UGF0aHM6IHN0cmluZ1tdID0gW10sIHF1aWV0OiBib29sZWFuID0gdHJ1ZSk6IFByb21pc2U8Q2hyb21lRHJpdmVyPiB7XG4gICAgY29uc3QgbWl0bVByb3h5ID0gYXdhaXQgTUlUTVByb3h5LkNyZWF0ZSh1bmRlZmluZWQsIGludGVyY2VwdFBhdGhzLCBxdWlldCk7XG4gICAgLy8gVGVsbCBtaXRtUHJveHkgdG8gc3Rhc2ggZGF0YSByZXF1ZXN0ZWQgdGhyb3VnaCB0aGUgcHJveHkuXG4gICAgbWl0bVByb3h5LnN0YXNoRW5hYmxlZCA9IHRydWU7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IG5ldyBQcm9taXNlPENocm9tZVNlc3Npb24+KChyZXMsIHJlaikgPT4gY3JlYXRlU2Vzc2lvbihyZXMpKTtcbiAgICBsZXQgY2hyb21lUHJvY2VzczogQ2hyb21lUHJvY2VzcyA9IGF3YWl0IHNwYXduQ2hyb21lQnJvd3NlcihzZXNzaW9uLCBoZWFkbGVzcywgd2lkdGgsIGhlaWdodCk7XG4gICAgLy8gb3BlbiB0aGUgUkVTVCBBUEkgZm9yIHRhYnNcbiAgICBjb25zdCBjbGllbnQgPSBzZXNzaW9uLmNyZWF0ZUFQSUNsaWVudChcImxvY2FsaG9zdFwiLCBjaHJvbWVQcm9jZXNzLnJlbW90ZURlYnVnZ2luZ1BvcnQpO1xuICAgIGNvbnN0IHRhYnMgPSBhd2FpdCBjbGllbnQubGlzdFRhYnMoKTtcbiAgICBjb25zdCB0YWIgPSB0YWJzWzBdO1xuICAgIGF3YWl0IGNsaWVudC5hY3RpdmF0ZVRhYih0YWIuaWQpO1xuICAgIC8vIG9wZW4gdGhlIGRlYnVnZ2VyIHByb3RvY29sXG4gICAgLy8gaHR0cHM6Ly9jaHJvbWVkZXZ0b29scy5naXRodWIuaW8vZGV2dG9vbHMtcHJvdG9jb2wvXG4gICAgY29uc3QgZGVidWdDbGllbnQgPSBhd2FpdCBzZXNzaW9uLm9wZW5EZWJ1Z2dpbmdQcm90b2NvbCh0YWIud2ViU29ja2V0RGVidWdnZXJVcmwpO1xuXG4gICAgY29uc3QgaGVhcFByb2ZpbGVyID0gbmV3IENocm9tZUhlYXBQcm9maWxlcihkZWJ1Z0NsaWVudCk7XG4gICAgY29uc3QgbmV0d29yayA9IG5ldyBDaHJvbWVOZXR3b3JrKGRlYnVnQ2xpZW50KTtcbiAgICBjb25zdCBjaHJvbWVDb25zb2xlID0gbmV3IENocm9tZUNvbnNvbGUoZGVidWdDbGllbnQpO1xuICAgIGNvbnN0IHBhZ2UgPSBuZXcgQ2hyb21lUGFnZShkZWJ1Z0NsaWVudCk7XG4gICAgY29uc3QgcnVudGltZSA9IG5ldyBDaHJvbWVSdW50aW1lKGRlYnVnQ2xpZW50KTtcbiAgICBjb25zdCBkb20gPSBuZXcgQ2hyb21lRE9NKGRlYnVnQ2xpZW50KTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbaGVhcFByb2ZpbGVyLmVuYWJsZSgpLCBuZXR3b3JrLmVuYWJsZSh7fSksICBjaHJvbWVDb25zb2xlLmVuYWJsZSgpLCBwYWdlLmVuYWJsZSgpLCBydW50aW1lLmVuYWJsZSgpLCBkb20uZW5hYmxlKCldKTtcbiAgICAvLyBJbnRlcmNlcHQgbmV0d29yayByZXF1ZXN0cy5cbiAgICAvLyBhd2FpdCBuZXR3b3JrLnNldFJlcXVlc3RJbnRlcmNlcHRpb25FbmFibGVkKHsgZW5hYmxlZDogdHJ1ZSB9KTtcbiAgICAvLyBEaXNhYmxlIGNhY2hlXG4gICAgYXdhaXQgbmV0d29yay5zZXRDYWNoZURpc2FibGVkKHsgY2FjaGVEaXNhYmxlZDogdHJ1ZSB9KTtcbiAgICAvLyBEaXNhYmxlIHNlcnZpY2Ugd29ya2Vyc1xuICAgIGF3YWl0IG5ldHdvcmsuc2V0QnlwYXNzU2VydmljZVdvcmtlcih7IGJ5cGFzczogdHJ1ZSB9KTtcblxuICAgIGNvbnN0IGRyaXZlciA9IG5ldyBDaHJvbWVEcml2ZXIobG9nLCBoZWFkbGVzcywgd2lkdGgsIGhlaWdodCwgaW50ZXJjZXB0UGF0aHMsIHF1aWV0LCBtaXRtUHJveHksIGNocm9tZVByb2Nlc3MsIHBhZ2UsIHJ1bnRpbWUsIGhlYXBQcm9maWxlciwgY2hyb21lQ29uc29sZSk7XG5cbiAgICByZXR1cm4gZHJpdmVyO1xuICB9XG5cbiAgcHJpdmF0ZSBfbG9nOiBMb2c7XG4gIHByaXZhdGUgX2hlYWRsZXNzOiBib29sZWFuO1xuICBwdWJsaWMgcmVhZG9ubHkgbWl0bVByb3h5OiBNSVRNUHJveHk7XG4gIHByaXZhdGUgX3Byb2Nlc3M6IENocm9tZVByb2Nlc3M7XG4gIHByaXZhdGUgX3BhZ2U6IENocm9tZVBhZ2U7XG4gIHByaXZhdGUgX3J1bnRpbWU6IENocm9tZVJ1bnRpbWU7XG4gIHByaXZhdGUgX2hlYXBQcm9maWxlcjogQ2hyb21lSGVhcFByb2ZpbGVyO1xuICBwcml2YXRlIF9jb25zb2xlOiBDaHJvbWVDb25zb2xlO1xuICBwcml2YXRlIF9sb2FkZWRGcmFtZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBfc2h1dGRvd246IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfd2lkdGg6IG51bWJlcjtcbiAgcHJpdmF0ZSBfaGVpZ2h0OiBudW1iZXI7XG4gIHByaXZhdGUgX2ludGVyY2VwdFBhdGhzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSBfcXVpZXQ6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihsb2c6IExvZywgaGVhZGxlc3M6IGJvb2xlYW4sIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBpbnRlcmNlcHRQYXRoczogc3RyaW5nW10sIHF1aWV0OiBib29sZWFuLCBtaXRtUHJveHk6IE1JVE1Qcm94eSwgcHJvY2VzczogQ2hyb21lUHJvY2VzcywgcGFnZTogQ2hyb21lUGFnZSwgcnVudGltZTogQ2hyb21lUnVudGltZSwgaGVhcFByb2ZpbGVyOiBDaHJvbWVIZWFwUHJvZmlsZXIsIGNvbnNvbGU6IENocm9tZUNvbnNvbGUpIHtcbiAgICB0aGlzLl9sb2cgPSBsb2c7XG4gICAgdGhpcy5faGVhZGxlc3MgPSBoZWFkbGVzcztcbiAgICB0aGlzLm1pdG1Qcm94eSA9IG1pdG1Qcm94eTtcbiAgICB0aGlzLl9wcm9jZXNzID0gcHJvY2VzcztcbiAgICB0aGlzLl9ydW50aW1lID0gcnVudGltZTtcbiAgICB0aGlzLl9wYWdlID0gcGFnZTtcbiAgICB0aGlzLl9oZWFwUHJvZmlsZXIgPSBoZWFwUHJvZmlsZXI7XG4gICAgdGhpcy5fY29uc29sZSA9IGNvbnNvbGU7XG4gICAgdGhpcy5fd2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQ7XG4gICAgdGhpcy5faW50ZXJjZXB0UGF0aHMgPSBpbnRlcmNlcHRQYXRocztcbiAgICB0aGlzLl9xdWlldCA9IHF1aWV0O1xuXG4gICAgdGhpcy5fY29uc29sZS5tZXNzYWdlQWRkZWQgPSAoZXZ0KSA9PiB7XG4gICAgICBjb25zdCBtID0gZXZ0Lm1lc3NhZ2U7XG4gICAgICBsb2cuZGVidWcoYFske20ubGV2ZWx9XSBbJHttLnNvdXJjZX1dICR7bS51cmx9OiR7bS5saW5lfToke20uY29sdW1ufSAke20udGV4dH1gKTtcbiAgICB9O1xuXG4gICAgdGhpcy5fcnVudGltZS5leGNlcHRpb25UaHJvd24gPSAoZXZ0KSA9PiB7XG4gICAgICBjb25zdCBlID0gZXZ0LmV4Y2VwdGlvbkRldGFpbHM7XG4gICAgICBsb2cuZXJyb3IoZXhjZXB0aW9uRGV0YWlsc1RvU3RyaW5nKGUpKTtcbiAgICB9O1xuXG4gICAgdGhpcy5fcGFnZS5mcmFtZVN0b3BwZWRMb2FkaW5nID0gKGUpID0+IHtcbiAgICAgIHRoaXMuX2xvYWRlZEZyYW1lcy5hZGQoZS5mcmFtZUlkKTtcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRha2VTY3JlZW5zaG90KCk6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgY29uc3Qgc3MgPSBhd2FpdCB0aGlzLl9wYWdlLmNhcHR1cmVTY3JlZW5zaG90KHt9KTtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oc3MuZGF0YSwgJ2Jhc2U2NCcpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbGF1bmNoKCk6IFByb21pc2U8Q2hyb21lRHJpdmVyPiB7XG4gICAgYXdhaXQgdGhpcy5zaHV0ZG93bigpO1xuICAgIGNvbnN0IGRyaXZlciA9IGF3YWl0IENocm9tZURyaXZlci5MYXVuY2godGhpcy5fbG9nLCB0aGlzLl9oZWFkbGVzcywgdGhpcy5fd2lkdGgsIHRoaXMuX2hlaWdodCwgdGhpcy5faW50ZXJjZXB0UGF0aHMsIHRoaXMuX3F1aWV0KTtcbiAgICBkcml2ZXIubWl0bVByb3h5LmNiID0gdGhpcy5taXRtUHJveHkuY2I7XG4gICAgcmV0dXJuIGRyaXZlcjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBuYXZpZ2F0ZVRvKHVybDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0aGlzLl9sb2FkZWRGcmFtZXMuY2xlYXIoKTtcbiAgICBjb25zdCBmID0gYXdhaXQgdGhpcy5fcGFnZS5uYXZpZ2F0ZSh7IHVybCB9KTtcbiAgICB3aGlsZSAoIXRoaXMuX2xvYWRlZEZyYW1lcy5oYXMoZi5mcmFtZUlkKSkge1xuICAgICAgaWYgKHRoaXMuX3NodXRkb3duKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgQ2Fubm90IG5hdmlnYXRlIHRvIFVSTDsgQ2hyb21lIGhhcyBzaHV0IGRvd24uYCk7XG4gICAgICB9XG4gICAgICBhd2FpdCB3YWl0KDUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW5Db2RlPFQ+KGV4cHJlc3Npb246IHN0cmluZyk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IGUgPSBhd2FpdCB0aGlzLl9ydW50aW1lLmV2YWx1YXRlKHsgZXhwcmVzc2lvbiwgcmV0dXJuQnlWYWx1ZTogdHJ1ZSB9KTtcbiAgICB0aGlzLl9sb2cuZGVidWcoYCR7ZXhwcmVzc2lvbn0gPT4gJHtKU09OLnN0cmluZ2lmeShlLnJlc3VsdC52YWx1ZSl9YCk7XG4gICAgaWYgKGUuZXhjZXB0aW9uRGV0YWlscykge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGV4Y2VwdGlvbkRldGFpbHNUb1N0cmluZyhlLmV4Y2VwdGlvbkRldGFpbHMpKTtcbiAgICB9XG4gICAgcmV0dXJuIGUucmVzdWx0LnZhbHVlO1xuICB9XG4gIHB1YmxpYyB0YWtlSGVhcFNuYXBzaG90KCk6IEhlYXBTbmFwc2hvdFBhcnNlciB7XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IEhlYXBTbmFwc2hvdFBhcnNlcigpO1xuICAgIC8vIDIwMCBLQiBjaHVua3NcbiAgICB0aGlzLl9oZWFwUHJvZmlsZXIuYWRkSGVhcFNuYXBzaG90Q2h1bmsgPSAoZXZ0KSA9PiB7XG4gICAgICBwYXJzZXIuYWRkU25hcHNob3RDaHVuayhldnQuY2h1bmspO1xuICAgIH07XG4gICAgLy8gQWx3YXlzIHRha2UgYSBET00gc25hcHNob3QgYmVmb3JlIHRha2luZyBhIHJlYWwgc25hcHNob3QuXG4gICAgdGhpcy5fdGFrZURPTVNuYXBzaG90KCkudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLl9oZWFwUHJvZmlsZXIudGFrZUhlYXBTbmFwc2hvdCh7IHJlcG9ydFByb2dyZXNzOiBmYWxzZSB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcGFyc2VyO1xuICB9XG4gIHByaXZhdGUgYXN5bmMgX3Rha2VET01TbmFwc2hvdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX3J1bnRpbWUuZXZhbHVhdGUoe1xuICAgICAgZXhwcmVzc2lvbjogXCIkJCRTRVJJQUxJWkVfRE9NJCQkKClcIiwgcmV0dXJuQnlWYWx1ZTogdHJ1ZVxuICAgIH0pO1xuICAgIHJldHVybiByZXNwb25zZS5yZXN1bHQudmFsdWU7XG4gIH1cbiAgcHVibGljIGFzeW5jIGRlYnVnTG9vcCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBldmFsSmF2YXNjcmlwdCA9IChjbWQ6IHN0cmluZywgY29udGV4dDogYW55LCBmaWxlbmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGU6IGFueSwgcmVzdWx0Pzogc3RyaW5nKSA9PiB2b2lkKTogdm9pZCA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBwYXJzZUphdmFTY3JpcHQoY21kKTtcbiAgICAgICAgdGhpcy5ydW5Db2RlKGNtZCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgYCR7cmVzdWx0fWApO1xuICAgICAgICB9KS5jYXRjaChjYWxsYmFjayk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyAoPGFueT5yZXBsKS5SZWNvdmVyYWJsZShlKSk7XG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgciA9IHJlcGwuc3RhcnQoeyBwcm9tcHQ6IFwiPiBcIiwgZXZhbDogZXZhbEphdmFzY3JpcHQgfSk7XG4gICAgICByLm9uKCdleGl0JywgcmVzb2x2ZSk7XG4gICAgfSk7XG4gIH1cbiAgcHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuX3NodXRkb3duID0gdHJ1ZTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbdGhpcy5fcHJvY2Vzcy5kaXNwb3NlKCksIHRoaXMubWl0bVByb3h5LnNodXRkb3duKCldKTtcbiAgfVxufVxuIl19