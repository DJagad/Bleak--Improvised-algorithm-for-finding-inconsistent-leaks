"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const transformations_1 = require("./transformations");
const fs_1 = require("fs");
function identJSTransform(f, s) {
    return s;
}
function defaultRewrite(url, type, data) {
    return data;
}
exports.DEFAULT_AGENT_PATH = require.resolve('../lib/bleak_agent');
exports.DEFAULT_AGENT_URL = `/bleak_agent.js`;
exports.DEFAULT_AGENT_TRANSFORM_PATH = require.resolve('../lib/bleak_agent_transform');
exports.DEFAULT_AGENT_TRANSFORM_URL = `/bleak_agent_transform.js`;
exports.DEFAULT_BABEL_POLYFILL_URL = `/bleak_polyfill.js`;
exports.DEFAULT_BABEL_POLYFILL_PATH = require.resolve('babel-polyfill/dist/polyfill');
const DEFAULT_VALUES = {
    agentPath: exports.DEFAULT_AGENT_PATH,
    agentUrl: exports.DEFAULT_AGENT_URL,
    polyfillUrl: exports.DEFAULT_BABEL_POLYFILL_URL,
    polyfillPath: exports.DEFAULT_BABEL_POLYFILL_PATH,
    config: "",
    fixes: new Array(),
    disableAllRewrites: false,
    fixRewriteFunction: defaultRewrite
};
/**
 * Retrieve a standard BLeak interceptor.
 */
function getInterceptor(config) {
    config = Object.assign({}, DEFAULT_VALUES, config);
    const agentTransformURL = exports.DEFAULT_AGENT_TRANSFORM_URL;
    const agentTransformPath = exports.DEFAULT_AGENT_TRANSFORM_PATH;
    const parsedInjection = transformations_1.parseHTML(`<script type="text/javascript" src="${config.agentUrl}"></script>
  <script type="text/javascript" src="${agentTransformURL}"></script>
    <script type="text/javascript">
      ${JSON.stringify(config.fixes)}.forEach(function(num) {
        $$$SHOULDFIX$$$(num, true);
      });
      ${config.config}
    </script>
    ${config.disableAllRewrites ? '' : `<script type="text/javascript" src="${config.polyfillUrl}"></script>
    <script type="text/javascript">
      // Babel defines a 'global' variable that trips up some applications' environment detection.
      if (typeof(global) !== "undefined") { delete window['global']; }
    </script>`}`);
    const agentData = fs_1.readFileSync(config.agentPath);
    const agentTransformData = fs_1.readFileSync(agentTransformPath);
    const polyfillData = fs_1.readFileSync(config.polyfillPath);
    return (f) => {
        const response = f.response;
        const request = f.request;
        const method = f.request.method;
        const url = request.url;
        // Filter out non 'GET' requests
        if (method !== 'get') {
            if (method === 'post' && url.path === "/eval") {
                // Special eval handler!
                response.statusCode = 200;
                response.clearHeaders();
                const body = JSON.parse(f.requestBody.toString());
                if (config.rewrite) {
                    f.setResponseBody(Buffer.from(transformations_1.exposeClosureState(`eval-${Math.random()}.js`, body.source, config.agentUrl, config.polyfillUrl, body.scope), 'utf8'));
                }
                else if (!config.disableAllRewrites) {
                    f.setResponseBody(Buffer.from(transformations_1.ensureES5(`eval-${Math.random()}.js`, body.source, config.agentUrl, config.polyfillUrl, body.scope), 'utf8'));
                }
                else {
                    f.setResponseBody(Buffer.from(body.source, 'utf8'));
                }
                response.setHeader('content-type', 'text/javascript');
            }
            return;
        }
        // GET requests
        let mime = response.getHeader('content-type');
        if (mime.indexOf(";") !== -1) {
            mime = mime.slice(0, mime.indexOf(";"));
        }
        // console.log(`[${response.statusCode}] ${request.rawUrl}: ${mime}`);
        // NOTE: Use `pathname`, as it cuts out query variables that may have been tacked on.
        switch (url.pathname.toLowerCase()) {
            case config.agentUrl:
                response.statusCode = 200;
                response.clearHeaders();
                f.setResponseBody(agentData);
                response.setHeader('content-type', 'text/javascript');
                return;
            case agentTransformURL:
                response.statusCode = 200;
                response.clearHeaders();
                if (config.rewrite) {
                    f.setResponseBody(Buffer.from(transformations_1.exposeClosureState(url.pathname, agentTransformData.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                }
                else {
                    f.setResponseBody(agentTransformData);
                }
                response.setHeader('content-type', 'text/javascript');
                return;
            case config.polyfillUrl:
                response.statusCode = 200;
                response.clearHeaders();
                f.setResponseBody(polyfillData);
                response.setHeader('content-type', 'text/javascript');
                return;
        }
        if (response.statusCode === 200) {
            // Rewrite before anything else happens.
            f.setResponseBody(config.fixRewriteFunction(request.rawUrl, mime, f.responseBody, config.fixes));
        }
        switch (mime) {
            case 'text/html':
                //if (f.status === 200) {
                f.setResponseBody(Buffer.from(transformations_1.injectIntoHead(url.pathname, f.responseBody.toString("utf8"), parsedInjection, config.rewrite ? transformations_1.exposeClosureState : identJSTransform), 'utf8'));
                //}
                break;
            case 'text/javascript':
            case 'application/javascript':
            case 'text/x-javascript':
            case 'application/x-javascript':
                if (response.statusCode === 200) {
                    if (config.rewrite) {
                        config.log.debug(`Rewriting ${request.rawUrl}...`);
                        f.setResponseBody(Buffer.from(transformations_1.exposeClosureState(url.pathname, f.responseBody.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                    }
                    else if (!config.disableAllRewrites) {
                        config.log.debug(`ES5ing ${request.rawUrl}...`);
                        f.setResponseBody(Buffer.from(transformations_1.ensureES5(url.pathname, f.responseBody.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                    }
                }
                break;
        }
    };
}
exports.default = getInterceptor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWl0bXByb3h5X2ludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9taXRtcHJveHlfaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1REFBMkY7QUFDM0YsMkJBQWdDO0FBSWhDLDBCQUEwQixDQUFTLEVBQUUsQ0FBUztJQUM1QyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVELHdCQUF3QixHQUFXLEVBQUUsSUFBWSxFQUFFLElBQVk7SUFDN0QsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNkLENBQUM7QUFFWSxRQUFBLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUMzRCxRQUFBLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0FBQ3RDLFFBQUEsNEJBQTRCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQy9FLFFBQUEsMkJBQTJCLEdBQUcsMkJBQTJCLENBQUM7QUFDMUQsUUFBQSwwQkFBMEIsR0FBRyxvQkFBb0IsQ0FBQztBQUNsRCxRQUFBLDJCQUEyQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQWUzRixNQUFNLGNBQWMsR0FBRztJQUNyQixTQUFTLEVBQUUsMEJBQWtCO0lBQzdCLFFBQVEsRUFBRSx5QkFBaUI7SUFDM0IsV0FBVyxFQUFFLGtDQUEwQjtJQUN2QyxZQUFZLEVBQUUsbUNBQTJCO0lBQ3pDLE1BQU0sRUFBRSxFQUFFO0lBQ1YsS0FBSyxFQUFFLElBQUksS0FBSyxFQUFVO0lBQzFCLGtCQUFrQixFQUFFLEtBQUs7SUFDekIsa0JBQWtCLEVBQUUsY0FBYztDQUNuQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCx3QkFBdUMsTUFBeUI7SUFDOUQsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGNBQWMsRUFBRSxN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ekIsS0FBSywwQkFBMEI7Z0JBQzdCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDaEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7d0JBQ25CLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7d0JBQ25ELENBQUMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBa0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ2pKLENBQUM7b0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQzt3QkFDdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQTt3QkFDL0MsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLDJCQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUN4SSxDQUFDO2dCQUNILENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1FBQ1YsQ0FBQztJQUNILENBQUMsQ0FBQztBQUNKLENBQUM7QUF2R0QsaUNBdUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtwYXJzZUhUTUwsIGV4cG9zZUNsb3N1cmVTdGF0ZSwgaW5qZWN0SW50b0hlYWQsIGVuc3VyZUVTNX0gZnJvbSAnLi90cmFuc2Zvcm1hdGlvbnMnO1xuaW1wb3J0IHtyZWFkRmlsZVN5bmN9IGZyb20gJ2ZzJztcbmltcG9ydCB7SW50ZXJjZXB0b3IsIEludGVyY2VwdGVkSFRUUE1lc3NhZ2V9IGZyb20gJ21pdG1wcm94eSc7XG5pbXBvcnQge0xvZ30gZnJvbSAnLi4vY29tbW9uL2ludGVyZmFjZXMnO1xuXG5mdW5jdGlvbiBpZGVudEpTVHJhbnNmb3JtKGY6IHN0cmluZywgczogc3RyaW5nKSB7XG4gIHJldHVybiBzO1xufVxuXG5mdW5jdGlvbiBkZWZhdWx0UmV3cml0ZSh1cmw6IHN0cmluZywgdHlwZTogc3RyaW5nLCBkYXRhOiBCdWZmZXIpOiBCdWZmZXIge1xuICByZXR1cm4gZGF0YTtcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQUdFTlRfUEFUSCA9IHJlcXVpcmUucmVzb2x2ZSgnLi4vbGliL2JsZWFrX2FnZW50Jyk7XG5leHBvcnQgY29uc3QgREVGQVVMVF9BR0VOVF9VUkwgPSBgL2JsZWFrX2FnZW50LmpzYDtcbmV4cG9ydCBjb25zdCBERUZBVUxUX0FHRU5UX1RSQU5TRk9STV9QQVRIID0gcmVxdWlyZS5yZXNvbHZlKCcuLi9saWIvYmxlYWtfYWdlbnRfdHJhbnNmb3JtJyk7XG5leHBvcnQgY29uc3QgREVGQVVMVF9BR0VOVF9UUkFOU0ZPUk1fVVJMID0gYC9ibGVha19hZ2VudF90cmFuc2Zvcm0uanNgO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQkFCRUxfUE9MWUZJTExfVVJMID0gYC9ibGVha19wb2x5ZmlsbC5qc2A7XG5leHBvcnQgY29uc3QgREVGQVVMVF9CQUJFTF9QT0xZRklMTF9QQVRIID0gcmVxdWlyZS5yZXNvbHZlKCdiYWJlbC1wb2x5ZmlsbC9kaXN0L3BvbHlmaWxsJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW50ZXJjZXB0b3JDb25maWcge1xuICBsb2c6IExvZztcbiAgcmV3cml0ZTogYm9vbGVhbjtcbiAgYWdlbnRVcmw/OiBzdHJpbmc7XG4gIGFnZW50UGF0aD86IHN0cmluZztcbiAgcG9seWZpbGxVcmw/OiBzdHJpbmc7XG4gIHBvbHlmaWxsUGF0aD86IHN0cmluZztcbiAgY29uZmlnOiBzdHJpbmc7XG4gIGZpeGVzPzogbnVtYmVyW107XG4gIGRpc2FibGVBbGxSZXdyaXRlcz86IGJvb2xlYW47XG4gIGZpeFJld3JpdGVGdW5jdGlvbih1cmw6IHN0cmluZywgdHlwZTogc3RyaW5nLCBkYXRhOiBCdWZmZXIsIGZpeGVzOiBudW1iZXJbXSk6IEJ1ZmZlcjtcbn1cblxuY29uc3QgREVGQVVMVF9WQUxVRVMgPSB7XG4gIGFnZW50UGF0aDogREVGQVVMVF9BR0VOVF9QQVRILFxuICBhZ2VudFVybDogREVGQVVMVF9BR0VOVF9VUkwsXG4gIHBvbHlmaWxsVXJsOiBERUZBVUxUX0JBQkVMX1BPTFlGSUxMX1VSTCxcbiAgcG9seWZpbGxQYXRoOiBERUZBVUxUX0JBQkVMX1BPTFlGSUxMX1BBVEgsXG4gIGNvbmZpZzogXCJcIixcbiAgZml4ZXM6IG5ldyBBcnJheTxudW1iZXI+KCksXG4gIGRpc2FibGVBbGxSZXdyaXRlczogZmFsc2UsXG4gIGZpeFJld3JpdGVGdW5jdGlvbjogZGVmYXVsdFJld3JpdGVcbn07XG5cbi8qKlxuICogUmV0cmlldmUgYSBzdGFuZGFyZCBCTGVhayBpbnRlcmNlcHRvci5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ2V0SW50ZXJjZXB0b3IoY29uZmlnOiBJbnRlcmNlcHRvckNvbmZpZyk6IEludGVyY2VwdG9yIHtcbiAgY29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9WQUxVRVMsIGNvbmZpZyk7XG4gIGNvbnN0IGFnZW50VHJhbnNmb3JtVVJMID0gREVGQVVMVF9BR0VOVF9UUkFOU0ZPUk1fVVJMO1xuICBjb25zdCBhZ2VudFRyYW5zZm9ybVBhdGggPSBERUZBVUxUX0FHRU5UX1RSQU5TRk9STV9QQVRIO1xuICBjb25zdCBwYXJzZWRJbmplY3Rpb24gPSBwYXJzZUhUTUwoYDxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cIiR7Y29uZmlnLmFnZW50VXJsfVwiPjwvc2NyaXB0PlxuICA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke2FnZW50VHJhbnNmb3JtVVJMfVwiPjwvc2NyaXB0PlxuICAgIDxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiPlxuICAgICAgJHtKU09OLnN0cmluZ2lmeShjb25maWcuZml4ZXMpfS5mb3JFYWNoKGZ1bmN0aW9uKG51bSkge1xuICAgICAgICAkJCRTSE9VTERGSVgkJCQobnVtLCB0cnVlKTtcbiAgICAgIH0pO1xuICAgICAgJHtjb25maWcuY29uZmlnfVxuICAgIDwvc2NyaXB0PlxuICAgICR7Y29uZmlnLmRpc2FibGVBbGxSZXdyaXRlcyA/ICcnIDogYDxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cIiR7Y29uZmlnLnBvbHlmaWxsVXJsfVwiPjwvc2NyaXB0PlxuICAgIDxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiPlxuICAgICAgLy8gQmFiZWwgZGVmaW5lcyBhICdnbG9iYWwnIHZhcmlhYmxlIHRoYXQgdHJpcHMgdXAgc29tZSBhcHBsaWNhdGlvbnMnIGVudmlyb25tZW50IGRldGVjdGlvbi5cbiAgICAgIGlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gXCJ1bmRlZmluZWRcIikgeyBkZWxldGUgd2luZG93WydnbG9iYWwnXTsgfVxuICAgIDwvc2NyaXB0PmB9YCk7XG4gIGNvbnN0IGFnZW50RGF0YSA9IHJlYWRGaWxlU3luYyhjb25maWcuYWdlbnRQYXRoKTtcbiAgY29uc3QgYWdlbnRUcmFuc2Zvcm1EYXRhID0gcmVhZEZpbGVTeW5jKGFnZW50VHJhbnNmb3JtUGF0aCk7XG4gIGNvbnN0IHBvbHlmaWxsRGF0YSA9IHJlYWRGaWxlU3luYyhjb25maWcucG9seWZpbGxQYXRoKTtcbiAgcmV0dXJuIChmOiBJbnRlcmNlcHRlZEhUVFBNZXNzYWdlKTogdm9pZCA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBmLnJlc3BvbnNlO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBmLnJlcXVlc3Q7XG4gICAgY29uc3QgbWV0aG9kID0gZi5yZXF1ZXN0Lm1ldGhvZDtcbiAgICBjb25zdCB1cmwgPSByZXF1ZXN0LnVybDtcbiAgICAvLyBGaWx0ZXIgb3V0IG5vbiAnR0VUJyByZXF1ZXN0c1xuICAgIGlmIChtZXRob2QgIT09ICdnZXQnKSB7XG4gICAgICBpZiAobWV0aG9kID09PSAncG9zdCcgJiYgdXJsLnBhdGggPT09IFwiL2V2YWxcIikge1xuICAgICAgICAvLyBTcGVjaWFsIGV2YWwgaGFuZGxlciFcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcbiAgICAgICAgcmVzcG9uc2UuY2xlYXJIZWFkZXJzKCk7XG4gICAgICAgIGNvbnN0IGJvZHk6IHsgc2NvcGU6IHN0cmluZywgc291cmNlOiBzdHJpbmcgfSA9IEpTT04ucGFyc2UoZi5yZXF1ZXN0Qm9keS50b1N0cmluZygpKTtcbiAgICAgICAgaWYgKGNvbmZpZy5yZXdyaXRlKSB7XG4gICAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoQnVmZmVyLmZyb20oZXhwb3NlQ2xvc3VyZVN0YXRlKGBldmFsLSR7TWF0aC5yYW5kb20oKX0uanNgLCBib2R5LnNvdXJjZSwgY29uZmlnLmFnZW50VXJsLCBjb25maWcucG9seWZpbGxVcmwsIGJvZHkuc2NvcGUpLCAndXRmOCcpKTtcbiAgICAgICAgfSBlbHNlIGlmICghY29uZmlnLmRpc2FibGVBbGxSZXdyaXRlcykge1xuICAgICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KEJ1ZmZlci5mcm9tKGVuc3VyZUVTNShgZXZhbC0ke01hdGgucmFuZG9tKCl9LmpzYCwgYm9keS5zb3VyY2UsIGNvbmZpZy5hZ2VudFVybCwgY29uZmlnLnBvbHlmaWxsVXJsLCBib2R5LnNjb3BlKSwgJ3V0ZjgnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoQnVmZmVyLmZyb20oYm9keS5zb3VyY2UsICd1dGY4JykpO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEdFVCByZXF1ZXN0c1xuICAgIGxldCBtaW1lID0gcmVzcG9uc2UuZ2V0SGVhZGVyKCdjb250ZW50LXR5cGUnKTtcbiAgICBpZiAobWltZS5pbmRleE9mKFwiO1wiKSAhPT0gLTEpIHtcbiAgICAgIG1pbWUgPSBtaW1lLnNsaWNlKDAsIG1pbWUuaW5kZXhPZihcIjtcIikpO1xuICAgIH1cbiAgICAvLyBjb25zb2xlLmxvZyhgWyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX1dICR7cmVxdWVzdC5yYXdVcmx9OiAke21pbWV9YCk7XG4gICAgLy8gTk9URTogVXNlIGBwYXRobmFtZWAsIGFzIGl0IGN1dHMgb3V0IHF1ZXJ5IHZhcmlhYmxlcyB0aGF0IG1heSBoYXZlIGJlZW4gdGFja2VkIG9uLlxuICAgIHN3aXRjaCAodXJsLnBhdGhuYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIGNhc2UgY29uZmlnLmFnZW50VXJsOlxuICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gMjAwO1xuICAgICAgICByZXNwb25zZS5jbGVhckhlYWRlcnMoKTtcbiAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoYWdlbnREYXRhKTtcbiAgICAgICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgYWdlbnRUcmFuc2Zvcm1VUkw6XG4gICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XG4gICAgICAgIHJlc3BvbnNlLmNsZWFySGVhZGVycygpO1xuICAgICAgICBpZiAoY29uZmlnLnJld3JpdGUpIHtcbiAgICAgICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShleHBvc2VDbG9zdXJlU3RhdGUodXJsLnBhdGhuYW1lLCBhZ2VudFRyYW5zZm9ybURhdGEudG9TdHJpbmcoXCJ1dGY4XCIpLCBjb25maWcuYWdlbnRVcmwsIGNvbmZpZy5wb2x5ZmlsbFVybCksICd1dGY4JykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KGFnZW50VHJhbnNmb3JtRGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgY29uZmlnLnBvbHlmaWxsVXJsOlxuICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gMjAwO1xuICAgICAgICByZXNwb25zZS5jbGVhckhlYWRlcnMoKTtcbiAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkocG9seWZpbGxEYXRhKTtcbiAgICAgICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBSZXdyaXRlIGJlZm9yZSBhbnl0aGluZyBlbHNlIGhhcHBlbnMuXG4gICAgICBmLnNldFJlc3BvbnNlQm9keShjb25maWcuZml4UmV3cml0ZUZ1bmN0aW9uKHJlcXVlc3QucmF3VXJsLCBtaW1lLCBmLnJlc3BvbnNlQm9keSwgY29uZmlnLmZpeGVzKSk7XG4gICAgfVxuXG4gICAgc3dpdGNoIChtaW1lKSB7XG4gICAgICBjYXNlICd0ZXh0L2h0bWwnOlxuICAgICAgLy9pZiAoZi5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShpbmplY3RJbnRvSGVhZCh1cmwucGF0aG5hbWUsIGYucmVzcG9uc2VCb2R5LnRvU3RyaW5nKFwidXRmOFwiKSwgcGFyc2VkSW5qZWN0aW9uLCBjb25maWcucmV3cml0ZSA/IGV4cG9zZUNsb3N1cmVTdGF0ZSA6IGlkZW50SlNUcmFuc2Zvcm0pLCAndXRmOCcpKTtcbiAgICAgICAgLy99XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndGV4dC9qYXZhc2NyaXB0JzpcbiAgICAgIGNhc2UgJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnOlxuICAgICAgY2FzZSAndGV4dC94LWphdmFzY3JpcHQnOlxuICAgICAgY2FzZSAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JzpcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIGlmIChjb25maWcucmV3cml0ZSkge1xuICAgICAgICAgICAgY29uZmlnLmxvZy5kZWJ1ZyhgUmV3cml0aW5nICR7cmVxdWVzdC5yYXdVcmx9Li4uYCk7XG4gICAgICAgICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShleHBvc2VDbG9zdXJlU3RhdGUodXJsLnBhdGhuYW1lLCBmLnJlc3BvbnNlQm9keS50b1N0cmluZyhcInV0ZjhcIiksIGNvbmZpZy5hZ2VudFVybCwgY29uZmlnLnBvbHlmaWxsVXJsKSwgJ3V0ZjgnKSk7XG4gICAgICAgICAgfSBlbHNlIGlmICghY29uZmlnLmRpc2FibGVBbGxSZXdyaXRlcykge1xuICAgICAgICAgICAgY29uZmlnLmxvZy5kZWJ1ZyhgRVM1aW5nICR7cmVxdWVzdC5yYXdVcmx9Li4uYClcbiAgICAgICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KEJ1ZmZlci5mcm9tKGVuc3VyZUVTNSh1cmwucGF0aG5hbWUsIGYucmVzcG9uc2VCb2R5LnRvU3RyaW5nKFwidXRmOFwiKSwgY29uZmlnLmFnZW50VXJsLCBjb25maWcucG9seWZpbGxVcmwpLCAndXRmOCcpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9O1xufVxuIl19