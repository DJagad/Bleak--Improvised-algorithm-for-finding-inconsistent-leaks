"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const r = /'/g;
/**
 * Escapes single quotes in the given string.
 * @param s
 */
function safeString(s) {
    return s.replace(r, "\\'");
}
// From https://stackoverflow.com/a/2008444
// This is not *perfect*, but it's good enough for human output.
const JS_IDENTIFIER_REGEXP = /^[_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*$/;
/**
 * Returns true if the property definitely requires array notation.
 * This check is not sound, as we do not check for JavaScript reserved
 * words. However, it is 'good enough' for human output, e.g. in a report.
 * @param prop
 */
function propertyNeedsArrayNotation(prop) {
    return !JS_IDENTIFIER_REGEXP.test(`${prop}`);
}
function propertyAccessString(s) {
    if (typeof (s) === "number") {
        return `[${s}]`;
    }
    else if (propertyNeedsArrayNotation(s)) {
        return `["${safeString(s)}"]`;
    }
    else {
        return `.${s}`;
    }
}
function prettyPrintDOMPath() {
    while (PS.nonempty()) {
        const segment = PS.pop();
        const name = segment.indexOrName;
        if (name === "root") {
            // Ignore this BLeak-inserted edge.
            // We're transitioning to a path outside of the DOM, on the DOM object itself.
            prettyPrintNonDOMPath();
        }
        else if (name === 'childNodes') {
            PS.print(propertyAccessString(name));
        }
        else {
            // $$$CHILD$$$n => n
            const idx = parseInt(name.slice(11), 10);
            // Should alternate between 'childNode' and indices until it gets to 'root'.
            PS.print(propertyAccessString(idx));
        }
    }
}
function prettyPrintNonDOMPath() {
    while (PS.nonempty()) {
        const segment = PS.pop();
        switch (segment.type) {
            case 5 /* EVENT_LISTENER_LIST */: {
                // Will either be:
                // - A leak on the list itself.
                // - A leak *within* an event listener.
                // Seek forward to figure out which, and print appropriately
                // $$listeners.type[index].listener
                const typeSegment = PS.pop();
                if (!PS.nonempty()) {
                    // List leak
                    PS.pushString();
                    PS.print(`List of '${typeSegment.indexOrName}' listeners on`);
                    PS.pushString();
                }
                else {
                    const indexSegment = PS.pop();
                    PS.pop(); // Should be the '.listener' property, unless the application mucked with our metadata.
                    PS.pushString();
                    PS.print(`on listener ${indexSegment.indexOrName} in the list of '${typeSegment.indexOrName}' listeners on`);
                    PS.pushString();
                }
                break;
            }
            case 3 /* CLOSURE */:
                PS.pushString();
                PS.print("within closure of");
                PS.pushString();
                break;
            case 4 /* CLOSURE_VARIABLE */:
                // Should've been preceded by CLOSURE.
                // Begins a new path in the string.
                PS.print(segment.indexOrName);
                break;
            default: {
                let indexOrName = segment.indexOrName;
                if (typeof (indexOrName) === "string" && indexOrName.startsWith("$$$on")) {
                    // Cut off the $$$. This is a mirrored event listener property.
                    indexOrName = indexOrName.slice(3);
                }
                // *Must* be a property on the previously-printed object.
                PS.print(propertyAccessString(indexOrName));
                break;
            }
        }
    }
}
class PathStream {
    constructor() {
        this._p = null;
        this._i = -1;
        this._s = null;
        this._ss = null;
    }
    print(s) {
        if (this._s !== null) {
            this._s += s;
        }
    }
    pushString() {
        if (this._ss !== null) {
            this._ss.push(this._s);
            this._s = "";
        }
    }
    flush() {
        const s = this._s;
        const ss = this._ss;
        this._ss = this._s = null;
        ss.push(s);
        return ss.filter((s) => s !== "").reverse().join(" ");
    }
    setPath(p) {
        this._p = p;
        this._i = 0;
        this._s = "";
        this._ss = [];
    }
    advance() {
        this._i++;
    }
    peek() {
        if (this.nonempty()) {
            return this._p[this._i];
        }
        else {
            return null;
        }
    }
    pop() {
        const rv = this.peek();
        this.advance();
        return rv;
    }
    nonempty() {
        return this._p && this._p.length > this._i;
    }
}
// Singleton class.
const PS = new PathStream();
/**
 * Pretty print a path as a human-friendly string.
 * @param p
 */
function pathToString(p) {
    PS.setPath(p);
    const segment = PS.peek();
    if (segment.type === 6 /* DOM_TREE */) {
        PS.print("document");
        PS.advance();
        prettyPrintDOMPath();
    }
    else {
        PS.print("window");
        prettyPrintNonDOMPath();
    }
    return PS.flush();
}
exports.default = pathToString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aF90b19zdHJpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL3BhdGhfdG9fc3RyaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQ2Y7OztHQUdHO0FBQ0gsb0JBQW9CLENBQVM7SUFDM0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFFRCwyQ0FBMkM7QUFDM0MsZ0VBQWdFO0FBQ2hFLE1BQU0sb0JBQW9CLEdBQUcsa0RBQWtELENBQUM7QUFDaEY7Ozs7O0dBS0c7QUFDSCxvQ0FBb0MsSUFBcUI7SUFDdkQsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUMvQyxDQUFDO0FBRUQsOEJBQThCLENBQWtCO0lBQzlDLEVBQUUsQ0FBQyxDQUFDLE9BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ2xCLENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ2hDLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQ2pCLENBQUM7QUFDSCxDQUFDO0FBRUQ7SUFDRSxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO1FBQ3JCLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN6QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsV0FBVyxD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SUFDdkIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQixxQkFBcUIsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFDRCxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3BCLENBQUM7QUFaRCwrQkFZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SVBhdGh9IGZyb20gJy4uL2NvbW1vbi9pbnRlcmZhY2VzJztcblxuY29uc3QgciA9IC8nL2c7XG4vKipcbiAqIEVzY2FwZXMgc2luZ2xlIHF1b3RlcyBpbiB0aGUgZ2l2ZW4gc3RyaW5nLlxuICogQHBhcmFtIHNcbiAqL1xuZnVuY3Rpb24gc2FmZVN0cmluZyhzOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gcy5yZXBsYWNlKHIsIFwiXFxcXCdcIik7XG59XG5cbi8vIEZyb20gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIwMDg0NDRcbi8vIFRoaXMgaXMgbm90ICpwZXJmZWN0KiwgYnV0IGl0J3MgZ29vZCBlbm91Z2ggZm9yIGh1bWFuIG91dHB1dC5cbmNvbnN0IEpTX0lERU5USUZJRVJfUkVHRVhQID0gL15bXyRhLXpBLVpcXHhBMC1cXHVGRkZGXVtfJGEtekEtWjAtOVxceEEwLVxcdUZGRkZdKiQvO1xuLyoqXG4gKiBSZXR1cm5zIHRydWUgaWYgdGhlIHByb3BlcnR5IGRlZmluaXRlbHkgcmVxdWlyZXMgYXJyYXkgbm90YXRpb24uXG4gKiBUaGlzIGNoZWNrIGlzIG5vdCBzb3VuZCwgYXMgd2UgZG8gbm90IGNoZWNrIGZvciBKYXZhU2NyaXB0IHJlc2VydmVkXG4gKiB3b3Jkcy4gSG93ZXZlciwgaXQgaXMgJ2dvb2QgZW5vdWdoJyBmb3IgaHVtYW4gb3V0cHV0LCBlLmcuIGluIGEgcmVwb3J0LlxuICogQHBhcmFtIHByb3BcbiAqL1xuZnVuY3Rpb24gcHJvcGVydHlOZWVkc0FycmF5Tm90YXRpb24ocHJvcDogc3RyaW5nIHwgbnVtYmVyKTogYm9vbGVhbiB7XG4gIHJldHVybiAhSlNfSURFTlRJRklFUl9SRUdFWFAudGVzdChgJHtwcm9wfWApO1xufVxuXG5mdW5jdGlvbiBwcm9wZXJ0eUFjY2Vzc1N0cmluZyhzOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgaWYgKHR5cGVvZihzKSA9PT0gXCJudW1iZXJcIikge1xuICAgIHJldHVybiBgWyR7c31dYDtcbiAgfSBlbHNlIGlmIChwcm9wZXJ0eU5lZWRzQXJyYXlOb3RhdGlvbihzKSkge1xuICAgIHJldHVybiBgW1wiJHtzYWZlU3RyaW5nKHMpfVwiXWA7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGAuJHtzfWA7XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJldHR5UHJpbnRET01QYXRoKCk6IHZvaWQge1xuICB3aGlsZSAoUFMubm9uZW1wdHkoKSkge1xuICAgIGNvbnN0IHNlZ21lbnQgPSBQUy5wb3AoKTtcbiAgICBjb25zdCBuYW1lID0gc2VnbWVudC5pbmRleE9yTmFtZTtcbiAgICBpZiAobmFtZSA9PT0gXCJyb290XCIpIHtcbiAgICAgIC8vIElnbm9yZSB0aGlzIEJMZWFrLWluc2VydGVkIGVkZ2UuXG4gICAgICAvLyBXZSdyZSB0cmFuc2l0aW9uaW5nIHRvIGEgcGF0aCBvdXRzaWRlIG9mIHRoZSBET00sIG9uIHRoZSBET00gb2JqZWN0IGl0c2VsZi5cbiAgICAgIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpO1xuICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ2NoaWxkTm9kZXMnKSB7XG4gICAgICBQUy5wcmludChwcm9wZXJ0eUFjY2Vzc1N0cmluZyhuYW1lKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vICQkJENISUxEJCQkbiA9PiBuXG4gICAgICBjb25zdCBpZHggPSBwYXJzZUludCgobmFtZSBhcyBzdHJpbmcpLnNsaWNlKDExKSwgMTApO1xuICAgICAgLy8gU2hvdWxkIGFsdGVybmF0ZSBiZXR3ZWVuICdjaGlsZE5vZGUnIGFuZCBpbmRpY2VzIHVudGlsIGl0IGdldHMgdG8gJ3Jvb3QnLlxuICAgICAgUFMucHJpbnQocHJvcGVydHlBY2Nlc3NTdHJpbmcoaWR4KSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpOiB2b2lkIHtcbiAgd2hpbGUgKFBTLm5vbmVtcHR5KCkpIHtcbiAgICBjb25zdCBzZWdtZW50ID0gUFMucG9wKCk7XG4gICAgc3dpdGNoIChzZWdtZW50LnR5cGUpIHtcbiAgICAgIGNhc2UgUGF0aFNlZ21lbnRUeXBlLkVWRU5UX0xJU1RFTkVSX0xJU1Q6IHtcbiAgICAgICAgLy8gV2lsbCBlaXRoZXIgYmU6XG4gICAgICAgIC8vIC0gQSBsZWFrIG9uIHRoZSBsaXN0IGl0c2VsZi5cbiAgICAgICAgLy8gLSBBIGxlYWsgKndpdGhpbiogYW4gZXZlbnQgbGlzdGVuZXIuXG4gICAgICAgIC8vIFNlZWsgZm9yd2FyZCB0byBmaWd1cmUgb3V0IHdoaWNoLCBhbmQgcHJpbnQgYXBwcm9wcmlhdGVseVxuICAgICAgICAvLyAkJGxpc3RlbmVycy50eXBlW2luZGV4XS5saXN0ZW5lclxuICAgICAgICBjb25zdCB0eXBlU2VnbWVudCA9IFBTLnBvcCgpO1xuICAgICAgICBpZiAoIVBTLm5vbmVtcHR5KCkpIHtcbiAgICAgICAgICAvLyBMaXN0IGxlYWtcbiAgICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgICAgUFMucHJpbnQoYExpc3Qgb2YgJyR7dHlwZVNlZ21lbnQuaW5kZXhPck5hbWV9JyBsaXN0ZW5lcnMgb25gKTtcbiAgICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgaW5kZXhTZWdtZW50ID0gUFMucG9wKCk7XG4gICAgICAgICAgUFMucG9wKCk7IC8vIFNob3VsZCBiZSB0aGUgJy5saXN0ZW5lcicgcHJvcGVydHksIHVubGVzcyB0aGUgYXBwbGljYXRpb24gbXVja2VkIHdpdGggb3VyIG1ldGFkYXRhLlxuICAgICAgICAgIFBTLnB1c2hTdHJpbmcoKTtcbiAgICAgICAgICBQUy5wcmludChgb24gbGlzdGVuZXIgJHtpbmRleFNlZ21lbnQuaW5kZXhPck5hbWV9IGluIHRoZSBsaXN0IG9mICcke3R5cGVTZWdtZW50LmluZGV4T3JOYW1lfScgbGlzdGVuZXJzIG9uYCk7XG4gICAgICAgICAgUFMucHVzaFN0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBQYXRoU2VnbWVudFR5cGUuQ0xPU1VSRTpcbiAgICAgICAgUFMucHVzaFN0cmluZygpO1xuICAgICAgICBQUy5wcmludChcIndpdGhpbiBjbG9zdXJlIG9mXCIpO1xuICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXRoU2VnbWVudFR5cGUuQ0xPU1VSRV9WQVJJQUJMRTpcbiAgICAgICAgLy8gU2hvdWxkJ3ZlIGJlZW4gcHJlY2VkZWQgYnkgQ0xPU1VSRS5cbiAgICAgICAgLy8gQmVnaW5zIGEgbmV3IHBhdGggaW4gdGhlIHN0cmluZy5cbiAgICAgICAgUFMucHJpbnQoc2VnbWVudC5pbmRleE9yTmFtZSBhcyBzdHJpbmcpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgbGV0IGluZGV4T3JOYW1lID0gc2VnbWVudC5pbmRleE9yTmFtZTtcbiAgICAgICAgaWYgKHR5cGVvZihpbmRleE9yTmFtZSkgPT09IFwic3RyaW5nXCIgJiYgaW5kZXhPck5hbWUuc3RhcnRzV2l0aChcIiQkJG9uXCIpKSB7XG4gICAgICAgICAgLy8gQ3V0IG9mZiB0aGUgJCQkLiBUaGlzIGlzIGEgbWlycm9yZWQgZXZlbnQgbGlzdGVuZXIgcHJvcGVydHkuXG4gICAgICAgICAgaW5kZXhPck5hbWUgPSBpbmRleE9yTmFtZS5zbGljZSgzKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAqTXVzdCogYmUgYSBwcm9wZXJ0eSBvbiB0aGUgcHJldmlvdXNseS1wcmludGVkIG9iamVjdC5cbiAgICAgICAgUFMucHJpbnQocHJvcGVydHlBY2Nlc3NTdHJpbmcoaW5kZXhPck5hbWUpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFBhdGhTdHJlYW0ge1xuICBwcml2YXRlIF9wOiBJUGF0aCA9IG51bGw7XG4gIHByaXZhdGUgX2k6IG51bWJlciA9IC0xO1xuICBwcml2YXRlIF9zOiBzdHJpbmcgPSBudWxsO1xuICBwcml2YXRlIF9zczogc3RyaW5nW10gPSBudWxsO1xuICBwdWJsaWMgcHJpbnQoczogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuX3MgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuX3MgKz0gcztcbiAgICB9XG4gIH1cbiAgcHVibGljIHB1c2hTdHJpbmcoKSB7XG4gICAgaWYgKHRoaXMuX3NzICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zcy5wdXNoKHRoaXMuX3MpO1xuICAgICAgdGhpcy5fcyA9IFwiXCI7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBmbHVzaCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHMgPSB0aGlzLl9zO1xuICAgIGNvbnN0IHNzID0gdGhpcy5fc3M7XG4gICAgdGhpcy5fc3MgPSB0aGlzLl9zID0gbnVsbDtcbiAgICBzcy5wdXNoKHMpO1xuICAgIHJldHVybiBzcy5maWx0ZXIoKHMpID0+IHMgIT09IFwiXCIpLnJldmVyc2UoKS5qb2luKFwiIFwiKTtcbiAgfVxuICBwdWJsaWMgc2V0UGF0aChwOiBJUGF0aCkge1xuICAgIHRoaXMuX3AgPSBwO1xuICAgIHRoaXMuX2kgPSAwO1xuICAgIHRoaXMuX3MgPSBcIlwiO1xuICAgIHRoaXMuX3NzID0gW107XG4gIH1cbiAgcHVibGljIGFkdmFuY2UoKTogdm9pZCB7XG4gICAgdGhpcy5faSsrO1xuICB9XG4gIHB1YmxpYyBwZWVrKCk6IElQYXRoU2VnbWVudCB8IG51bGwge1xuICAgIGlmICh0aGlzLm5vbmVtcHR5KCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9wW3RoaXMuX2ldO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgcHVibGljIHBvcCgpOiBJUGF0aFNlZ21lbnQgfCBudWxsIHtcbiAgICBjb25zdCBydiA9IHRoaXMucGVlaygpO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIHJldHVybiBydjtcbiAgfVxuICBwdWJsaWMgbm9uZW1wdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3AgJiYgdGhpcy5fcC5sZW5ndGggPiB0aGlzLl9pO1xuICB9XG59XG4vLyBTaW5nbGV0b24gY2xhc3MuXG5jb25zdCBQUyA9IG5ldyBQYXRoU3RyZWFtKCk7XG5cbi8qKlxuICogUHJldHR5IHByaW50IGEgcGF0aCBhcyBhIGh1bWFuLWZyaWVuZGx5IHN0cmluZy5cbiAqIEBwYXJhbSBwXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHBhdGhUb1N0cmluZyhwOiBJUGF0aCk6IHN0cmluZyB7XG4gIFBTLnNldFBhdGgocCk7XG4gIGNvbnN0IHNlZ21lbnQgPSBQUy5wZWVrKCk7XG4gIGlmIChzZWdtZW50LnR5cGUgPT09IFBhdGhTZWdtZW50VHlwZS5ET01fVFJFRSkge1xuICAgIFBTLnByaW50KFwiZG9jdW1lbnRcIik7XG4gICAgUFMuYWR2YW5jZSgpO1xuICAgIHByZXR0eVByaW50RE9NUGF0aCgpO1xuICB9IGVsc2Uge1xuICAgIFBTLnByaW50KFwid2luZG93XCIpO1xuICAgIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpO1xuICB9XG4gIHJldHVybiBQUy5mbHVzaCgpO1xufVxuIl19