"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const http_server_1 = require("./util/http_server");
const assert_1 = require("assert");
const zlib_1 = require("zlib");
const mitmproxy_1 = require("mitmproxy");
const HTTP_PORT = 8888;
// 'Files' present in the test HTTP server
const FILES = {
    '/test.html': {
        mimeType: 'text/html',
        data: Buffer.from('<!DOCTYPE html><html><head><title>My Web Page</title></head></html>', 'utf8')
    },
    '/test.js': {
        mimeType: 'text/javascript',
        data: Buffer.from('window.SHENANIGANS = true;', 'utf8')
    },
    '/test.js.gz': {
        mimeType: 'text/javascript',
        data: zlib_1.gzipSync(Buffer.from('window.SHENANIGANS = true;', 'utf8')),
        headers: {
            'content-encoding': 'gzip'
        }
    },
    '/test.jpg': {
        mimeType: 'image/jpeg',
        data: Buffer.alloc(1025, 0)
    },
    '/huge.html': {
        mimeType: 'text/html',
        // 10MB file filled w/ a's.
        data: Buffer.alloc(1024 * 1024 * 10, 97)
    },
    '/huge.jpg': {
        mimeType: 'image/jpeg',
        data: Buffer.alloc(1024 * 1024 * 10, 0)
    },
    '/': {
        mimeType: 'text/html',
        data: Buffer.from('<!DOCTYPE html><html><title>Not Found</title></html>', 'utf8')
    }
};
describe('Proxy', function () {
    this.timeout(30000);
    let proxy;
    let httpServer;
    before(async function () {
        httpServer = await http_server_1.default(FILES, HTTP_PORT);
        proxy = await mitmproxy_1.default.Create(undefined, [], true);
    });
    async function requestFile(path, expected) {
        const response = await proxy.proxyGet(`http://localhost:${HTTP_PORT}${path}`);
        if (!response.body.equals(expected)) {
            console.log(`${response.body.length} actual, ${expected.length} expected`);
            console.log(`${response.body[10]}, ${expected[10]}`);
        }
        assert_1.equal(response.body.equals(expected), true);
    }
    it("Properly proxies text files", async function () {
        proxy.cb = mitmproxy_1.nopInterceptor;
        const promises = ['/test.html', '/test.js'].map((filename) => {
            return requestFile(filename, FILES[filename].data);
        });
        promises.push(requestFile('/test.jpg', FILES['/test.jpg'].data));
        return Promise.all(promises);
    });
    it("Properly handles compressed data", async function () {
        proxy.cb = mitmproxy_1.nopInterceptor;
        await requestFile('/test.js.gz', zlib_1.gunzipSync(FILES['/test.js.gz'].data));
    });
    it("Properly rewrites text files", async function () {
        const MAGIC_STRING = Buffer.from("HELLO THERE", 'utf8');
        function transform(m) {
            const mimeType = m.response.getHeader('content-type').toLowerCase();
            if (mimeType === "text/html" || mimeType === "text/javascript") {
                m.setResponseBody(MAGIC_STRING);
            }
        }
        proxy.cb = transform;
        const promises = ['/test.html', '/test.js'].map((filename) => {
            return requestFile(filename, MAGIC_STRING);
        });
        promises.push(requestFile('/test.jpg', FILES['/test.jpg'].data));
        return Promise.all(promises);
    });
    it("Properly proxies huge binary files", async function () {
        proxy.cb = mitmproxy_1.nopInterceptor;
        return requestFile('/huge.jpg', FILES['/huge.jpg'].data);
    });
    it("Properly proxies huge text files", async function () {
        const raw = FILES['/huge.html'].data;
        const expected = Buffer.alloc(raw.length, 98);
        proxy.cb = (f) => {
            f.setResponseBody(Buffer.from(f.responseBody.toString().replace(/a/g, 'b'), 'utf8'));
        };
        return requestFile('/huge.html', expected);
    });
    after(function (done) {
        // Shutdown both HTTP server and proxy.
        httpServer.close((e) => {
            if (e) {
                done(e);
            }
            else {
                proxy.shutdown().then(done).catch(done);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHlfdGVzdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0L3Byb3h5X3Rlc3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0RBQWtEO0FBQ2xELG1DQUE0QztBQUM1QywrQkFBMEM7QUFDMUMseUNBQXVGO0FBRXZGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQztBQVF2QiwwQ0FBMEM7QUFDMUMsTUFBTSxLQUFLLEdBQStCO0lBQ3hDLFlBQVksRUFBRTtRQUNaLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLHFFQUFxRSxFQUFFLE1BQU0sQ0FBQztLQUNqRztJQUNELFVBQVUsRUFBRTtRQUNWLFFBQVEsRUFBRSxpQkFBaUI7UUFDM0IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsTUFBTSxDQUFDO0tBQ3hEO0lBQ0QsYUFBYSxFQUFFO1FBQ2IsUUFBUSxFQUFFLGlCQUFpQjtRQUMzQixJQUFJLEVBQUUsZUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDakUsT0FBTyxFQUFFO1lBQ1Asa0JBQWtCLEVBQUUsTUFBTTtTQUMzQjtLQUNGO0lBQ0QsV0FBVyxFQUFFO1FBQ1gsUUFBUSxFQUFFLFlBQVk7UUFDdEIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztLQUM1QjtJQUNELFlBQVksRUFBRTtRQUNaLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLDJCQUEyQjtRQUMzQixJQUFJLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUMsSUFBSSxHQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7S0FDckM7SUFDRCxXQUFXLEVBQUU7UUFDWCxRQUFRLEVBQUUsWUFBWTtRQUN0QixJQUFJLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJ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LENBQUM7UUFDdkYsQ0FBQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDN0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxLQUFLLENBQUMsVUFBUyxJQUFJO1FBQ2pCLHVDQUF1QztRQUN2QyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7WUFDMUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDTixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U2VydmVyIGFzIEhUVFBTZXJ2ZXJ9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IGNyZWF0ZUhUVFBTZXJ2ZXIgZnJvbSAnLi91dGlsL2h0dHBfc2VydmVyJztcbmltcG9ydCB7ZXF1YWwgYXMgYXNzZXJ0RXF1YWx9IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQge2d6aXBTeW5jLCBndW56aXBTeW5jfSBmcm9tICd6bGliJztcbmltcG9ydCB7ZGVmYXVsdCBhcyBNSVRNUHJveHksIEludGVyY2VwdGVkSFRUUE1lc3NhZ2UsIG5vcEludGVyY2VwdG9yfSBmcm9tICdtaXRtcHJveHknO1xuXG5jb25zdCBIVFRQX1BPUlQgPSA4ODg4O1xuXG5pbnRlcmZhY2UgVGVzdEZpbGUge1xuICBtaW1lVHlwZTogc3RyaW5nO1xuICBkYXRhOiBCdWZmZXI7XG4gIGhlYWRlcnM/OiB7W25hbWU6IHN0cmluZ106IHN0cmluZ31cbn1cblxuLy8gJ0ZpbGVzJyBwcmVzZW50IGluIHRoZSB0ZXN0IEhUVFAgc2VydmVyXG5jb25zdCBGSUxFUzoge1tuYW1lOiBzdHJpbmddOiBUZXN0RmlsZX0gPSB7XG4gICcvdGVzdC5odG1sJzoge1xuICAgIG1pbWVUeXBlOiAndGV4dC9odG1sJyxcbiAgICBkYXRhOiBCdWZmZXIuZnJvbSgnPCFET0NUWVBFIGh0bWw+PGh0bWw+PGhlYWQ+PHRpdGxlPk15IFdlYiBQYWdlPC90aXRsZT48L2hlYWQ+PC9odG1sPicsICd1dGY4JylcbiAgfSxcbiAgJy90ZXN0LmpzJzoge1xuICAgIG1pbWVUeXBlOiAndGV4dC9qYXZhc2NyaXB0JyxcbiAgICBkYXRhOiBCdWZmZXIuZnJvbSgnd2luZG93LlNIRU5BTklHQU5TID0gdHJ1ZTsnLCAndXRmOCcpXG4gIH0sXG4gICcvdGVzdC5qcy5neic6IHtcbiAgICBtaW1lVHlwZTogJ3RleHQvamF2YXNjcmlwdCcsXG4gICAgZGF0YTogZ3ppcFN5bmMoQnVmZmVyLmZyb20oJ3dpbmRvdy5TSEVOQU5JR0FOUyA9IHRydWU7JywgJ3V0ZjgnKSksXG4gICAgaGVhZGVyczoge1xuICAgICAgJ2NvbnRlbnQtZW5jb2RpbmcnOiAnZ3ppcCdcbiAgICB9XG4gIH0sXG4gICcvdGVzdC5qcGcnOiB7XG4gICAgbWltZVR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICBkYXRhOiBCdWZmZXIuYWxsb2MoMTAyNSwgMClcbiAgfSxcbiAgJy9odWdlLmh0bWwnOiB7XG4gICAgbWltZVR5cGU6ICd0ZXh0L2h0bWwnLFxuICAgIC8vIDEwTUIgZmlsZSBmaWxsZWQgdy8gYSdzLlxuICAgIGRhdGE6IEJ1ZmZlci5hbGxvYygxMDI0KjEwMjQqMTAsIDk3KVxuICB9LFxuICAnL2h1Z2UuanBnJzoge1xuICAgIG1pbWVUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgZGF0YTogQnVmZmVyLmFsbG9jKDEwMjQqMTAyNCoxMCwgMClcbiAgfSxcbiAgJy8nOiB7XG4gICAgbWltZVR5cGU6ICd0ZXh0L2h0bWwnLFxuICAgIGRhdGE6IEJ1ZmZlci5mcm9tKCc8IURPQ1RZUEUgaHRtbD48aHRtbD48dGl0bGU+Tm90IEZvdW5kPC90aXRsZT48L2h0bWw+JywgJ3V0ZjgnKVxuICB9XG59O1xuXG5kZXNjcmliZSgnUHJveHknLCBmdW5jdGlvbigpIHtcbiAgdGhpcy50aW1lb3V0KDMwMDAwKTtcbiAgbGV0IHByb3h5OiBNSVRNUHJveHk7XG4gIGxldCBodHRwU2VydmVyOiBIVFRQU2VydmVyO1xuICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgaHR0cFNlcnZlciA9IGF3YWl0IGNyZWF0ZUhUVFBTZXJ2ZXIoRklMRVMsIEhUVFBfUE9SVCk7XG4gICAgcHJveHkgPSBhd2FpdCBNSVRNUHJveHkuQ3JlYXRlKHVuZGVmaW5lZCwgW10sIHRydWUpO1xuICB9KTtcblxuICBhc3luYyBmdW5jdGlvbiByZXF1ZXN0RmlsZShwYXRoOiBzdHJpbmcsIGV4cGVjdGVkOiBCdWZmZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHByb3h5LnByb3h5R2V0KGBodHRwOi8vbG9jYWxob3N0OiR7SFRUUF9QT1JUfSR7cGF0aH1gKTtcbiAgICBpZiAoIXJlc3BvbnNlLmJvZHkuZXF1YWxzKGV4cGVjdGVkKSkge1xuICAgICAgY29uc29sZS5sb2coYCR7cmVzcG9uc2UuYm9keS5sZW5ndGh9IGFjdHVhbCwgJHtleHBlY3RlZC5sZW5ndGh9IGV4cGVjdGVkYCk7XG4gICAgICBjb25zb2xlLmxvZyhgJHtyZXNwb25zZS5ib2R5WzEwXX0sICR7ZXhwZWN0ZWRbMTBdfWApO1xuICAgIH1cbiAgICBhc3NlcnRFcXVhbChyZXNwb25zZS5ib2R5LmVxdWFscyhleHBlY3RlZCksIHRydWUpO1xuICB9XG5cbiAgaXQoXCJQcm9wZXJseSBwcm94aWVzIHRleHQgZmlsZXNcIiwgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgcHJveHkuY2IgPSBub3BJbnRlcmNlcHRvcjtcbiAgICBjb25zdCBwcm9taXNlcyA9IFsnL3Rlc3QuaHRtbCcsICcvdGVzdC5qcyddLm1hcCgoZmlsZW5hbWUpID0+IHtcbiAgICAgIHJldHVybiByZXF1ZXN0RmlsZShmaWxlbmFtZSwgRklMRVNbZmlsZW5hbWVdLmRhdGEpO1xuICAgIH0pO1xuICAgIHByb21pc2VzLnB1c2gocmVxdWVzdEZpbGUoJy90ZXN0LmpwZycsIEZJTEVTWycvdGVzdC5qcGcnXS5kYXRhKSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfSk7XG5cbiAgaXQoXCJQcm9wZXJseSBoYW5kbGVzIGNvbXByZXNzZWQgZGF0YVwiLCBhc3luYyBmdW5jdGlvbigpIHtcbiAgICBwcm94eS5jYiA9IG5vcEludGVyY2VwdG9yO1xuICAgIGF3YWl0IHJlcXVlc3RGaWxlKCcvdGVzdC5qcy5neicsIGd1bnppcFN5bmMoRklMRVNbJy90ZXN0LmpzLmd6J10uZGF0YSkpO1xuICB9KTtcblxuICBpdChcIlByb3Blcmx5IHJld3JpdGVzIHRleHQgZmlsZXNcIiwgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgTUFHSUNfU1RSSU5HID0gQnVmZmVyLmZyb20oXCJIRUxMTyBUSEVSRVwiLCAndXRmOCcpO1xuICAgIGZ1bmN0aW9uIHRyYW5zZm9ybShtOiBJbnRlcmNlcHRlZEhUVFBNZXNzYWdlKTogdm9pZCB7XG4gICAgICBjb25zdCBtaW1lVHlwZSA9IG0ucmVzcG9uc2UuZ2V0SGVhZGVyKCdjb250ZW50LXR5cGUnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKG1pbWVUeXBlID09PSBcInRleHQvaHRtbFwiIHx8IG1pbWVUeXBlID09PSBcInRleHQvamF2YXNjcmlwdFwiKSB7XG4gICAgICAgIG0uc2V0UmVzcG9uc2VCb2R5KE1BR0lDX1NUUklORyk7XG4gICAgICB9XG4gICAgfVxuICAgIHByb3h5LmNiID0gdHJhbnNmb3JtO1xuICAgIGNvbnN0IHByb21pc2VzID0gWycvdGVzdC5odG1sJywgJy90ZXN0LmpzJ10ubWFwKChmaWxlbmFtZSkgPT4ge1xuICAgICAgcmV0dXJuIHJlcXVlc3RGaWxlKGZpbGVuYW1lLCBNQUdJQ19TVFJJTkcpO1xuICAgIH0pO1xuICAgIHByb21pc2VzLnB1c2gocmVxdWVzdEZpbGUoJy90ZXN0LmpwZycsIEZJTEVTWycvdGVzdC5qcGcnXS5kYXRhKSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfSk7XG5cbiAgaXQoXCJQcm9wZXJseSBwcm94aWVzIGh1Z2UgYmluYXJ5IGZpbGVzXCIsIGFzeW5jIGZ1bmN0aW9uKCkge1xuICAgIHByb3h5LmNiID0gbm9wSW50ZXJjZXB0b3I7XG4gICAgcmV0dXJuIHJlcXVlc3RGaWxlKCcvaHVnZS5qcGcnLCBGSUxFU1snL2h1Z2UuanBnJ10uZGF0YSk7XG4gIH0pO1xuXG4gIGl0KFwiUHJvcGVybHkgcHJveGllcyBodWdlIHRleHQgZmlsZXNcIiwgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgcmF3ID0gRklMRVNbJy9odWdlLmh0bWwnXS5kYXRhO1xuICAgIGNvbnN0IGV4cGVjdGVkID0gQnVmZmVyLmFsbG9jKHJhdy5sZW5ndGgsIDk4KTtcbiAgICBwcm94eS5jYiA9IChmOiBJbnRlcmNlcHRlZEhUVFBNZXNzYWdlKTogdm9pZCA9PiB7XG4gICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShmLnJlc3BvbnNlQm9keS50b1N0cmluZygpLnJlcGxhY2UoL2EvZywgJ2InKSwgJ3V0ZjgnKSk7XG4gICAgfTtcbiAgICByZXR1cm4gcmVxdWVzdEZpbGUoJy9odWdlLmh0bWwnLCBleHBlY3RlZCk7XG4gIH0pO1xuXG4gIGFmdGVyKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICAvLyBTaHV0ZG93biBib3RoIEhUVFAgc2VydmVyIGFuZCBwcm94eS5cbiAgICBodHRwU2VydmVyLmNsb3NlKChlOiBhbnkpID0+IHtcbiAgICAgIGlmIChlKSB7XG4gICAgICAgIGRvbmUoZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm94eS5zaHV0ZG93bigpLnRoZW4oZG9uZSkuY2F0Y2goZG9uZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7Il19