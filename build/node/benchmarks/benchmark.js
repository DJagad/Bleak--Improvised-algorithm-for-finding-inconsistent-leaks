"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Benchmark = require("benchmark");
const zlib_1 = require("zlib");
const fs_1 = require("fs");
const path_1 = require("path");
const growth_graph_1 = require("../src/lib/growth_graph");
const transformations_1 = require("../src/lib/transformations");
const heap_snapshot_parser_1 = require("../src/lib/heap_snapshot_parser");
const skipSnapshots = process.argv.indexOf("--skip-snapshots") !== -1;
let loomioSnapshots = [];
let piwikSnapshots = [];
let loomioJs = null;
let piwikJs = null;
const suite = new Benchmark.Suite('BLeak');
const snapshotDir = './benchmarks/snapshots';
const jsDir = './benchmarks/javascript';
const reportFilename = `./benchmarks/benchmark_report_${new Date().toISOString().replace(/:/g, '_')}.log`;
const benchmarkReport = fs_1.createWriteStream(reportFilename);
console.log(`Writing report to ${reportFilename}`);
if (skipSnapshots) {
    console.log("Skipping snapshots.");
}
function getSnapshots(prefix) {
    return fs_1.readdirSync(snapshotDir)
        .filter((s) => s.startsWith(prefix))
        .map((s) => path_1.join(snapshotDir, s))
        .map(gunzipFile);
}
function getJavascript(file) {
    return gunzipFile(path_1.join(jsDir, file));
}
function gunzipFile(file) {
    return zlib_1.gunzipSync(fs_1.readFileSync(file)).toString("utf8");
}
async function getGrowthPaths(snapshots) {
    const builder = new growth_graph_1.HeapGrowthTracker();
    for (const snapshot of snapshots) {
        await builder.addSnapshot(heap_snapshot_parser_1.default.FromString(snapshot));
    }
    return builder.findLeakPaths();
}
async function getHeapSize(snapshot) {
    const graph = await growth_graph_1.HeapGraph.Construct(heap_snapshot_parser_1.default.FromString(snapshot));
    return graph.calculateSize();
}
if (!skipSnapshots) {
    suite
        .add("Loomio: Growth Paths", {
        fn: function (deferred) {
            getGrowthPaths(loomioSnapshots).then(() => deferred.resolve());
        },
        onStart: () => {
            loomioSnapshots = getSnapshots("loomio");
        },
        defer: true
    })
        .add("Loomio: Heap Size", {
        fn: function (deferred) {
            Promise.all(loomioSnapshots.map(getHeapSize)).then(() => deferred.resolve());
        },
        onComplete: () => {
            loomioSnapshots = [];
        },
        defer: true
    })
        .add("Piwik: Growth Paths", {
        fn: function (deferred) {
            getGrowthPaths(piwikSnapshots).then(() => deferred.resolve());
        },
        onStart: () => {
            piwikSnapshots = getSnapshots("piwik");
        },
        defer: true
    })
        .add("Piwik: Heap Size", {
        fn: function (deferred) {
            Promise.all(piwikSnapshots.map(getHeapSize)).then(() => deferred.resolve());
        },
        onComplete: () => {
            piwikSnapshots = [];
        },
        defer: true
    });
}
suite.add("Loomio: Expose Closure State", function () {
    transformations_1.exposeClosureState('loomio_vendor.js', loomioJs);
}, {
    onStart: () => {
        loomioJs = getJavascript('loomio_vendor.js.gz');
    },
    onComplete: () => {
        loomioJs = null;
    },
    defer: false
})
    .add("Piwik: Expose Closure State", function () {
    transformations_1.exposeClosureState('piwik_app.js', piwikJs);
}, {
    onStart: () => {
        piwikJs = getJavascript('piwik_app.js.gz');
    },
    onComplete: () => {
        piwikJs = null;
    },
    defer: false
})
    .on('cycle', function (event) {
    const str = String(event.target);
    console.log(str);
    benchmarkReport.write(str + "\n");
})
    .on('complete', function () {
    benchmarkReport.end();
})
    .on('error', function (e) {
    console.log("Received error!");
    console.log(e);
});
suite.run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVuY2htYXJrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vYmVuY2htYXJrcy9iZW5jaG1hcmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBdUM7QUFDdkMsK0JBQWdDO0FBQ2hDLDJCQUFnRTtBQUNoRSwrQkFBMEI7QUFFMUIsMERBQXFFO0FBQ3JFLGdFQUE4RDtBQUM5RCwwRUFBaUU7QUFFakUsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUN0RSxJQUFJLGVBQWUsR0FBYSxFQUFFLENBQUM7QUFDbkMsSUFBSSxjQUFjLEdBQWEsRUFBRSxDQUFDO0FBQ2xDLElBQUksUUFBUSxHQUFXLElBQUksQ0FBQztBQUM1QixJQUFJLE9BQU8sR0FBVyxJQUFJLENBQUM7QUFDM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNDLE1BQU0sV0FBVyxHQUFHLHdCQUF3QixDQUFDO0FBQzdDLE1BQU0sS0FBSyxHQUFHLHlCQUF5QixDQUFDO0FBQ3hDLE1BQU0sY0FBYyxHQUFHLGlDQUFpQyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQztBQUMxRyxNQUFNLGVBQWUsR0FBRyxzQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUN6RCxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBQ25ELEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFFRCxzQkFBc0IsTUFBYztJQUNsQyxNQUFNLENBQUMsZ0JBQVcsQ0FBQyxXQUFXLENBQUM7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RUFBRTtJQUNkLGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUN4QixDQUFDLENBQUM7S0FDRCxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBTTtJQUMxQixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNqQixDQUFDLENBQUMsQ0FBQztBQUVMLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEJlbmNobWFyayBmcm9tICdiZW5jaG1hcmsnO1xuaW1wb3J0IHtndW56aXBTeW5jfSBmcm9tICd6bGliJztcbmltcG9ydCB7cmVhZEZpbGVTeW5jLCByZWFkZGlyU3luYywgY3JlYXRlV3JpdGVTdHJlYW19IGZyb20gJ2ZzJztcbmltcG9ydCB7am9pbn0gZnJvbSAncGF0aCc7XG5pbXBvcnQge1NuYXBzaG90U2l6ZVN1bW1hcnl9IGZyb20gJy4uL3NyYy9jb21tb24vaW50ZXJmYWNlcyc7XG5pbXBvcnQge0hlYXBHcm93dGhUcmFja2VyLCBIZWFwR3JhcGh9IGZyb20gJy4uL3NyYy9saWIvZ3Jvd3RoX2dyYXBoJztcbmltcG9ydCB7ZXhwb3NlQ2xvc3VyZVN0YXRlfSBmcm9tICcuLi9zcmMvbGliL3RyYW5zZm9ybWF0aW9ucyc7XG5pbXBvcnQgSGVhcFNuYXBzaG90UGFyc2VyIGZyb20gJy4uL3NyYy9saWIvaGVhcF9zbmFwc2hvdF9wYXJzZXInO1xuXG5jb25zdCBza2lwU25hcHNob3RzID0gcHJvY2Vzcy5hcmd2LmluZGV4T2YoXCItLXNraXAtc25hcHNob3RzXCIpICE9PSAtMTtcbmxldCBsb29taW9TbmFwc2hvdHM6IHN0cmluZ1tdID0gW107XG5sZXQgcGl3aWtTbmFwc2hvdHM6IHN0cmluZ1tdID0gW107XG5sZXQgbG9vbWlvSnM6IHN0cmluZyA9IG51bGw7XG5sZXQgcGl3aWtKczogc3RyaW5nID0gbnVsbDtcbmNvbnN0IHN1aXRlID0gbmV3IEJlbmNobWFyay5TdWl0ZSgnQkxlYWsnKTtcbmNvbnN0IHNuYXBzaG90RGlyID0gJy4vYmVuY2htYXJrcy9zbmFwc2hvdHMnO1xuY29uc3QganNEaXIgPSAnLi9iZW5jaG1hcmtzL2phdmFzY3JpcHQnO1xuY29uc3QgcmVwb3J0RmlsZW5hbWUgPSBgLi9iZW5jaG1hcmtzL2JlbmNobWFya19yZXBvcnRfJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnXycpfS5sb2dgO1xuY29uc3QgYmVuY2htYXJrUmVwb3J0ID0gY3JlYXRlV3JpdGVTdHJlYW0ocmVwb3J0RmlsZW5hbWUpXG5jb25zb2xlLmxvZyhgV3JpdGluZyByZXBvcnQgdG8gJHtyZXBvcnRGaWxlbmFtZX1gKTtcbmlmIChza2lwU25hcHNob3RzKSB7XG4gIGNvbnNvbGUubG9nKFwiU2tpcHBpbmcgc25hcHNob3RzLlwiKTtcbn1cblxuZnVuY3Rpb24gZ2V0U25hcHNob3RzKHByZWZpeDogc3RyaW5nKTogc3RyaW5nW10ge1xuICByZXR1cm4gcmVhZGRpclN5bmMoc25hcHNob3REaXIpXG4gICAgLmZpbHRlcigocykgPT4gcy5zdGFydHNXaXRoKHByZWZpeCkpXG4gICAgLm1hcCgocykgPT4gam9pbihzbmFwc2hvdERpciwgcykpXG4gICAgLm1hcChndW56aXBGaWxlKTtcbn1cblxuZnVuY3Rpb24gZ2V0SmF2YXNjcmlwdChmaWxlOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gZ3VuemlwRmlsZShqb2luKGpzRGlyLCBmaWxlKSk7XG59XG5cbmZ1bmN0aW9uIGd1bnppcEZpbGUoZmlsZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGd1bnppcFN5bmMocmVhZEZpbGVTeW5jKGZpbGUpKS50b1N0cmluZyhcInV0ZjhcIik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEdyb3d0aFBhdGhzKHNuYXBzaG90czogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICBjb25zdCBidWlsZGVyID0gbmV3IEhlYXBHcm93dGhUcmFja2VyKCk7XG4gIGZvciAoY29uc3Qgc25hcHNob3Qgb2Ygc25hcHNob3RzKSB7XG4gICAgYXdhaXQgYnVpbGRlci5hZGRTbmFwc2hvdChIZWFwU25hcHNob3RQYXJzZXIuRnJvbVN0cmluZyhzbmFwc2hvdCkpO1xuICB9XG4gIHJldHVybiBidWlsZGVyLmZpbmRMZWFrUGF0aHMoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0SGVhcFNpemUoc25hcHNob3Q6IHN0cmluZyk6IFByb21pc2U8U25hcHNob3RTaXplU3VtbWFyeT4ge1xuICBjb25zdCBncmFwaCA9IGF3YWl0IEhlYXBHcmFwaC5Db25zdHJ1Y3QoSGVhcFNuYXBzaG90UGFyc2VyLkZyb21TdHJpbmcoc25hcHNob3QpKTtcbiAgcmV0dXJuIGdyYXBoLmNhbGN1bGF0ZVNpemUoKTtcbn1cblxuaW50ZXJmYWNlIERlZmVycmVkIHtcbiAgcmVzb2x2ZSgpOiB2b2lkO1xufVxuXG5pZiAoIXNraXBTbmFwc2hvdHMpIHtcbiAgc3VpdGVcbiAgICAuYWRkKFwiTG9vbWlvOiBHcm93dGggUGF0aHNcIiwge1xuICAgICAgZm46IGZ1bmN0aW9uKGRlZmVycmVkOiBEZWZlcnJlZCkge1xuICAgICAgICBnZXRHcm93dGhQYXRocyhsb29taW9TbmFwc2hvdHMpLnRoZW4oKCkgPT4gZGVmZXJyZWQucmVzb2x2ZSgpKTtcbiAgICAgIH0sXG4gICAgICBvblN0YXJ0OiAoKSA9PiB7XG4gICAgICAgIGxvb21pb1NuYXBzaG90cyA9IGdldFNuYXBzaG90cyhcImxvb21pb1wiKTtcbiAgICAgIH0sXG4gICAgICBkZWZlcjogdHJ1ZVxuICAgIH0pXG4gICAgLmFkZChcIkxvb21pbzogSGVhcCBTaXplXCIsIHtcbiAgICAgIGZuOiBmdW5jdGlvbihkZWZlcnJlZDogRGVmZXJyZWQpIHtcbiAgICAgICAgUHJvbWlzZS5hbGwobG9vbWlvU25hcHNob3RzLm1hcChnZXRIZWFwU2l6ZSkpLnRoZW4oKCkgPT4gZGVmZXJyZWQucmVzb2x2ZSgpKTtcbiAgICAgIH0sXG4gICAgICBvbkNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgIGxvb21pb1NuYXBzaG90cyA9IFtdO1xuICAgICAgfSxcbiAgICAgIGRlZmVyOiB0cnVlXG4gICAgfSlcbiAgICAuYWRkKFwiUGl3aWs6IEdyb3d0aCBQYXRoc1wiLCB7XG4gICAgICBmbjogZnVuY3Rpb24oZGVmZXJyZWQ6IERlZmVycmVkKSB7XG4gICAgICAgIGdldEdyb3d0aFBhdGhzKHBpd2lrU25hcHNob3RzKS50aGVuKCgpID0+IGRlZmVycmVkLnJlc29sdmUoKSk7XG4gICAgICB9LFxuICAgICAgb25TdGFydDogKCkgPT4ge1xuICAgICAgICBwaXdpa1NuYXBzaG90cyA9IGdldFNuYXBzaG90cyhcInBpd2lrXCIpO1xuICAgICAgfSxcbiAgICAgIGRlZmVyOiB0cnVlXG4gICAgfSlcbiAgICAuYWRkKFwiUGl3aWs6IEhlYXAgU2l6ZVwiLCB7XG4gICAgICBmbjogZnVuY3Rpb24oZGVmZXJyZWQ6IERlZmVycmVkKSB7XG4gICAgICAgIFByb21pc2UuYWxsKHBpd2lrU25hcHNob3RzLm1hcChnZXRIZWFwU2l6ZSkpLnRoZW4oKCkgPT4gZGVmZXJyZWQucmVzb2x2ZSgpKTtcbiAgICAgIH0sXG4gICAgICBvbkNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgIHBpd2lrU25hcHNob3RzID0gW107XG4gICAgICB9LFxuICAgICAgZGVmZXI6IHRydWVcbiAgICB9KTtcbn1cbnN1aXRlLmFkZChcIkxvb21pbzogRXhwb3NlIENsb3N1cmUgU3RhdGVcIiwgZnVuY3Rpb24oKSB7XG4gICAgZXhwb3NlQ2xvc3VyZVN0YXRlKCdsb29taW9fdmVuZG9yLmpzJywgbG9vbWlvSnMpO1xuICB9LCB7XG4gICAgb25TdGFydDogKCkgPT4ge1xuICAgICAgbG9vbWlvSnMgPSBnZXRKYXZhc2NyaXB0KCdsb29taW9fdmVuZG9yLmpzLmd6Jyk7XG4gICAgfSxcbiAgICBvbkNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICBsb29taW9KcyA9IG51bGw7XG4gICAgfSxcbiAgICBkZWZlcjogZmFsc2VcbiAgfSlcbiAgLmFkZChcIlBpd2lrOiBFeHBvc2UgQ2xvc3VyZSBTdGF0ZVwiLCBmdW5jdGlvbigpIHtcbiAgICBleHBvc2VDbG9zdXJlU3RhdGUoJ3Bpd2lrX2FwcC5qcycsIHBpd2lrSnMpO1xuICB9LCB7XG4gICAgb25TdGFydDogKCkgPT4ge1xuICAgICAgcGl3aWtKcyA9IGdldEphdmFzY3JpcHQoJ3Bpd2lrX2FwcC5qcy5neicpO1xuICAgIH0sXG4gICAgb25Db21wbGV0ZTogKCkgPT4ge1xuICAgICAgcGl3aWtKcyA9IG51bGw7XG4gICAgfSxcbiAgICBkZWZlcjogZmFsc2VcbiAgfSlcbiAgLy8gYWRkIGxpc3RlbmVyc1xuICAub24oJ2N5Y2xlJywgZnVuY3Rpb24oZXZlbnQ6IGFueSkge1xuICAgIGNvbnN0IHN0ciA9IFN0cmluZyhldmVudC50YXJnZXQpO1xuICAgIGNvbnNvbGUubG9nKHN0cik7XG4gICAgYmVuY2htYXJrUmVwb3J0LndyaXRlKHN0ciArIFwiXFxuXCIpO1xuICB9KVxuICAub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24oKSB7XG4gICAgYmVuY2htYXJrUmVwb3J0LmVuZCgpO1xuICB9KVxuICAub24oJ2Vycm9yJywgZnVuY3Rpb24oZTogYW55KSB7XG4gICAgY29uc29sZS5sb2coXCJSZWNlaXZlZCBlcnJvciFcIik7XG4gICAgY29uc29sZS5sb2coZSk7XG4gIH0pO1xuXG5zdWl0ZS5ydW4oKTtcbiJdfQ==