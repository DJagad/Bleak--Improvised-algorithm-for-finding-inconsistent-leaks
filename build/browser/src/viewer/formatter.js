// Copyright 2014 The Chromium Authors. All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are
// met:
//
//    * Redistributions of source code must retain the above copyright
// notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above
// copyright notice, this list of conditions and the following disclaimer
// in the documentation and/or other materials provided with the
// distribution.
//    * Neither the name of Google Inc. nor the names of its
// contributors may be used to endorse or promote products derived from
// this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
import * as tslib_1 from "tslib";
// This file contains wrappers around the Chromium Development Tool's
// JavaScript source code formatter. These wrappers were manually converted
// to TypeScript and simplified from the original source.
import Location from './model/location';
var PendingFormatRequest = /** @class */ (function () {
    function PendingFormatRequest(original, success, error) {
        this.original = original;
        this.success = success;
        this.error = error;
    }
    return PendingFormatRequest;
}());
var FormatWorker = /** @class */ (function () {
    function FormatWorker(ready) {
        var _this = this;
        this._queue = [];
        // Use the original, unmodified worker code from Chrome devtools.
        this._w = new Worker("chrome-devtools-frontend/front_end/formatter_worker.js");
        this._w.onmessage = function (e) {
            if (e.data === "workerReady") {
                return ready(_this);
            }
            if (_this._queue.length > 0) {
                var d = e.data;
                var i = _this._queue.shift();
                var ogLe = computeLineEndings(i.original);
                var formattedLe = computeLineEndings(d.content);
                i.success(i.original, d.content, new FormatterSourceMapping(ogLe, formattedLe, d.mapping));
            }
            else {
                console.error("Received unsolicited message from FormatWorker: " + e.data);
            }
        };
        this._w.onerror = function (e) {
            if (_this._queue.length > 0) {
                var i = _this._queue.shift();
                i.error(e.error);
            }
            else {
                console.error("Received uncaught error in FormatWorker: " + e.error);
            }
        };
    }
    FormatWorker.Create = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        new FormatWorker(resolve);
                    })];
            });
        });
    };
    FormatWorker.prototype.format = function (source, mimeType, onsuccess, onerror) {
        var req = {
            method: "format",
            params: {
                mimeType: mimeType,
                content: source,
                indentString: "  "
            }
        };
        this._queue.push(new PendingFormatRequest(source, onsuccess, onerror));
        this._w.postMessage(req);
    };
    return FormatWorker;
}());
export default FormatWorker;
function findAll(str, toFind) {
    var matches = [];
    var i = str.indexOf(toFind);
    while (i !== -1) {
        matches.push(i);
        i = str.indexOf(toFind, i + toFind.length);
    }
    return matches;
}
;
function computeLineEndings(str) {
    var endings = findAll(str, '\n');
    endings.push(str.length);
    return endings;
}
function defaultComparator(a, b) {
    return a < b ? -1 : (a > b ? 1 : 0);
}
function upperBound(arr, item) {
    var l = 0;
    var r = arr.length;
    while (l < r) {
        var m = (l + r) >> 1;
        if (defaultComparator(item, arr[m]) >= 0)
            l = m + 1;
        else
            r = m;
    }
    return r;
}
var FormatterSourceMapping = /** @class */ (function () {
    function FormatterSourceMapping(_originalLineEndings, _formattedLineEndings, _mapping) {
        this._originalLineEndings = _originalLineEndings;
        this._formattedLineEndings = _formattedLineEndings;
        this._mapping = _mapping;
    }
    FormatterSourceMapping.locationToPosition = function (lineEndings, location) {
        var lineNumber = location.lineZeroIndexed;
        var columnNumber = location.columnZeroIndexed;
        var position = lineNumber ? lineEndings[lineNumber - 1] + 1 : 0;
        return position + columnNumber;
    };
    FormatterSourceMapping.positionToLocation = function (lineEndings, file, position, forOriginal) {
        var lineNumber = upperBound(lineEndings, position - 1);
        var columnNumber;
        if (!lineNumber) {
            columnNumber = position;
        }
        else {
            columnNumber = position - lineEndings[lineNumber - 1] - 1;
        }
        return new Location(file, lineNumber + 1, columnNumber + 1, forOriginal);
    };
    FormatterSourceMapping.prototype.originalToFormatted = function (location) {
        var originalPosition = FormatterSourceMapping.locationToPosition(this._originalLineEndings, location);
        var formattedPosition = this._convertPosition(this._mapping.original, this._mapping.formatted, originalPosition || 0);
        return FormatterSourceMapping.positionToLocation(this._formattedLineEndings, location.file, formattedPosition || 0, false);
    };
    FormatterSourceMapping.prototype.formattedToOriginal = function (location) {
        var formattedPosition = FormatterSourceMapping.locationToPosition(this._formattedLineEndings, location);
        var originalPosition = this._convertPosition(this._mapping.formatted, this._mapping.original, formattedPosition);
        return FormatterSourceMapping.positionToLocation(this._originalLineEndings, location.file, originalPosition || 0, true);
    };
    FormatterSourceMapping.prototype._convertPosition = function (positions1, positions2, position) {
        var index = upperBound(positions1, position) - 1;
        var convertedPosition = positions2[index] + position - positions1[index];
        if (index < positions2.length - 1 && convertedPosition > positions2[index + 1]) {
            convertedPosition = positions2[index + 1];
        }
        return convertedPosition;
    };
    return FormatterSourceMapping;
}());
export { FormatterSourceMapping };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3ZpZXdlci9mb3JtYXR0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNERBQTREO0FBQzVELEVBQUU7QUFDRixxRUFBcUU7QUFDckUseUVBQXlFO0FBQ3pFLE9BQU87QUFDUCxFQUFFO0FBQ0Ysc0VBQXNFO0FBQ3RFLGdFQUFnRTtBQUNoRSwrREFBK0Q7QUFDL0QseUVBQXlFO0FBQ3pFLGdFQUFnRTtBQUNoRSxnQkFBZ0I7QUFDaEIsNERBQTREO0FBQzVELHVFQUF1RTtBQUN2RSwyREFBMkQ7QUFDM0QsRUFBRTtBQUNGLHNFQUFzRTtBQUN0RSxvRUFBb0U7QUFDcEUsd0VBQXdFO0FBQ3hFLHVFQUF1RTtBQUN2RSx3RUFBd0U7QUFDeEUsbUVBQW1FO0FBQ25FLHdFQUF3RTtBQUN4RSx3RUFBd0U7QUFDeEUsc0VBQXNFO0FBQ3RFLHdFQUF3RTtBQUN4RSx1RUFBdUU7O0FBRXZFLHFFQUFxRTtBQUNyRSwyRUFBMkU7QUFDM0UseURBQXlEO0FBRXpELE9BQU8sUUFBUSxNQUFNLGtCQUFrQixDQUFDO0FBc0J4QztJQUNFLDhCQUNrQixRQUFnQixFQUNoQixPQUF1RixFQUN2RixLQUF5QjtRQUZ6QixhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFlBQU8sR0FBUCxPQUFPLENBQWdGO1FBQ3ZGLFVBQUssR0FBTCxLQUFLLENBQW9CO0lBQ3hDLENBQUM7SUFDTiwyQkFBQztBQUFELENBQUMsQUFORCxJQU1DO0FBRUQ7SUFRRSxzQkFBb0IsS0FBcUM7UUFBekQsaUJBeUJDO1FBMUJPLFdBQU0sR0FBMkIsRUFBRSxDQUFDO1FBRTFDLGlFQUFpRTtRQUNqRSxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksTUFBTSxDQUFDLHdEQUF3RCxDQUFDLENBQUM7UUFDL0UsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEdBQUcsVUFBQyxDQUFDO1lBQ3BCLEVBQUUsQ0FB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QyxDQUFDO1lBQy9FLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUNELE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBQ0gsNkJBQUM7QUFBRCxDQUFDLEFBL0NELElBK0NDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQgVGhlIENocm9taXVtIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vL1xuLy8gUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4vLyBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlXG4vLyBtZXQ6XG4vL1xuLy8gICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuLy8gbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuLy8gICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlXG4vLyBjb3B5cmlnaHQgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyXG4vLyBpbiB0aGUgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlXG4vLyBkaXN0cmlidXRpb24uXG4vLyAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgR29vZ2xlIEluYy4gbm9yIHRoZSBuYW1lcyBvZiBpdHNcbi8vIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tXG4vLyB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuLy9cbi8vIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlNcbi8vIFwiQVMgSVNcIiBBTkQgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1Rcbi8vIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUlxuLy8gQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFRcbi8vIE9XTkVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLFxuLy8gU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVFxuLy8gTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsXG4vLyBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTllcbi8vIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbi8vIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRVxuLy8gT0YgVEhJUyBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cblxuLy8gVGhpcyBmaWxlIGNvbnRhaW5zIHdyYXBwZXJzIGFyb3VuZCB0aGUgQ2hyb21pdW0gRGV2ZWxvcG1lbnQgVG9vbCdzXG4vLyBKYXZhU2NyaXB0IHNvdXJjZSBjb2RlIGZvcm1hdHRlci4gVGhlc2Ugd3JhcHBlcnMgd2VyZSBtYW51YWxseSBjb252ZXJ0ZWRcbi8vIHRvIFR5cGVTY3JpcHQgYW5kIHNpbXBsaWZpZWQgZnJvbSB0aGUgb3JpZ2luYWwgc291cmNlLlxuXG5pbXBvcnQgTG9jYXRpb24gZnJvbSAnLi9tb2RlbC9sb2NhdGlvbic7XG5pbXBvcnQgU291cmNlRmlsZSBmcm9tICcuL21vZGVsL3NvdXJjZV9maWxlJztcblxuaW50ZXJmYWNlIEZvcm1hdFJlcXVlc3Qge1xuICBtZXRob2Q6IFwiZm9ybWF0XCIsXG4gIHBhcmFtczoge1xuICAgIG1pbWVUeXBlOiBcInRleHQvamF2YXNjcmlwdFwiIHwgXCJ0ZXh0L2h0bWxcIixcbiAgICBjb250ZW50OiBzdHJpbmc7XG4gICAgaW5kZW50U3RyaW5nOiBzdHJpbmc7XG4gIH1cbn1cblxuaW50ZXJmYWNlIEZvcm1hdFJlc3BvbnNlIHtcbiAgY29udGVudDogc3RyaW5nO1xuICBtYXBwaW5nOiBGb3JtYXRNYXBwaW5nO1xufVxuXG5pbnRlcmZhY2UgRm9ybWF0TWFwcGluZyB7XG4gIGZvcm1hdHRlZDogbnVtYmVyW107XG4gIG9yaWdpbmFsOiBudW1iZXJbXTtcbn1cblxuY2xhc3MgUGVuZGluZ0Zvcm1hdFJlcXVlc3Qge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgb3JpZ2luYWw6IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgc3VjY2VzczogKG9yaWdpbmFsOiBzdHJpbmcsIGZvcm1hdHRlZDogc3RyaW5nLCBtYXBwaW5nOiBGb3JtYXR0ZXJTb3VyY2VNYXBwaW5nKSA9PiB2b2lkLFxuICAgIHB1YmxpYyByZWFkb25seSBlcnJvcjogKGU6IEVycm9yKSA9PiB2b2lkXG4gICkge31cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRm9ybWF0V29ya2VyIHtcbiAgcHVibGljIHN0YXRpYyBhc3luYyBDcmVhdGUoKTogUHJvbWlzZTxGb3JtYXRXb3JrZXI+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8Rm9ybWF0V29ya2VyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBuZXcgRm9ybWF0V29ya2VyKHJlc29sdmUpO1xuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgX3c6IFdvcmtlcjtcbiAgcHJpdmF0ZSBfcXVldWU6IFBlbmRpbmdGb3JtYXRSZXF1ZXN0W10gPSBbXTtcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihyZWFkeTogKHdvcmtlcjogRm9ybWF0V29ya2VyKSA9PiB2b2lkKSB7XG4gICAgLy8gVXNlIHRoZSBvcmlnaW5hbCwgdW5tb2RpZmllZCB3b3JrZXIgY29kZSBmcm9tIENocm9tZSBkZXZ0b29scy5cbiAgICB0aGlzLl93ID0gbmV3IFdvcmtlcihcImNocm9tZS1kZXZ0b29scy1mcm9udGVuZC9mcm9udF9lbmQvZm9ybWF0dGVyX3dvcmtlci5qc1wiKTtcbiAgICB0aGlzLl93Lm9ubWVzc2FnZSA9IChlKSA9PiB7XG4gICAgICBpZiAoZS5kYXRhID09PSBcIndvcmtlclJlYWR5XCIpIHtcbiAgICAgICAgcmV0dXJuIHJlYWR5KHRoaXMpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX3F1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgZDogRm9ybWF0UmVzcG9uc2UgPSBlLmRhdGE7XG4gICAgICAgIGNvbnN0IGkgPSB0aGlzLl9xdWV1ZS5zaGlmdCgpO1xuICAgICAgICBjb25zdCBvZ0xlID0gY29tcHV0ZUxpbmVFbmRpbmdzKGkub3JpZ2luYWwpO1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWRMZSA9IGNvbXB1dGVMaW5lRW5kaW5ncyhkLmNvbnRlbnQpO1xuICAgICAgICBpLnN1Y2Nlc3MoaS5vcmlnaW5hbCwgZC5jb250ZW50LCBuZXcgRm9ybWF0dGVyU291cmNlTWFwcGluZyhvZ0xlLCBmb3JtYXR0ZWRMZSwgZC5tYXBwaW5nKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBSZWNlaXZlZCB1bnNvbGljaXRlZCBtZXNzYWdlIGZyb20gRm9ybWF0V29ya2VyOiAke2UuZGF0YX1gKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuX3cub25lcnJvciA9IChlKSA9PiB7XG4gICAgICBpZiAodGhpcy5fcXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBpID0gdGhpcy5fcXVldWUuc2hpZnQoKTtcbiAgICAgICAgaS5lcnJvcihlLmVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFJlY2VpdmVkIHVuY2F1Z2h0IGVycm9yIGluIEZvcm1hdFdvcmtlcjogJHtlLmVycm9yfWApO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZm9ybWF0KHNvdXJjZTogc3RyaW5nLCBtaW1lVHlwZTogXCJ0ZXh0L2phdmFzY3JpcHRcIiB8IFwidGV4dC9odG1sXCIsIG9uc3VjY2VzczogKG9yaWdpbmFsOiBzdHJpbmcsIGZvcm1hdHRlZDogc3RyaW5nLCBtYXBwaW5nOiBGb3JtYXR0ZXJTb3VyY2VNYXBwaW5nKSA9PiB2b2lkLCBvbmVycm9yOiAoZTogRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBjb25zdCByZXE6IEZvcm1hdFJlcXVlc3QgPSB7XG4gICAgICBtZXRob2Q6IFwiZm9ybWF0XCIsXG4gICAgICBwYXJhbXM6IHtcbiAgICAgICAgbWltZVR5cGU6IG1pbWVUeXBlLFxuICAgICAgICBjb250ZW50OiBzb3VyY2UsXG4gICAgICAgIGluZGVudFN0cmluZzogXCIgIFwiXG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLl9xdWV1ZS5wdXNoKG5ldyBQZW5kaW5nRm9ybWF0UmVxdWVzdChzb3VyY2UsIG9uc3VjY2Vzcywgb25lcnJvcikpO1xuICAgIHRoaXMuX3cucG9zdE1lc3NhZ2UocmVxKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBmaW5kQWxsKHN0cjogc3RyaW5nLCB0b0ZpbmQ6IHN0cmluZyk6IG51bWJlcltdIHtcbiAgdmFyIG1hdGNoZXMgPSBbXTtcbiAgdmFyIGkgPSBzdHIuaW5kZXhPZih0b0ZpbmQpO1xuICB3aGlsZSAoaSAhPT0gLTEpIHtcbiAgICBtYXRjaGVzLnB1c2goaSk7XG4gICAgaSA9IHN0ci5pbmRleE9mKHRvRmluZCwgaSArIHRvRmluZC5sZW5ndGgpO1xuICB9XG4gIHJldHVybiBtYXRjaGVzO1xufTtcblxuZnVuY3Rpb24gY29tcHV0ZUxpbmVFbmRpbmdzKHN0cjogc3RyaW5nKTogbnVtYmVyW10ge1xuICBjb25zdCBlbmRpbmdzID0gZmluZEFsbChzdHIsICdcXG4nKTtcbiAgZW5kaW5ncy5wdXNoKHN0ci5sZW5ndGgpO1xuICByZXR1cm4gZW5kaW5ncztcbn1cblxuZnVuY3Rpb24gZGVmYXVsdENvbXBhcmF0b3IoYTogbnVtYmVyLCBiOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gYSA8IGIgPyAtMSA6IChhID4gYiA/IDEgOiAwKTtcbn1cblxuZnVuY3Rpb24gdXBwZXJCb3VuZChhcnI6IG51bWJlcltdLCBpdGVtOiBudW1iZXIpIHtcbiAgdmFyIGwgPSAwO1xuICB2YXIgciA9IGFyci5sZW5ndGg7XG4gIHdoaWxlIChsIDwgcikge1xuICAgIHZhciBtID0gKGwgKyByKSA+PiAxO1xuICAgIGlmIChkZWZhdWx0Q29tcGFyYXRvcihpdGVtLCBhcnJbbV0pID49IDApXG4gICAgICBsID0gbSArIDE7XG4gICAgZWxzZVxuICAgICAgciA9IG07XG4gIH1cbiAgcmV0dXJuIHI7XG59XG5cbmV4cG9ydCBjbGFzcyBGb3JtYXR0ZXJTb3VyY2VNYXBwaW5nIHtcbiAgcHVibGljIHN0YXRpYyBsb2NhdGlvblRvUG9zaXRpb24obGluZUVuZGluZ3M6IG51bWJlcltdLCBsb2NhdGlvbjogTG9jYXRpb24pOiBudW1iZXIge1xuICAgIGNvbnN0IGxpbmVOdW1iZXIgPSBsb2NhdGlvbi5saW5lWmVyb0luZGV4ZWQ7XG4gICAgY29uc3QgY29sdW1uTnVtYmVyID0gbG9jYXRpb24uY29sdW1uWmVyb0luZGV4ZWQ7XG4gICAgY29uc3QgcG9zaXRpb24gPSBsaW5lTnVtYmVyID8gbGluZUVuZGluZ3NbbGluZU51bWJlciAtIDFdICsgMSA6IDA7XG4gICAgcmV0dXJuIHBvc2l0aW9uICsgY29sdW1uTnVtYmVyO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBwb3NpdGlvblRvTG9jYXRpb24obGluZUVuZGluZ3M6IG51bWJlcltdLCBmaWxlOiBTb3VyY2VGaWxlLCBwb3NpdGlvbjogbnVtYmVyLCBmb3JPcmlnaW5hbDogYm9vbGVhbik6IExvY2F0aW9uIHtcbiAgICBjb25zdCBsaW5lTnVtYmVyID0gdXBwZXJCb3VuZChsaW5lRW5kaW5ncywgcG9zaXRpb24gLSAxKTtcbiAgICBsZXQgY29sdW1uTnVtYmVyOiBudW1iZXI7XG4gICAgaWYgKCFsaW5lTnVtYmVyKSB7XG4gICAgICBjb2x1bW5OdW1iZXIgPSBwb3NpdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29sdW1uTnVtYmVyID0gcG9zaXRpb24gLSBsaW5lRW5kaW5nc1tsaW5lTnVtYmVyIC0gMV0gLSAxO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IExvY2F0aW9uKGZpbGUsIGxpbmVOdW1iZXIgKyAxLCBjb2x1bW5OdW1iZXIgKyAxLCBmb3JPcmlnaW5hbCk7XG4gIH1cblxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX29yaWdpbmFsTGluZUVuZGluZ3M6IG51bWJlcltdLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2Zvcm1hdHRlZExpbmVFbmRpbmdzOiBudW1iZXJbXSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9tYXBwaW5nOiBGb3JtYXRNYXBwaW5nKSB7fVxuXG4gIHB1YmxpYyBvcmlnaW5hbFRvRm9ybWF0dGVkKGxvY2F0aW9uOiBMb2NhdGlvbik6IExvY2F0aW9uIHtcbiAgICBjb25zdCBvcmlnaW5hbFBvc2l0aW9uID1cbiAgICAgIEZvcm1hdHRlclNvdXJjZU1hcHBpbmcubG9jYXRpb25Ub1Bvc2l0aW9uKHRoaXMuX29yaWdpbmFsTGluZUVuZGluZ3MsIGxvY2F0aW9uKTtcbiAgICBjb25zdCBmb3JtYXR0ZWRQb3NpdGlvbiA9XG4gICAgICAgIHRoaXMuX2NvbnZlcnRQb3NpdGlvbih0aGlzLl9tYXBwaW5nLm9yaWdpbmFsLCB0aGlzLl9tYXBwaW5nLmZvcm1hdHRlZCwgb3JpZ2luYWxQb3NpdGlvbiB8fCAwKTtcbiAgICByZXR1cm4gRm9ybWF0dGVyU291cmNlTWFwcGluZy5wb3NpdGlvblRvTG9jYXRpb24odGhpcy5fZm9ybWF0dGVkTGluZUVuZGluZ3MsIGxvY2F0aW9uLmZpbGUsIGZvcm1hdHRlZFBvc2l0aW9uIHx8IDAsIGZhbHNlKTtcbiAgfVxuXG4gIHB1YmxpYyBmb3JtYXR0ZWRUb09yaWdpbmFsKGxvY2F0aW9uOiBMb2NhdGlvbik6IExvY2F0aW9uIHtcbiAgICBjb25zdCBmb3JtYXR0ZWRQb3NpdGlvbiA9XG4gICAgICBGb3JtYXR0ZXJTb3VyY2VNYXBwaW5nLmxvY2F0aW9uVG9Qb3NpdGlvbih0aGlzLl9mb3JtYXR0ZWRMaW5lRW5kaW5ncywgbG9jYXRpb24pO1xuICAgIGNvbnN0IG9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLl9jb252ZXJ0UG9zaXRpb24odGhpcy5fbWFwcGluZy5mb3JtYXR0ZWQsIHRoaXMuX21hcHBpbmcub3JpZ2luYWwsIGZvcm1hdHRlZFBvc2l0aW9uKTtcbiAgICByZXR1cm4gRm9ybWF0dGVyU291cmNlTWFwcGluZy5wb3NpdGlvblRvTG9jYXRpb24odGhpcy5fb3JpZ2luYWxMaW5lRW5kaW5ncywgbG9jYXRpb24uZmlsZSwgb3JpZ2luYWxQb3NpdGlvbiB8fCAwLCB0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NvbnZlcnRQb3NpdGlvbihwb3NpdGlvbnMxOiBudW1iZXJbXSwgcG9zaXRpb25zMjogbnVtYmVyW10sIHBvc2l0aW9uOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IGluZGV4ID0gdXBwZXJCb3VuZChwb3NpdGlvbnMxLCBwb3NpdGlvbikgLSAxO1xuICAgIGxldCBjb252ZXJ0ZWRQb3NpdGlvbiA9IHBvc2l0aW9uczJbaW5kZXhdICsgcG9zaXRpb24gLSBwb3NpdGlvbnMxW2luZGV4XTtcbiAgICBpZiAoaW5kZXggPCBwb3NpdGlvbnMyLmxlbmd0aCAtIDEgJiYgY29udmVydGVkUG9zaXRpb24gPiBwb3NpdGlvbnMyW2luZGV4ICsgMV0pIHtcbiAgICAgIGNvbnZlcnRlZFBvc2l0aW9uID0gcG9zaXRpb25zMltpbmRleCArIDFdO1xuICAgIH1cbiAgICByZXR1cm4gY29udmVydGVkUG9zaXRpb247XG4gIH1cbn0iXX0=