import { SourceMapConsumer } from 'source-map';
import { parse as ErrorStackParser } from 'error-stack-parser';
import { DEFAULT_AGENT_URL } from './mitmproxy_interceptor';
import { resolve as resolveURL } from 'url';
var magicString = '//# sourceMappingURL=data:application/json;base64,';
/**
 * Converts stack frames to get the position in the original source document.
 * Strips any frames from the given agent string.
 */
var StackFrameConverter = /** @class */ (function () {
    function StackFrameConverter(_results) {
        this._results = _results;
        this._maps = new Map();
    }
    /**
     * Converts the raw stack frames from the BLeak-instrumented source code of the application to the
     * application's original source code.
     *
     * Stores relevant StackFrame / source file data into the `results` object, and returns the stack frames
     * in results format.
     * @param proxy
     * @param pageUrl
     * @param results
     * @param traces
     * @param agentUrl
     */
    StackFrameConverter.ConvertGrowthStacks = function (proxy, pageUrl, results, traces, agentUrl) {
        if (agentUrl === void 0) { agentUrl = DEFAULT_AGENT_URL; }
        return new StackFrameConverter(results).convertGrowthStacks(proxy, pageUrl, traces, agentUrl);
    };
    StackFrameConverter.prototype._fetchMap = function (proxy, url) {
        if (typeof (url) !== "string") {
            return;
        }
        var map = this._maps.get(url);
        if (!map) {
            try {
                var stashedItem = proxy.getFromStash(url);
                var source = stashedItem.data.toString();
                var sourceMapOffset = source.lastIndexOf(magicString);
                if (sourceMapOffset > -1) {
                    sourceMapOffset += magicString.length;
                    var sourceMapBase64 = source.slice(sourceMapOffset);
                    var sourceMapString = new Buffer(sourceMapBase64, 'base64').toString('utf8');
                    var sourceMap = JSON.parse(sourceMapString);
                    var consumer = new SourceMapConsumer(sourceMap);
                    this._maps.set(url, consumer);
                    if (sourceMap.sourcesContent && sourceMap.sourcesContent.length > 0) {
                        var len = sourceMap.sourcesContent.length;
                        for (var i = 0; i < len; i++) {
                            this._results.addSourceFile(url, stashedItem.isJavaScript ? "text/javascript" : "text/html", sourceMap.sourcesContent[i]);
                        }
                    }
                }
                else {
                    this._results.addSourceFile(url, stashedItem.isJavaScript ? "text/javascript" : "text/html", source);
                }
            }
            catch (e) {
                // Failed to get map.
                console.error("Failed to get source map for " + url + ":");
                console.error(e);
            }
        }
    };
    StackFrameConverter.prototype.convertGrowthStacks = function (proxy, pageUrl, traces, agentUrl) {
        var _this = this;
        // First pass: Get all unique URLs and their source maps.
        var urls = new Set();
        var rawStacks = new Map();
        function frameFilter(f) {
            return (!f.fileName || f.fileName.indexOf(agentUrl) === -1) && (!f.functionName || (f.functionName.indexOf("eval") === -1 && f.functionName.indexOf(agentUrl) === -1));
        }
        function processFrame(f) {
            if (f.fileName && !f.fileName.toLowerCase().startsWith("http")) {
                f.fileName = resolveURL(pageUrl, f.fileName);
            }
            urls.add(f.fileName);
        }
        function processStack(s) {
            if (!rawStacks.has(s)) {
                var frames_1 = ErrorStackParser({ stack: s }).filter(frameFilter);
                frames_1.forEach(processFrame);
                rawStacks.set(s, frames_1);
            }
        }
        // Step 1: Collect all URLs.
        Object.keys(traces).forEach(function (stringId) {
            var id = parseInt(stringId, 10);
            traces[id].forEach(processStack);
        });
        // Step 2: Get files, parse source maps.
        urls.forEach(function (url) {
            _this._fetchMap(proxy, url);
        });
        // Step 3: Convert stacks.
        var convertedStacks = new Map();
        rawStacks.forEach(function (stack, k) {
            convertedStacks.set(k, _this._convertStack(stack));
        });
        // Step 4: Map stacks back into the return object.
        function mapStack(s) {
            return convertedStacks.get(s);
        }
        var rv = {};
        Object.keys(traces).forEach(function (stringId) {
            var id = parseInt(stringId, 10);
            rv[id] = traces[id].map(mapStack);
        });
        return rv;
    };
    StackFrameConverter.prototype._convertStack = function (stack) {
        var _this = this;
        return stack.map(function (frame) { return _this._convertStackFrame(frame); });
    };
    StackFrameConverter.prototype._convertStackFrame = function (frame) {
        var map = this._maps.get(frame.fileName);
        if (!map) {
            return this._results.addStackFrameFromObject(frame);
        }
        var ogPos = map.originalPositionFor({
            line: frame.lineNumber,
            column: frame.columnNumber
        });
        frame.lineNumber = ogPos.line;
        frame.columnNumber = ogPos.column;
        return this._results.addStackFrameFromObject(frame);
    };
    return StackFrameConverter;
}());
export default StackFrameConverter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfZnJhbWVfY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9zdGFja19mcmFtZV9jb252ZXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGlCQUFpQixFQUFlLE1BQU0sWUFBWSxDQUFDO0FBQzNELE9BQU8sRUFBYSxLQUFLLElBQUksZ0JBQWdCLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RSxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUMxRCxPQUFPLEVBQUMsT0FBTyxJQUFJLFVBQVUsRUFBQyxNQUFNLEtBQUssQ0FBQztBQUsxQyxJQUFNLFdBQVcsR0FBRyxvREFBb0QsQ0FBQztBQUV6RTs7O0dBR0c7QUFDSDtJQW1CRSw2QkFDVSxRQUFzQjtRQUF0QixhQUFRLEdBQVIsUUFBUSxDQUFjO1FBbkJ4QixVQUFLLEdBQUcsSUFBSSxHQUFHLEVBQTZCLENBQUM7SUFvQmxELENBQUM7SUFsQko7Ozs7Ozs7Ozs7O09BV0c7SUFDVyx1Q0FBbUIsR0FBakMsVUFBa0MsS0FBZ0IsRUFBRSxPQUFlLEVBQUUsT0FBcUIsRUFBRSxNQUEwQixFQUFFLFFBQW9DO1FBQXBDLHlCQUFBLEVBQUEsNEJBQW9DO1FBQzFKLE1BQU0sQ0FBQyxJQUFJLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7SUFNTyx1Q0FBUyxHQUFqQixVQUFrQixLQUFnQixFQUFFLEdBQVc7UUFDN0MsRUFBRSxDQUFDLENBQUMsT0FBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDN0IsTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUNELElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdB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RyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0RCxDQUFDO1FBQ0QsSUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLG1CQUFtQixDQUFDO1lBQ3BDLElBQUksRUFBRSxLQUFLLENBQUMsVUFBVTtZQUN0QixNQUFNLEVBQUUsS0FBSyxDQUFDLFlBQVk7U0FDM0IsQ0FBQyxDQUFDO1FBQ0gsS0FBSyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQzlCLEtBQUssQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNsQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBQ0gsMEJBQUM7QUFBRCxDQUFDLEFBN0hELElBNkhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtTb3VyY2VNYXBDb25zdW1lciwgUmF3U291cmNlTWFwfSBmcm9tICdzb3VyY2UtbWFwJztcbmltcG9ydCB7U3RhY2tGcmFtZSwgcGFyc2UgYXMgRXJyb3JTdGFja1BhcnNlcn0gZnJvbSAnZXJyb3Itc3RhY2stcGFyc2VyJztcbmltcG9ydCB7REVGQVVMVF9BR0VOVF9VUkx9IGZyb20gJy4vbWl0bXByb3h5X2ludGVyY2VwdG9yJztcbmltcG9ydCB7cmVzb2x2ZSBhcyByZXNvbHZlVVJMfSBmcm9tICd1cmwnO1xuaW1wb3J0IEJMZWFrUmVzdWx0cyBmcm9tICcuL2JsZWFrX3Jlc3VsdHMnO1xuaW1wb3J0IHtJU3RhY2t9IGZyb20gJy4uL2NvbW1vbi9pbnRlcmZhY2VzJztcbmltcG9ydCBNSVRNUHJveHkgZnJvbSAnbWl0bXByb3h5JztcblxuY29uc3QgbWFnaWNTdHJpbmcgPSAnLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvbi9qc29uO2Jhc2U2NCwnO1xuXG4vKipcbiAqIENvbnZlcnRzIHN0YWNrIGZyYW1lcyB0byBnZXQgdGhlIHBvc2l0aW9uIGluIHRoZSBvcmlnaW5hbCBzb3VyY2UgZG9jdW1lbnQuXG4gKiBTdHJpcHMgYW55IGZyYW1lcyBmcm9tIHRoZSBnaXZlbiBhZ2VudCBzdHJpbmcuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFN0YWNrRnJhbWVDb252ZXJ0ZXIge1xuICBwcml2YXRlIF9tYXBzID0gbmV3IE1hcDxzdHJpbmcsIFNvdXJjZU1hcENvbnN1bWVyPigpO1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgcmF3IHN0YWNrIGZyYW1lcyBmcm9tIHRoZSBCTGVhay1pbnN0cnVtZW50ZWQgc291cmNlIGNvZGUgb2YgdGhlIGFwcGxpY2F0aW9uIHRvIHRoZVxuICAgKiBhcHBsaWNhdGlvbidzIG9yaWdpbmFsIHNvdXJjZSBjb2RlLlxuICAgKlxuICAgKiBTdG9yZXMgcmVsZXZhbnQgU3RhY2tGcmFtZSAvIHNvdXJjZSBmaWxlIGRhdGEgaW50byB0aGUgYHJlc3VsdHNgIG9iamVjdCwgYW5kIHJldHVybnMgdGhlIHN0YWNrIGZyYW1lc1xuICAgKiBpbiByZXN1bHRzIGZvcm1hdC5cbiAgICogQHBhcmFtIHByb3h5XG4gICAqIEBwYXJhbSBwYWdlVXJsXG4gICAqIEBwYXJhbSByZXN1bHRzXG4gICAqIEBwYXJhbSB0cmFjZXNcbiAgICogQHBhcmFtIGFnZW50VXJsXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIENvbnZlcnRHcm93dGhTdGFja3MocHJveHk6IE1JVE1Qcm94eSwgcGFnZVVybDogc3RyaW5nLCByZXN1bHRzOiBCTGVha1Jlc3VsdHMsIHRyYWNlczogR3Jvd2luZ1N0YWNrVHJhY2VzLCBhZ2VudFVybDogc3RyaW5nID0gREVGQVVMVF9BR0VOVF9VUkwpOiB7W2lkOiBudW1iZXJdOiBJU3RhY2tbXX0ge1xuICAgIHJldHVybiBuZXcgU3RhY2tGcmFtZUNvbnZlcnRlcihyZXN1bHRzKS5jb252ZXJ0R3Jvd3RoU3RhY2tzKHByb3h5LCBwYWdlVXJsLCB0cmFjZXMsIGFnZW50VXJsKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX3Jlc3VsdHM6IEJMZWFrUmVzdWx0c1xuICApIHt9XG5cbiAgcHJpdmF0ZSBfZmV0Y2hNYXAocHJveHk6IE1JVE1Qcm94eSwgdXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodHlwZW9mKHVybCkgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IG1hcCA9IHRoaXMuX21hcHMuZ2V0KHVybCk7XG4gICAgaWYgKCFtYXApIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHN0YXNoZWRJdGVtID0gcHJveHkuZ2V0RnJvbVN0YXNoKHVybCk7XG4gICAgICAgIGNvbnN0IHNvdXJjZSA9IHN0YXNoZWRJdGVtLmRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgbGV0IHNvdXJjZU1hcE9mZnNldCA9IHNvdXJjZS5sYXN0SW5kZXhPZihtYWdpY1N0cmluZylcbiAgICAgICAgaWYgKHNvdXJjZU1hcE9mZnNldCA+IC0xKSB7XG4gICAgICAgICAgc291cmNlTWFwT2Zmc2V0ICs9IG1hZ2ljU3RyaW5nLmxlbmd0aDtcbiAgICAgICAgICBjb25zdCBzb3VyY2VNYXBCYXNlNjQgPSBzb3VyY2Uuc2xpY2Uoc291cmNlTWFwT2Zmc2V0KTtcbiAgICAgICAgICBjb25zdCBzb3VyY2VNYXBTdHJpbmcgPSBuZXcgQnVmZmVyKHNvdXJjZU1hcEJhc2U2NCwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gICAgICAgICAgY29uc3Qgc291cmNlTWFwOiBSYXdTb3VyY2VNYXAgPSBKU09OLnBhcnNlKHNvdXJjZU1hcFN0cmluZyk7XG4gICAgICAgICAgY29uc3QgY29uc3VtZXIgPSBuZXcgU291cmNlTWFwQ29uc3VtZXIoc291cmNlTWFwKTtcbiAgICAgICAgICB0aGlzLl9tYXBzLnNldCh1cmwsIGNvbnN1bWVyKTtcbiAgICAgICAgICBpZiAoc291cmNlTWFwLnNvdXJjZXNDb250ZW50ICYmIHNvdXJjZU1hcC5zb3VyY2VzQ29udGVudC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBsZW4gPSBzb3VyY2VNYXAuc291cmNlc0NvbnRlbnQubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgICB0aGlzLl9yZXN1bHRzLmFkZFNvdXJjZUZpbGUodXJsLCBzdGFzaGVkSXRlbS5pc0phdmFTY3JpcHQgPyBcInRleHQvamF2YXNjcmlwdFwiIDogXCJ0ZXh0L2h0bWxcIiwgc291cmNlTWFwLnNvdXJjZXNDb250ZW50W2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fcmVzdWx0cy5hZGRTb3VyY2VGaWxlKHVybCwgc3Rhc2hlZEl0ZW0uaXNKYXZhU2NyaXB0ID8gXCJ0ZXh0L2phdmFzY3JpcHRcIiA6IFwidGV4dC9odG1sXCIsIHNvdXJjZSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gRmFpbGVkIHRvIGdldCBtYXAuXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBnZXQgc291cmNlIG1hcCBmb3IgJHt1cmx9OmApO1xuICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjb252ZXJ0R3Jvd3RoU3RhY2tzKHByb3h5OiBNSVRNUHJveHksIHBhZ2VVcmw6IHN0cmluZywgdHJhY2VzOiBHcm93aW5nU3RhY2tUcmFjZXMsIGFnZW50VXJsOiBzdHJpbmcpOiB7W2lkOiBudW1iZXJdOiBJU3RhY2tbXX0ge1xuICAgIC8vIEZpcnN0IHBhc3M6IEdldCBhbGwgdW5pcXVlIFVSTHMgYW5kIHRoZWlyIHNvdXJjZSBtYXBzLlxuICAgIGNvbnN0IHVybHMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCByYXdTdGFja3MgPSBuZXcgTWFwPHN0cmluZywgU3RhY2tGcmFtZVtdPigpO1xuXG4gICAgZnVuY3Rpb24gZnJhbWVGaWx0ZXIoZjogU3RhY2tGcmFtZSk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuICghZi5maWxlTmFtZSB8fCBmLmZpbGVOYW1lLmluZGV4T2YoYWdlbnRVcmwpID09PSAtMSkgJiYgKCFmLmZ1bmN0aW9uTmFtZSB8fCAoZi5mdW5jdGlvbk5hbWUuaW5kZXhPZihcImV2YWxcIikgPT09IC0xICYmIGYuZnVuY3Rpb25OYW1lLmluZGV4T2YoYWdlbnRVcmwpID09PSAtMSkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHByb2Nlc3NGcmFtZShmOiBTdGFja0ZyYW1lKSB7XG4gICAgICBpZiAoZi5maWxlTmFtZSAmJiAhZi5maWxlTmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJodHRwXCIpKSB7XG4gICAgICAgIGYuZmlsZU5hbWUgPSByZXNvbHZlVVJMKHBhZ2VVcmwsIGYuZmlsZU5hbWUpO1xuICAgICAgfVxuICAgICAgdXJscy5hZGQoZi5maWxlTmFtZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcHJvY2Vzc1N0YWNrKHM6IHN0cmluZyk6IHZvaWQge1xuICAgICAgaWYgKCFyYXdTdGFja3MuaGFzKHMpKSB7XG4gICAgICAgIGNvbnN0IGZyYW1lcyA9IEVycm9yU3RhY2tQYXJzZXIoPGFueT4ge3N0YWNrOiBzfSkuZmlsdGVyKGZyYW1lRmlsdGVyKTtcbiAgICAgICAgZnJhbWVzLmZvckVhY2gocHJvY2Vzc0ZyYW1lKTtcbiAgICAgICAgcmF3U3RhY2tzLnNldChzLCBmcmFtZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFN0ZXAgMTogQ29sbGVjdCBhbGwgVVJMcy5cbiAgICBPYmplY3Qua2V5cyh0cmFjZXMpLmZvckVhY2goKHN0cmluZ0lkKSA9PiB7XG4gICAgICBjb25zdCBpZCA9IHBhcnNlSW50KHN0cmluZ0lkLCAxMCk7XG4gICAgICB0cmFjZXNbaWRdLmZvckVhY2gocHJvY2Vzc1N0YWNrKTtcbiAgICB9KTtcbiAgICAvLyBTdGVwIDI6IEdldCBmaWxlcywgcGFyc2Ugc291cmNlIG1hcHMuXG4gICAgdXJscy5mb3JFYWNoKCh1cmwpID0+IHtcbiAgICAgIHRoaXMuX2ZldGNoTWFwKHByb3h5LCB1cmwpO1xuICAgIH0pO1xuICAgIC8vIFN0ZXAgMzogQ29udmVydCBzdGFja3MuXG4gICAgY29uc3QgY29udmVydGVkU3RhY2tzID0gbmV3IE1hcDxzdHJpbmcsIElTdGFjaz4oKTtcbiAgICByYXdTdGFja3MuZm9yRWFjaCgoc3RhY2ssIGspID0+IHtcbiAgICAgIGNvbnZlcnRlZFN0YWNrcy5zZXQoaywgdGhpcy5fY29udmVydFN0YWNrKHN0YWNrKSk7XG4gICAgfSk7XG4gICAgLy8gU3RlcCA0OiBNYXAgc3RhY2tzIGJhY2sgaW50byB0aGUgcmV0dXJuIG9iamVjdC5cbiAgICBmdW5jdGlvbiBtYXBTdGFjayhzOiBzdHJpbmcpOiBJU3RhY2sge1xuICAgICAgcmV0dXJuIGNvbnZlcnRlZFN0YWNrcy5nZXQocyk7XG4gICAgfVxuICAgIGNvbnN0IHJ2OiB7W2lkOiBudW1iZXJdOiBJU3RhY2tbXX0gPSB7fTtcbiAgICBPYmplY3Qua2V5cyh0cmFjZXMpLmZvckVhY2goKHN0cmluZ0lkKSA9PiB7XG4gICAgICBjb25zdCBpZCA9IHBhcnNlSW50KHN0cmluZ0lkLCAxMCk7XG4gICAgICBydltpZF0gPSB0cmFjZXNbaWRdLm1hcChtYXBTdGFjayk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcnY7XG4gIH1cblxuICBwcml2YXRlIF9jb252ZXJ0U3RhY2soc3RhY2s6IFN0YWNrRnJhbWVbXSk6IElTdGFjayB7XG4gICAgcmV0dXJuIHN0YWNrLm1hcCgoZnJhbWUpID0+IHRoaXMuX2NvbnZlcnRTdGFja0ZyYW1lKGZyYW1lKSk7XG4gIH1cblxuICBwcml2YXRlIF9jb252ZXJ0U3RhY2tGcmFtZShmcmFtZTogU3RhY2tGcmFtZSk6IG51bWJlciB7XG4gICAgY29uc3QgbWFwID0gdGhpcy5fbWFwcy5nZXQoZnJhbWUuZmlsZU5hbWUpO1xuICAgIGlmICghbWFwKSB7XG4gICAgICByZXR1cm4gdGhpcy5fcmVzdWx0cy5hZGRTdGFja0ZyYW1lRnJvbU9iamVjdChmcmFtZSk7XG4gICAgfVxuICAgIGNvbnN0IG9nUG9zID0gbWFwLm9yaWdpbmFsUG9zaXRpb25Gb3Ioe1xuICAgICAgbGluZTogZnJhbWUubGluZU51bWJlcixcbiAgICAgIGNvbHVtbjogZnJhbWUuY29sdW1uTnVtYmVyXG4gICAgfSk7XG4gICAgZnJhbWUubGluZU51bWJlciA9IG9nUG9zLmxpbmU7XG4gICAgZnJhbWUuY29sdW1uTnVtYmVyID0gb2dQb3MuY29sdW1uO1xuICAgIHJldHVybiB0aGlzLl9yZXN1bHRzLmFkZFN0YWNrRnJhbWVGcm9tT2JqZWN0KGZyYW1lKTtcbiAgfVxufSJdfQ==