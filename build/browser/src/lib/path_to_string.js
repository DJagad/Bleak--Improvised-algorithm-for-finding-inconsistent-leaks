var r = /'/g;
/**
 * Escapes single quotes in the given string.
 * @param s
 */
function safeString(s) {
    return s.replace(r, "\\'");
}
// From https://stackoverflow.com/a/2008444
// This is not *perfect*, but it's good enough for human output.
var JS_IDENTIFIER_REGEXP = /^[_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*$/;
/**
 * Returns true if the property definitely requires array notation.
 * This check is not sound, as we do not check for JavaScript reserved
 * words. However, it is 'good enough' for human output, e.g. in a report.
 * @param prop
 */
function propertyNeedsArrayNotation(prop) {
    return !JS_IDENTIFIER_REGEXP.test("" + prop);
}
function propertyAccessString(s) {
    if (typeof (s) === "number") {
        return "[" + s + "]";
    }
    else if (propertyNeedsArrayNotation(s)) {
        return "[\"" + safeString(s) + "\"]";
    }
    else {
        return "." + s;
    }
}
function prettyPrintDOMPath() {
    while (PS.nonempty()) {
        var segment = PS.pop();
        var name_1 = segment.indexOrName;
        if (name_1 === "root") {
            // Ignore this BLeak-inserted edge.
            // We're transitioning to a path outside of the DOM, on the DOM object itself.
            prettyPrintNonDOMPath();
        }
        else if (name_1 === 'childNodes') {
            PS.print(propertyAccessString(name_1));
        }
        else {
            // $$$CHILD$$$n => n
            var idx = parseInt(name_1.slice(11), 10);
            // Should alternate between 'childNode' and indices until it gets to 'root'.
            PS.print(propertyAccessString(idx));
        }
    }
}
function prettyPrintNonDOMPath() {
    while (PS.nonempty()) {
        var segment = PS.pop();
        switch (segment.type) {
            case 5 /* EVENT_LISTENER_LIST */: {
                // Will either be:
                // - A leak on the list itself.
                // - A leak *within* an event listener.
                // Seek forward to figure out which, and print appropriately
                // $$listeners.type[index].listener
                var typeSegment = PS.pop();
                if (!PS.nonempty()) {
                    // List leak
                    PS.pushString();
                    PS.print("List of '" + typeSegment.indexOrName + "' listeners on");
                    PS.pushString();
                }
                else {
                    var indexSegment = PS.pop();
                    PS.pop(); // Should be the '.listener' property, unless the application mucked with our metadata.
                    PS.pushString();
                    PS.print("on listener " + indexSegment.indexOrName + " in the list of '" + typeSegment.indexOrName + "' listeners on");
                    PS.pushString();
                }
                break;
            }
            case 3 /* CLOSURE */:
                PS.pushString();
                PS.print("within closure of");
                PS.pushString();
                break;
            case 4 /* CLOSURE_VARIABLE */:
                // Should've been preceded by CLOSURE.
                // Begins a new path in the string.
                PS.print(segment.indexOrName);
                break;
            default: {
                var indexOrName = segment.indexOrName;
                if (typeof (indexOrName) === "string" && indexOrName.startsWith("$$$on")) {
                    // Cut off the $$$. This is a mirrored event listener property.
                    indexOrName = indexOrName.slice(3);
                }
                // *Must* be a property on the previously-printed object.
                PS.print(propertyAccessString(indexOrName));
                break;
            }
        }
    }
}
var PathStream = /** @class */ (function () {
    function PathStream() {
        this._p = null;
        this._i = -1;
        this._s = null;
        this._ss = null;
    }
    PathStream.prototype.print = function (s) {
        if (this._s !== null) {
            this._s += s;
        }
    };
    PathStream.prototype.pushString = function () {
        if (this._ss !== null) {
            this._ss.push(this._s);
            this._s = "";
        }
    };
    PathStream.prototype.flush = function () {
        var s = this._s;
        var ss = this._ss;
        this._ss = this._s = null;
        ss.push(s);
        return ss.filter(function (s) { return s !== ""; }).reverse().join(" ");
    };
    PathStream.prototype.setPath = function (p) {
        this._p = p;
        this._i = 0;
        this._s = "";
        this._ss = [];
    };
    PathStream.prototype.advance = function () {
        this._i++;
    };
    PathStream.prototype.peek = function () {
        if (this.nonempty()) {
            return this._p[this._i];
        }
        else {
            return null;
        }
    };
    PathStream.prototype.pop = function () {
        var rv = this.peek();
        this.advance();
        return rv;
    };
    PathStream.prototype.nonempty = function () {
        return this._p && this._p.length > this._i;
    };
    return PathStream;
}());
// Singleton class.
var PS = new PathStream();
/**
 * Pretty print a path as a human-friendly string.
 * @param p
 */
export default function pathToString(p) {
    PS.setPath(p);
    var segment = PS.peek();
    if (segment.type === 6 /* DOM_TREE */) {
        PS.print("document");
        PS.advance();
        prettyPrintDOMPath();
    }
    else {
        PS.print("window");
        prettyPrintNonDOMPath();
    }
    return PS.flush();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aF90b19zdHJpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL3BhdGhfdG9fc3RyaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLElBQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztBQUNmOzs7R0FHRztBQUNILG9CQUFvQixDQUFTO0lBQzNCLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsMkNBQTJDO0FBQzNDLGdFQUFnRTtBQUNoRSxJQUFNLG9CQUFvQixHQUFHLGtEQUFrRCxDQUFDO0FBQ2hGOzs7OztHQUtHO0FBQ0gsb0NBQW9DLElBQXFCO0lBQ3ZELE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFHLElBQU0sQ0FBQyxDQUFDO0FBQy9DLENBQUM7QUFFRCw4QkFBOEIsQ0FBa0I7SUFDOUMsRUFBRSxDQUFDLENBQUMsT0FBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDM0IsTUFBTSxDQUFDLE1BQUksQ0FBQyxNQUFHLENBQUM7SUFDbEIsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLFFBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxRQUFJLENBQUM7SUFDaEMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLE1BQUksQ0FBRyxDQUFDO0lBQ2pCLENBQUM7QUFDSCxDQUFDO0FBRUQ7SUFDRSxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO1FBQ3JCLElBQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFNLE1BQUksR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBQ2pDLEVB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QUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckIsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2Isa0JBQWtCLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25CLHFCQUFxQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUNELE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SVBhdGh9IGZyb20gJy4uL2NvbW1vbi9pbnRlcmZhY2VzJztcblxuY29uc3QgciA9IC8nL2c7XG4vKipcbiAqIEVzY2FwZXMgc2luZ2xlIHF1b3RlcyBpbiB0aGUgZ2l2ZW4gc3RyaW5nLlxuICogQHBhcmFtIHNcbiAqL1xuZnVuY3Rpb24gc2FmZVN0cmluZyhzOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gcy5yZXBsYWNlKHIsIFwiXFxcXCdcIik7XG59XG5cbi8vIEZyb20gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIwMDg0NDRcbi8vIFRoaXMgaXMgbm90ICpwZXJmZWN0KiwgYnV0IGl0J3MgZ29vZCBlbm91Z2ggZm9yIGh1bWFuIG91dHB1dC5cbmNvbnN0IEpTX0lERU5USUZJRVJfUkVHRVhQID0gL15bXyRhLXpBLVpcXHhBMC1cXHVGRkZGXVtfJGEtekEtWjAtOVxceEEwLVxcdUZGRkZdKiQvO1xuLyoqXG4gKiBSZXR1cm5zIHRydWUgaWYgdGhlIHByb3BlcnR5IGRlZmluaXRlbHkgcmVxdWlyZXMgYXJyYXkgbm90YXRpb24uXG4gKiBUaGlzIGNoZWNrIGlzIG5vdCBzb3VuZCwgYXMgd2UgZG8gbm90IGNoZWNrIGZvciBKYXZhU2NyaXB0IHJlc2VydmVkXG4gKiB3b3Jkcy4gSG93ZXZlciwgaXQgaXMgJ2dvb2QgZW5vdWdoJyBmb3IgaHVtYW4gb3V0cHV0LCBlLmcuIGluIGEgcmVwb3J0LlxuICogQHBhcmFtIHByb3BcbiAqL1xuZnVuY3Rpb24gcHJvcGVydHlOZWVkc0FycmF5Tm90YXRpb24ocHJvcDogc3RyaW5nIHwgbnVtYmVyKTogYm9vbGVhbiB7XG4gIHJldHVybiAhSlNfSURFTlRJRklFUl9SRUdFWFAudGVzdChgJHtwcm9wfWApO1xufVxuXG5mdW5jdGlvbiBwcm9wZXJ0eUFjY2Vzc1N0cmluZyhzOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgaWYgKHR5cGVvZihzKSA9PT0gXCJudW1iZXJcIikge1xuICAgIHJldHVybiBgWyR7c31dYDtcbiAgfSBlbHNlIGlmIChwcm9wZXJ0eU5lZWRzQXJyYXlOb3RhdGlvbihzKSkge1xuICAgIHJldHVybiBgW1wiJHtzYWZlU3RyaW5nKHMpfVwiXWA7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGAuJHtzfWA7XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJldHR5UHJpbnRET01QYXRoKCk6IHZvaWQge1xuICB3aGlsZSAoUFMubm9uZW1wdHkoKSkge1xuICAgIGNvbnN0IHNlZ21lbnQgPSBQUy5wb3AoKTtcbiAgICBjb25zdCBuYW1lID0gc2VnbWVudC5pbmRleE9yTmFtZTtcbiAgICBpZiAobmFtZSA9PT0gXCJyb290XCIpIHtcbiAgICAgIC8vIElnbm9yZSB0aGlzIEJMZWFrLWluc2VydGVkIGVkZ2UuXG4gICAgICAvLyBXZSdyZSB0cmFuc2l0aW9uaW5nIHRvIGEgcGF0aCBvdXRzaWRlIG9mIHRoZSBET00sIG9uIHRoZSBET00gb2JqZWN0IGl0c2VsZi5cbiAgICAgIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpO1xuICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ2NoaWxkTm9kZXMnKSB7XG4gICAgICBQUy5wcmludChwcm9wZXJ0eUFjY2Vzc1N0cmluZyhuYW1lKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vICQkJENISUxEJCQkbiA9PiBuXG4gICAgICBjb25zdCBpZHggPSBwYXJzZUludCgobmFtZSBhcyBzdHJpbmcpLnNsaWNlKDExKSwgMTApO1xuICAgICAgLy8gU2hvdWxkIGFsdGVybmF0ZSBiZXR3ZWVuICdjaGlsZE5vZGUnIGFuZCBpbmRpY2VzIHVudGlsIGl0IGdldHMgdG8gJ3Jvb3QnLlxuICAgICAgUFMucHJpbnQocHJvcGVydHlBY2Nlc3NTdHJpbmcoaWR4KSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpOiB2b2lkIHtcbiAgd2hpbGUgKFBTLm5vbmVtcHR5KCkpIHtcbiAgICBjb25zdCBzZWdtZW50ID0gUFMucG9wKCk7XG4gICAgc3dpdGNoIChzZWdtZW50LnR5cGUpIHtcbiAgICAgIGNhc2UgUGF0aFNlZ21lbnRUeXBlLkVWRU5UX0xJU1RFTkVSX0xJU1Q6IHtcbiAgICAgICAgLy8gV2lsbCBlaXRoZXIgYmU6XG4gICAgICAgIC8vIC0gQSBsZWFrIG9uIHRoZSBsaXN0IGl0c2VsZi5cbiAgICAgICAgLy8gLSBBIGxlYWsgKndpdGhpbiogYW4gZXZlbnQgbGlzdGVuZXIuXG4gICAgICAgIC8vIFNlZWsgZm9yd2FyZCB0byBmaWd1cmUgb3V0IHdoaWNoLCBhbmQgcHJpbnQgYXBwcm9wcmlhdGVseVxuICAgICAgICAvLyAkJGxpc3RlbmVycy50eXBlW2luZGV4XS5saXN0ZW5lclxuICAgICAgICBjb25zdCB0eXBlU2VnbWVudCA9IFBTLnBvcCgpO1xuICAgICAgICBpZiAoIVBTLm5vbmVtcHR5KCkpIHtcbiAgICAgICAgICAvLyBMaXN0IGxlYWtcbiAgICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgICAgUFMucHJpbnQoYExpc3Qgb2YgJyR7dHlwZVNlZ21lbnQuaW5kZXhPck5hbWV9JyBsaXN0ZW5lcnMgb25gKTtcbiAgICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgaW5kZXhTZWdtZW50ID0gUFMucG9wKCk7XG4gICAgICAgICAgUFMucG9wKCk7IC8vIFNob3VsZCBiZSB0aGUgJy5saXN0ZW5lcicgcHJvcGVydHksIHVubGVzcyB0aGUgYXBwbGljYXRpb24gbXVja2VkIHdpdGggb3VyIG1ldGFkYXRhLlxuICAgICAgICAgIFBTLnB1c2hTdHJpbmcoKTtcbiAgICAgICAgICBQUy5wcmludChgb24gbGlzdGVuZXIgJHtpbmRleFNlZ21lbnQuaW5kZXhPck5hbWV9IGluIHRoZSBsaXN0IG9mICcke3R5cGVTZWdtZW50LmluZGV4T3JOYW1lfScgbGlzdGVuZXJzIG9uYCk7XG4gICAgICAgICAgUFMucHVzaFN0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBQYXRoU2VnbWVudFR5cGUuQ0xPU1VSRTpcbiAgICAgICAgUFMucHVzaFN0cmluZygpO1xuICAgICAgICBQUy5wcmludChcIndpdGhpbiBjbG9zdXJlIG9mXCIpO1xuICAgICAgICBQUy5wdXNoU3RyaW5nKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXRoU2VnbWVudFR5cGUuQ0xPU1VSRV9WQVJJQUJMRTpcbiAgICAgICAgLy8gU2hvdWxkJ3ZlIGJlZW4gcHJlY2VkZWQgYnkgQ0xPU1VSRS5cbiAgICAgICAgLy8gQmVnaW5zIGEgbmV3IHBhdGggaW4gdGhlIHN0cmluZy5cbiAgICAgICAgUFMucHJpbnQoc2VnbWVudC5pbmRleE9yTmFtZSBhcyBzdHJpbmcpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgbGV0IGluZGV4T3JOYW1lID0gc2VnbWVudC5pbmRleE9yTmFtZTtcbiAgICAgICAgaWYgKHR5cGVvZihpbmRleE9yTmFtZSkgPT09IFwic3RyaW5nXCIgJiYgaW5kZXhPck5hbWUuc3RhcnRzV2l0aChcIiQkJG9uXCIpKSB7XG4gICAgICAgICAgLy8gQ3V0IG9mZiB0aGUgJCQkLiBUaGlzIGlzIGEgbWlycm9yZWQgZXZlbnQgbGlzdGVuZXIgcHJvcGVydHkuXG4gICAgICAgICAgaW5kZXhPck5hbWUgPSBpbmRleE9yTmFtZS5zbGljZSgzKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAqTXVzdCogYmUgYSBwcm9wZXJ0eSBvbiB0aGUgcHJldmlvdXNseS1wcmludGVkIG9iamVjdC5cbiAgICAgICAgUFMucHJpbnQocHJvcGVydHlBY2Nlc3NTdHJpbmcoaW5kZXhPck5hbWUpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFBhdGhTdHJlYW0ge1xuICBwcml2YXRlIF9wOiBJUGF0aCA9IG51bGw7XG4gIHByaXZhdGUgX2k6IG51bWJlciA9IC0xO1xuICBwcml2YXRlIF9zOiBzdHJpbmcgPSBudWxsO1xuICBwcml2YXRlIF9zczogc3RyaW5nW10gPSBudWxsO1xuICBwdWJsaWMgcHJpbnQoczogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuX3MgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuX3MgKz0gcztcbiAgICB9XG4gIH1cbiAgcHVibGljIHB1c2hTdHJpbmcoKSB7XG4gICAgaWYgKHRoaXMuX3NzICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9zcy5wdXNoKHRoaXMuX3MpO1xuICAgICAgdGhpcy5fcyA9IFwiXCI7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBmbHVzaCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHMgPSB0aGlzLl9zO1xuICAgIGNvbnN0IHNzID0gdGhpcy5fc3M7XG4gICAgdGhpcy5fc3MgPSB0aGlzLl9zID0gbnVsbDtcbiAgICBzcy5wdXNoKHMpO1xuICAgIHJldHVybiBzcy5maWx0ZXIoKHMpID0+IHMgIT09IFwiXCIpLnJldmVyc2UoKS5qb2luKFwiIFwiKTtcbiAgfVxuICBwdWJsaWMgc2V0UGF0aChwOiBJUGF0aCkge1xuICAgIHRoaXMuX3AgPSBwO1xuICAgIHRoaXMuX2kgPSAwO1xuICAgIHRoaXMuX3MgPSBcIlwiO1xuICAgIHRoaXMuX3NzID0gW107XG4gIH1cbiAgcHVibGljIGFkdmFuY2UoKTogdm9pZCB7XG4gICAgdGhpcy5faSsrO1xuICB9XG4gIHB1YmxpYyBwZWVrKCk6IElQYXRoU2VnbWVudCB8IG51bGwge1xuICAgIGlmICh0aGlzLm5vbmVtcHR5KCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9wW3RoaXMuX2ldO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgcHVibGljIHBvcCgpOiBJUGF0aFNlZ21lbnQgfCBudWxsIHtcbiAgICBjb25zdCBydiA9IHRoaXMucGVlaygpO1xuICAgIHRoaXMuYWR2YW5jZSgpO1xuICAgIHJldHVybiBydjtcbiAgfVxuICBwdWJsaWMgbm9uZW1wdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3AgJiYgdGhpcy5fcC5sZW5ndGggPiB0aGlzLl9pO1xuICB9XG59XG4vLyBTaW5nbGV0b24gY2xhc3MuXG5jb25zdCBQUyA9IG5ldyBQYXRoU3RyZWFtKCk7XG5cbi8qKlxuICogUHJldHR5IHByaW50IGEgcGF0aCBhcyBhIGh1bWFuLWZyaWVuZGx5IHN0cmluZy5cbiAqIEBwYXJhbSBwXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHBhdGhUb1N0cmluZyhwOiBJUGF0aCk6IHN0cmluZyB7XG4gIFBTLnNldFBhdGgocCk7XG4gIGNvbnN0IHNlZ21lbnQgPSBQUy5wZWVrKCk7XG4gIGlmIChzZWdtZW50LnR5cGUgPT09IFBhdGhTZWdtZW50VHlwZS5ET01fVFJFRSkge1xuICAgIFBTLnByaW50KFwiZG9jdW1lbnRcIik7XG4gICAgUFMuYWR2YW5jZSgpO1xuICAgIHByZXR0eVByaW50RE9NUGF0aCgpO1xuICB9IGVsc2Uge1xuICAgIFBTLnByaW50KFwid2luZG93XCIpO1xuICAgIHByZXR0eVByaW50Tm9uRE9NUGF0aCgpO1xuICB9XG4gIHJldHVybiBQUy5mbHVzaCgpO1xufVxuIl19