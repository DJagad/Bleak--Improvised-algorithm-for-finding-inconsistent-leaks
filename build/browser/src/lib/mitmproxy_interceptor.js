import { parseHTML, exposeClosureState, injectIntoHead, ensureES5 } from './transformations';
import { readFileSync } from 'fs';
function identJSTransform(f, s) {
    return s;
}
function defaultRewrite(url, type, data) {
    return data;
}
export var DEFAULT_AGENT_PATH = require.resolve('../lib/bleak_agent');
export var DEFAULT_AGENT_URL = "/bleak_agent.js";
export var DEFAULT_AGENT_TRANSFORM_PATH = require.resolve('../lib/bleak_agent_transform');
export var DEFAULT_AGENT_TRANSFORM_URL = "/bleak_agent_transform.js";
export var DEFAULT_BABEL_POLYFILL_URL = "/bleak_polyfill.js";
export var DEFAULT_BABEL_POLYFILL_PATH = require.resolve('babel-polyfill/dist/polyfill');
var DEFAULT_VALUES = {
    agentPath: DEFAULT_AGENT_PATH,
    agentUrl: DEFAULT_AGENT_URL,
    polyfillUrl: DEFAULT_BABEL_POLYFILL_URL,
    polyfillPath: DEFAULT_BABEL_POLYFILL_PATH,
    config: "",
    fixes: new Array(),
    disableAllRewrites: false,
    fixRewriteFunction: defaultRewrite
};
/**
 * Retrieve a standard BLeak interceptor.
 */
export default function getInterceptor(config) {
    config = Object.assign({}, DEFAULT_VALUES, config);
    var agentTransformURL = DEFAULT_AGENT_TRANSFORM_URL;
    var agentTransformPath = DEFAULT_AGENT_TRANSFORM_PATH;
    var parsedInjection = parseHTML("<script type=\"text/javascript\" src=\"" + config.agentUrl + "\"></script>\n  <script type=\"text/javascript\" src=\"" + agentTransformURL + "\"></script>\n    <script type=\"text/javascript\">\n      " + JSON.stringify(config.fixes) + ".forEach(function(num) {\n        $$$SHOULDFIX$$$(num, true);\n      });\n      " + config.config + "\n    </script>\n    " + (config.disableAllRewrites ? '' : "<script type=\"text/javascript\" src=\"" + config.polyfillUrl + "\"></script>\n    <script type=\"text/javascript\">\n      // Babel defines a 'global' variable that trips up some applications' environment detection.\n      if (typeof(global) !== \"undefined\") { delete window['global']; }\n    </script>"));
    var agentData = readFileSync(config.agentPath);
    var agentTransformData = readFileSync(agentTransformPath);
    var polyfillData = readFileSync(config.polyfillPath);
    return function (f) {
        var response = f.response;
        var request = f.request;
        var method = f.request.method;
        var url = request.url;
        // Filter out non 'GET' requests
        if (method !== 'get') {
            if (method === 'post' && url.path === "/eval") {
                // Special eval handler!
                response.statusCode = 200;
                response.clearHeaders();
                var body = JSON.parse(f.requestBody.toString());
                if (config.rewrite) {
                    f.setResponseBody(Buffer.from(exposeClosureState("eval-" + Math.random() + ".js", body.source, config.agentUrl, config.polyfillUrl, body.scope), 'utf8'));
                }
                else if (!config.disableAllRewrites) {
                    f.setResponseBody(Buffer.from(ensureES5("eval-" + Math.random() + ".js", body.source, config.agentUrl, config.polyfillUrl, body.scope), 'utf8'));
                }
                else {
                    f.setResponseBody(Buffer.from(body.source, 'utf8'));
                }
                response.setHeader('content-type', 'text/javascript');
            }
            return;
        }
        // GET requests
        var mime = response.getHeader('content-type');
        if (mime.indexOf(";") !== -1) {
            mime = mime.slice(0, mime.indexOf(";"));
        }
        // console.log(`[${response.statusCode}] ${request.rawUrl}: ${mime}`);
        // NOTE: Use `pathname`, as it cuts out query variables that may have been tacked on.
        switch (url.pathname.toLowerCase()) {
            case config.agentUrl:
                response.statusCode = 200;
                response.clearHeaders();
                f.setResponseBody(agentData);
                response.setHeader('content-type', 'text/javascript');
                return;
            case agentTransformURL:
                response.statusCode = 200;
                response.clearHeaders();
                if (config.rewrite) {
                    f.setResponseBody(Buffer.from(exposeClosureState(url.pathname, agentTransformData.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                }
                else {
                    f.setResponseBody(agentTransformData);
                }
                response.setHeader('content-type', 'text/javascript');
                return;
            case config.polyfillUrl:
                response.statusCode = 200;
                response.clearHeaders();
                f.setResponseBody(polyfillData);
                response.setHeader('content-type', 'text/javascript');
                return;
        }
        if (response.statusCode === 200) {
            // Rewrite before anything else happens.
            f.setResponseBody(config.fixRewriteFunction(request.rawUrl, mime, f.responseBody, config.fixes));
        }
        switch (mime) {
            case 'text/html':
                //if (f.status === 200) {
                f.setResponseBody(Buffer.from(injectIntoHead(url.pathname, f.responseBody.toString("utf8"), parsedInjection, config.rewrite ? exposeClosureState : identJSTransform), 'utf8'));
                //}
                break;
            case 'text/javascript':
            case 'application/javascript':
            case 'text/x-javascript':
            case 'application/x-javascript':
                if (response.statusCode === 200) {
                    if (config.rewrite) {
                        config.log.debug("Rewriting " + request.rawUrl + "...");
                        f.setResponseBody(Buffer.from(exposeClosureState(url.pathname, f.responseBody.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                    }
                    else if (!config.disableAllRewrites) {
                        config.log.debug("ES5ing " + request.rawUrl + "...");
                        f.setResponseBody(Buffer.from(ensureES5(url.pathname, f.responseBody.toString("utf8"), config.agentUrl, config.polyfillUrl), 'utf8'));
                    }
                }
                break;
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWl0bXByb3h5X2ludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9taXRtcHJveHlfaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxrQkFBa0IsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDM0YsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLElBQUksQ0FBQztBQUloQywwQkFBMEIsQ0FBUyxFQUFFLENBQVM7SUFDNUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCx3QkFBd0IsR0FBVyxFQUFFLElBQVksRUFBRSxJQUFZO0lBQzdELE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsTUFBTSxDQUFDLElBQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sQ0FBQyxJQUFNLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0FBQ25ELE1BQU0sQ0FBQyxJQUFNLDRCQUE0QixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUM1RixNQUFNLENBQUMsSUFBTSwyQkFBMkIsR0FBRywyQkFBMkIsQ0FBQztBQUN2RSxNQUFNLENBQUMsSUFBTSwwQkFBMEIsR0FBRyxvQkFBb0IsQ0FBQztBQUMvRCxNQUFNLENBQUMsSUFBTSwyQkFBMkIsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFlM0YsSUFBTSxjQUFjLEdBQUc7SUFDckIsU0FBUyxFQUFFLGtCQUFrQjtJQUM3QixRQUFRLEVBQUUsaUJBQWlCO0lBQzNCLFdBQVcsRUFBRSwwQkFBMEI7SUFDdkMsWUFBWSxFQUFFLDJCQUEyQjtJQUN6QyxNQUFNLEVBQUUsRUFBRTtJQUNWLEtBQUssRUFBRSxJQUFJLEtBQUssRUFBVTtJQUMxQixrQkFBa0IsRUFBRSxLQUFLO0lBQ3pCLGtCQUFrQixFQUFFLGNBQWM7Q0FDbkMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE9BQU8seUJBQXlCLE1BQXlCO0lBQzlELE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbkQsSUFBTSxpQkFBaUIsR0FBRywyQkFBMkIsQ0FBQztJQUN0RCxJQUFNLGtCQUFrQixHQUFHLDRCQUE0QixDQUFDO0lBQ3hELElBQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyw0Q0FBdUMsTUFBTSxDQUFDLFFBQVEsK0RBQ2xELGlCQUFpQixtRUFFakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHdGQUc1QixNQUFNLENBQUMsTUFBTSw4QkFFZixNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsNENBQXVDLE1BQU0sQ0FBQyxXQUFXLHFQQUlsRixDQUFFLENBQUMsQ0FBQztJQUNoQixJQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELElBQU0sa0JBQWtCLEdBQUcsWUFBWSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDNUQsSUFBTSxZQUFZLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN2RCxNQUFNLENBQUMsVUFBQyxDQUF5QjtRQUMvQixJQUFNLFFBQVEsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDO1FBQzVCLElBQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDMUIsSUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDaEMsSUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztRQUN4QixnQ0FBZ0M7UUFDaEMsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDckIsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQzlDLHdCQUF3QjtnQkFDeEIsUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7Z0JBQzFCLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDeEIsSUFBTSxJQUFJLEdBQXNDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztvQkFDbkIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVEsSUFBSSxDQUFDLE1BQU0sRUFBRSxRQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZKLENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztvQkFDdEMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFRLElBQUksQ0FBQyxNQUFNLEVBQUUsUUFBSyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUM5SSxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNOLENBQUMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBQ0QsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztZQUN4RCxDQUFDO1lBQ0QsTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUVELGVBQWU7UUFDZixJQUFJLElBQUksR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzlDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUNELHNFQUFzRTtRQUN0RSxxRkFBcUY7UUFDckYsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkMsS0FBSyxNQUFNLENBQUMsUUFBUTtnQkFDbEIsUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7Z0JBQzFCLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDeEIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDN0IsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFDO1lBQ1QsS0FBSyxpQkFBaUI7Z0JBQ3BCLFFBQVEsQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO2dCQUMxQixRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3hCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUNuQixDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDckosQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixDQUFDLENBQUMsZUFBZSxDQUFDLGtCQUFrQixDQUFDLENBQUM7Z0JBQ3hDLENBQUM7Z0JBQ0QsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFDO1lBQ1QsS0FBSyxNQUFNLENBQUMsV0FBVztnQkFDckIsUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7Z0JBQzFCLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDeEIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDaEMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFDO1FBQ1gsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoQyx3Q0FBd0M7WUFDeEMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNuRyxDQUFDO1FBRUQsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNiLEtBQUssV0FBVztnQkFDaEIseUJBQXlCO2dCQUN2QixDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsZUFBZSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQy9LLEdBQUc7Z0JBQ0gsS0FBSyxDQUFDO1lBQ1IsS0FBSyxpQkFBaUIsQ0FBQztZQUN2QixLQUFLLHdCQUF3QixDQUFDO1lBQzlCLEtBQUssbUJBQW1CLENBQUM7WUFDekIsS0FBSywwQkFBMEI7Z0JBQzdCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDaEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7d0JBQ25CLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLGVBQWEsT0FBTyxDQUFDLE1BQU0sUUFBSyxDQUFDLENBQUM7d0JBQ25ELENBQUMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ2pKLENBQUM7b0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQzt3QkFDdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBVSxPQUFPLENBQUMsTUFBTSxRQUFLLENBQUMsQ0FBQTt3QkFDL0MsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ3hJLENBQUM7Z0JBQ0gsQ0FBQztnQkFDRCxLQUFLLENBQUM7UUFDVixDQUFDO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7cGFyc2VIVE1MLCBleHBvc2VDbG9zdXJlU3RhdGUsIGluamVjdEludG9IZWFkLCBlbnN1cmVFUzV9IGZyb20gJy4vdHJhbnNmb3JtYXRpb25zJztcbmltcG9ydCB7cmVhZEZpbGVTeW5jfSBmcm9tICdmcyc7XG5pbXBvcnQge0ludGVyY2VwdG9yLCBJbnRlcmNlcHRlZEhUVFBNZXNzYWdlfSBmcm9tICdtaXRtcHJveHknO1xuaW1wb3J0IHtMb2d9IGZyb20gJy4uL2NvbW1vbi9pbnRlcmZhY2VzJztcblxuZnVuY3Rpb24gaWRlbnRKU1RyYW5zZm9ybShmOiBzdHJpbmcsIHM6IHN0cmluZykge1xuICByZXR1cm4gcztcbn1cblxuZnVuY3Rpb24gZGVmYXVsdFJld3JpdGUodXJsOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgZGF0YTogQnVmZmVyKTogQnVmZmVyIHtcbiAgcmV0dXJuIGRhdGE7XG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0FHRU5UX1BBVEggPSByZXF1aXJlLnJlc29sdmUoJy4uL2xpYi9ibGVha19hZ2VudCcpO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQUdFTlRfVVJMID0gYC9ibGVha19hZ2VudC5qc2A7XG5leHBvcnQgY29uc3QgREVGQVVMVF9BR0VOVF9UUkFOU0ZPUk1fUEFUSCA9IHJlcXVpcmUucmVzb2x2ZSgnLi4vbGliL2JsZWFrX2FnZW50X3RyYW5zZm9ybScpO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQUdFTlRfVFJBTlNGT1JNX1VSTCA9IGAvYmxlYWtfYWdlbnRfdHJhbnNmb3JtLmpzYDtcbmV4cG9ydCBjb25zdCBERUZBVUxUX0JBQkVMX1BPTFlGSUxMX1VSTCA9IGAvYmxlYWtfcG9seWZpbGwuanNgO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQkFCRUxfUE9MWUZJTExfUEFUSCA9IHJlcXVpcmUucmVzb2x2ZSgnYmFiZWwtcG9seWZpbGwvZGlzdC9wb2x5ZmlsbCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEludGVyY2VwdG9yQ29uZmlnIHtcbiAgbG9nOiBMb2c7XG4gIHJld3JpdGU6IGJvb2xlYW47XG4gIGFnZW50VXJsPzogc3RyaW5nO1xuICBhZ2VudFBhdGg/OiBzdHJpbmc7XG4gIHBvbHlmaWxsVXJsPzogc3RyaW5nO1xuICBwb2x5ZmlsbFBhdGg/OiBzdHJpbmc7XG4gIGNvbmZpZzogc3RyaW5nO1xuICBmaXhlcz86IG51bWJlcltdO1xuICBkaXNhYmxlQWxsUmV3cml0ZXM/OiBib29sZWFuO1xuICBmaXhSZXdyaXRlRnVuY3Rpb24odXJsOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgZGF0YTogQnVmZmVyLCBmaXhlczogbnVtYmVyW10pOiBCdWZmZXI7XG59XG5cbmNvbnN0IERFRkFVTFRfVkFMVUVTID0ge1xuICBhZ2VudFBhdGg6IERFRkFVTFRfQUdFTlRfUEFUSCxcbiAgYWdlbnRVcmw6IERFRkFVTFRfQUdFTlRfVVJMLFxuICBwb2x5ZmlsbFVybDogREVGQVVMVF9CQUJFTF9QT0xZRklMTF9VUkwsXG4gIHBvbHlmaWxsUGF0aDogREVGQVVMVF9CQUJFTF9QT0xZRklMTF9QQVRILFxuICBjb25maWc6IFwiXCIsXG4gIGZpeGVzOiBuZXcgQXJyYXk8bnVtYmVyPigpLFxuICBkaXNhYmxlQWxsUmV3cml0ZXM6IGZhbHNlLFxuICBmaXhSZXdyaXRlRnVuY3Rpb246IGRlZmF1bHRSZXdyaXRlXG59O1xuXG4vKipcbiAqIFJldHJpZXZlIGEgc3RhbmRhcmQgQkxlYWsgaW50ZXJjZXB0b3IuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGdldEludGVyY2VwdG9yKGNvbmZpZzogSW50ZXJjZXB0b3JDb25maWcpOiBJbnRlcmNlcHRvciB7XG4gIGNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfVkFMVUVTLCBjb25maWcpO1xuICBjb25zdCBhZ2VudFRyYW5zZm9ybVVSTCA9IERFRkFVTFRfQUdFTlRfVFJBTlNGT1JNX1VSTDtcbiAgY29uc3QgYWdlbnRUcmFuc2Zvcm1QYXRoID0gREVGQVVMVF9BR0VOVF9UUkFOU0ZPUk1fUEFUSDtcbiAgY29uc3QgcGFyc2VkSW5qZWN0aW9uID0gcGFyc2VIVE1MKGA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke2NvbmZpZy5hZ2VudFVybH1cIj48L3NjcmlwdD5cbiAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiJHthZ2VudFRyYW5zZm9ybVVSTH1cIj48L3NjcmlwdD5cbiAgICA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIj5cbiAgICAgICR7SlNPTi5zdHJpbmdpZnkoY29uZmlnLmZpeGVzKX0uZm9yRWFjaChmdW5jdGlvbihudW0pIHtcbiAgICAgICAgJCQkU0hPVUxERklYJCQkKG51bSwgdHJ1ZSk7XG4gICAgICB9KTtcbiAgICAgICR7Y29uZmlnLmNvbmZpZ31cbiAgICA8L3NjcmlwdD5cbiAgICAke2NvbmZpZy5kaXNhYmxlQWxsUmV3cml0ZXMgPyAnJyA6IGA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke2NvbmZpZy5wb2x5ZmlsbFVybH1cIj48L3NjcmlwdD5cbiAgICA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIj5cbiAgICAgIC8vIEJhYmVsIGRlZmluZXMgYSAnZ2xvYmFsJyB2YXJpYWJsZSB0aGF0IHRyaXBzIHVwIHNvbWUgYXBwbGljYXRpb25zJyBlbnZpcm9ubWVudCBkZXRlY3Rpb24uXG4gICAgICBpZiAodHlwZW9mKGdsb2JhbCkgIT09IFwidW5kZWZpbmVkXCIpIHsgZGVsZXRlIHdpbmRvd1snZ2xvYmFsJ107IH1cbiAgICA8L3NjcmlwdD5gfWApO1xuICBjb25zdCBhZ2VudERhdGEgPSByZWFkRmlsZVN5bmMoY29uZmlnLmFnZW50UGF0aCk7XG4gIGNvbnN0IGFnZW50VHJhbnNmb3JtRGF0YSA9IHJlYWRGaWxlU3luYyhhZ2VudFRyYW5zZm9ybVBhdGgpO1xuICBjb25zdCBwb2x5ZmlsbERhdGEgPSByZWFkRmlsZVN5bmMoY29uZmlnLnBvbHlmaWxsUGF0aCk7XG4gIHJldHVybiAoZjogSW50ZXJjZXB0ZWRIVFRQTWVzc2FnZSk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gZi5yZXNwb25zZTtcbiAgICBjb25zdCByZXF1ZXN0ID0gZi5yZXF1ZXN0O1xuICAgIGNvbnN0IG1ldGhvZCA9IGYucmVxdWVzdC5tZXRob2Q7XG4gICAgY29uc3QgdXJsID0gcmVxdWVzdC51cmw7XG4gICAgLy8gRmlsdGVyIG91dCBub24gJ0dFVCcgcmVxdWVzdHNcbiAgICBpZiAobWV0aG9kICE9PSAnZ2V0Jykge1xuICAgICAgaWYgKG1ldGhvZCA9PT0gJ3Bvc3QnICYmIHVybC5wYXRoID09PSBcIi9ldmFsXCIpIHtcbiAgICAgICAgLy8gU3BlY2lhbCBldmFsIGhhbmRsZXIhXG4gICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XG4gICAgICAgIHJlc3BvbnNlLmNsZWFySGVhZGVycygpO1xuICAgICAgICBjb25zdCBib2R5OiB7IHNjb3BlOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nIH0gPSBKU09OLnBhcnNlKGYucmVxdWVzdEJvZHkudG9TdHJpbmcoKSk7XG4gICAgICAgIGlmIChjb25maWcucmV3cml0ZSkge1xuICAgICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KEJ1ZmZlci5mcm9tKGV4cG9zZUNsb3N1cmVTdGF0ZShgZXZhbC0ke01hdGgucmFuZG9tKCl9LmpzYCwgYm9keS5zb3VyY2UsIGNvbmZpZy5hZ2VudFVybCwgY29uZmlnLnBvbHlmaWxsVXJsLCBib2R5LnNjb3BlKSwgJ3V0ZjgnKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIWNvbmZpZy5kaXNhYmxlQWxsUmV3cml0ZXMpIHtcbiAgICAgICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShlbnN1cmVFUzUoYGV2YWwtJHtNYXRoLnJhbmRvbSgpfS5qc2AsIGJvZHkuc291cmNlLCBjb25maWcuYWdlbnRVcmwsIGNvbmZpZy5wb2x5ZmlsbFVybCwgYm9keS5zY29wZSksICd1dGY4JykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KEJ1ZmZlci5mcm9tKGJvZHkuc291cmNlLCAndXRmOCcpKTtcbiAgICAgICAgfVxuICAgICAgICByZXNwb25zZS5zZXRIZWFkZXIoJ2NvbnRlbnQtdHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBHRVQgcmVxdWVzdHNcbiAgICBsZXQgbWltZSA9IHJlc3BvbnNlLmdldEhlYWRlcignY29udGVudC10eXBlJyk7XG4gICAgaWYgKG1pbWUuaW5kZXhPZihcIjtcIikgIT09IC0xKSB7XG4gICAgICBtaW1lID0gbWltZS5zbGljZSgwLCBtaW1lLmluZGV4T2YoXCI7XCIpKTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coYFske3Jlc3BvbnNlLnN0YXR1c0NvZGV9XSAke3JlcXVlc3QucmF3VXJsfTogJHttaW1lfWApO1xuICAgIC8vIE5PVEU6IFVzZSBgcGF0aG5hbWVgLCBhcyBpdCBjdXRzIG91dCBxdWVyeSB2YXJpYWJsZXMgdGhhdCBtYXkgaGF2ZSBiZWVuIHRhY2tlZCBvbi5cbiAgICBzd2l0Y2ggKHVybC5wYXRobmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICBjYXNlIGNvbmZpZy5hZ2VudFVybDpcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcbiAgICAgICAgcmVzcG9uc2UuY2xlYXJIZWFkZXJzKCk7XG4gICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KGFnZW50RGF0YSk7XG4gICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICBjYXNlIGFnZW50VHJhbnNmb3JtVVJMOlxuICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gMjAwO1xuICAgICAgICByZXNwb25zZS5jbGVhckhlYWRlcnMoKTtcbiAgICAgICAgaWYgKGNvbmZpZy5yZXdyaXRlKSB7XG4gICAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoQnVmZmVyLmZyb20oZXhwb3NlQ2xvc3VyZVN0YXRlKHVybC5wYXRobmFtZSwgYWdlbnRUcmFuc2Zvcm1EYXRhLnRvU3RyaW5nKFwidXRmOFwiKSwgY29uZmlnLmFnZW50VXJsLCBjb25maWcucG9seWZpbGxVcmwpLCAndXRmOCcpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmLnNldFJlc3BvbnNlQm9keShhZ2VudFRyYW5zZm9ybURhdGEpO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICBjYXNlIGNvbmZpZy5wb2x5ZmlsbFVybDpcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcbiAgICAgICAgcmVzcG9uc2UuY2xlYXJIZWFkZXJzKCk7XG4gICAgICAgIGYuc2V0UmVzcG9uc2VCb2R5KHBvbHlmaWxsRGF0YSk7XG4gICAgICAgIHJlc3BvbnNlLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgLy8gUmV3cml0ZSBiZWZvcmUgYW55dGhpbmcgZWxzZSBoYXBwZW5zLlxuICAgICAgZi5zZXRSZXNwb25zZUJvZHkoY29uZmlnLmZpeFJld3JpdGVGdW5jdGlvbihyZXF1ZXN0LnJhd1VybCwgbWltZSwgZi5yZXNwb25zZUJvZHksIGNvbmZpZy5maXhlcykpO1xuICAgIH1cblxuICAgIHN3aXRjaCAobWltZSkge1xuICAgICAgY2FzZSAndGV4dC9odG1sJzpcbiAgICAgIC8vaWYgKGYuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoQnVmZmVyLmZyb20oaW5qZWN0SW50b0hlYWQodXJsLnBhdGhuYW1lLCBmLnJlc3BvbnNlQm9keS50b1N0cmluZyhcInV0ZjhcIiksIHBhcnNlZEluamVjdGlvbiwgY29uZmlnLnJld3JpdGUgPyBleHBvc2VDbG9zdXJlU3RhdGUgOiBpZGVudEpTVHJhbnNmb3JtKSwgJ3V0ZjgnKSk7XG4gICAgICAgIC8vfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3RleHQvamF2YXNjcmlwdCc6XG4gICAgICBjYXNlICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JzpcbiAgICAgIGNhc2UgJ3RleHQveC1qYXZhc2NyaXB0JzpcbiAgICAgIGNhc2UgJ2FwcGxpY2F0aW9uL3gtamF2YXNjcmlwdCc6XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgICAgICBpZiAoY29uZmlnLnJld3JpdGUpIHtcbiAgICAgICAgICAgIGNvbmZpZy5sb2cuZGVidWcoYFJld3JpdGluZyAke3JlcXVlc3QucmF3VXJsfS4uLmApO1xuICAgICAgICAgICAgZi5zZXRSZXNwb25zZUJvZHkoQnVmZmVyLmZyb20oZXhwb3NlQ2xvc3VyZVN0YXRlKHVybC5wYXRobmFtZSwgZi5yZXNwb25zZUJvZHkudG9TdHJpbmcoXCJ1dGY4XCIpLCBjb25maWcuYWdlbnRVcmwsIGNvbmZpZy5wb2x5ZmlsbFVybCksICd1dGY4JykpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoIWNvbmZpZy5kaXNhYmxlQWxsUmV3cml0ZXMpIHtcbiAgICAgICAgICAgIGNvbmZpZy5sb2cuZGVidWcoYEVTNWluZyAke3JlcXVlc3QucmF3VXJsfS4uLmApXG4gICAgICAgICAgICBmLnNldFJlc3BvbnNlQm9keShCdWZmZXIuZnJvbShlbnN1cmVFUzUodXJsLnBhdGhuYW1lLCBmLnJlc3BvbnNlQm9keS50b1N0cmluZyhcInV0ZjhcIiksIGNvbmZpZy5hZ2VudFVybCwgY29uZmlnLnBvbHlmaWxsVXJsKSwgJ3V0ZjgnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==