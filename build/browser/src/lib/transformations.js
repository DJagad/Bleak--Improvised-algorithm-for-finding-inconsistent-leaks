import { Parser as HTMLParser, DomHandler, DomUtils } from 'htmlparser2';
export { exposeClosureState, ensureES5, nopTransform } from './closure_state_transform';
var HTML_PARSER_OPTS = { lowerCaseTags: false, lowerCaseAttributeNames: false };
export function parseHTML(source) {
    var rv;
    var err;
    var dom = new DomHandler(function (e, nodes) {
        rv = nodes;
        err = e;
    });
    var parser = new HTMLParser(dom, HTML_PARSER_OPTS);
    parser.write(source);
    parser.end();
    if (err) {
        return null;
    }
    return rv;
}
function identJSTransform(f, s) {
    return s;
}
/**
 * Inject the injection string into the <head> portion of the HTML source.
 *
 * If <head> is missing, attempts to inject after the <html> tag.
 *
 * @param filename Path to the HTML file.
 * @param source Source of an HTML file.
 * @param injection Content to inject into the head.
 */
export function injectIntoHead(filename, source, injection, jsTransform) {
    if (jsTransform === void 0) { jsTransform = identJSTransform; }
    var parsedHTML = parseHTML(source);
    if (parsedHTML === null) {
        // Parsing failed.
        return source;
    }
    var htmlNode;
    var headNode;
    var inlineScripts = [];
    function search(n) {
        // Traverse children first to avoid mutating state
        // before it is traversed.
        if (n.children) {
            n.children.forEach(search);
        }
        if (n.name) {
            switch (n.name.toLowerCase()) {
                case 'head':
                    if (!headNode) {
                        headNode = n;
                    }
                    break;
                case 'html':
                    if (!htmlNode) {
                        htmlNode = n;
                    }
                    break;
                case 'script':
                    var attribs = Object.keys(n.attribs);
                    var attribsLower = attribs.map(function (s) { return s.toLowerCase(); });
                    if (n.attribs && attribsLower.indexOf("src") === -1) {
                        var typeIndex = attribsLower.indexOf("type");
                        if (typeIndex !== -1) {
                            var type = n.attribs[attribs[typeIndex]].toLowerCase();
                            switch (type) {
                                case 'application/javascript':
                                case 'text/javascript':
                                case 'text/x-javascript':
                                case 'text/x-javascript':
                                    break;
                                default:
                                    // IGNORE non-JS script tags.
                                    // These are used for things like templates.
                                    return;
                            }
                        }
                        inlineScripts.push(n);
                    }
                    break;
            }
        }
    }
    parsedHTML.forEach(search);
    if (headNode || htmlNode) {
        var injectionTarget = headNode ? headNode : htmlNode;
        if (!injectionTarget.children) {
            injectionTarget.children = [];
        }
        injectionTarget.children = injection.concat(injectionTarget.children);
    }
    else {
        // AngularJS??
        return source;
    }
    inlineScripts.forEach(function (n, i) {
        if (!n.children || n.children.length !== 1) {
            console.log("Weird! Found JS node with the following children: " + JSON.stringify(n.children));
        }
        n.children[0].data = jsTransform(filename + "-inline" + i + ".js", n.children[0].data);
    });
    return DomUtils.getOuterHTML(parsedHTML);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtYXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi90cmFuc2Zvcm1hdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sSUFBSSxVQUFVLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUV2RSxPQUFPLEVBQUMsa0JBQWtCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBZXRGLElBQU0sZ0JBQWdCLEdBQUcsRUFBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLEtBQUssRUFBQyxDQUFDO0FBQ2hGLE1BQU0sb0JBQW9CLE1BQWM7SUFDdEMsSUFBSSxFQUFjLENBQUM7SUFDbkIsSUFBSSxHQUFRLENBQUM7SUFDYixJQUFNLEdBQUcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxVQUFDLENBQU0sRUFBRSxLQUFpQjtRQUNuRCxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ1gsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNWLENBQUMsQ0FBQyxDQUFDO0lBQ0gsSUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDckQsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNyQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDYixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1IsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRCxNQUFNLENBQUMsRUFBRSxDQUFDO0FBQ1osQ0FBQztBQUVELDBCQUEwQixDQUFTLEVBQUUsQ0FBUztJQUM1QyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVEOzs7Ozs7OztHQVFHO0FBQ0gsTUFBTSx5QkFBeUIsUUFBZ0IsRUFBRSxNQUFjLEVBQUUsU0FB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QyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ2hDLENBQUM7UUFDRCxlQUFlLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLGNBQWM7UUFDZCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQyxFQUFFLENBQUM7UUFDekIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1REFBcUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFHLENBQUMsQ0FBQztRQUNqRyxDQUFDO1FBQ0QsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFJLFFBQVEsZUFBVSxDQUFDLFFBQUssRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BGLENBQUMsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UGFyc2VyIGFzIEhUTUxQYXJzZXIsIERvbUhhbmRsZXIsIERvbVV0aWxzfSBmcm9tICdodG1scGFyc2VyMic7XG5cbmV4cG9ydCB7ZXhwb3NlQ2xvc3VyZVN0YXRlLCBlbnN1cmVFUzUsIG5vcFRyYW5zZm9ybX0gZnJvbSAnLi9jbG9zdXJlX3N0YXRlX3RyYW5zZm9ybSc7XG5cbmRlY2xhcmUgbW9kdWxlIFwiaHRtbHBhcnNlcjJcIiB7XG4gIGV4cG9ydCBjb25zdCBEb21IYW5kbGVyOiBhbnk7XG4gIGV4cG9ydCBjb25zdCBEb21VdGlsczogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEhUTUxOb2RlIHtcbiAgdHlwZTogc3RyaW5nO1xuICBuYW1lPzogc3RyaW5nO1xuICBkYXRhPzogc3RyaW5nO1xuICBjaGlsZHJlbj86IEhUTUxOb2RlW107XG4gIGF0dHJpYnM/OiB7W246IHN0cmluZ106IHN0cmluZ307XG59XG5cbmNvbnN0IEhUTUxfUEFSU0VSX09QVFMgPSB7bG93ZXJDYXNlVGFnczogZmFsc2UsIGxvd2VyQ2FzZUF0dHJpYnV0ZU5hbWVzOiBmYWxzZX07XG5leHBvcnQgZnVuY3Rpb24gcGFyc2VIVE1MKHNvdXJjZTogc3RyaW5nKTogSFRNTE5vZGVbXSB7XG4gIGxldCBydjogSFRNTE5vZGVbXTtcbiAgbGV0IGVycjogYW55O1xuICBjb25zdCBkb20gPSBuZXcgRG9tSGFuZGxlcigoZTogYW55LCBub2RlczogSFRNTE5vZGVbXSkgPT4ge1xuICAgIHJ2ID0gbm9kZXM7XG4gICAgZXJyID0gZTtcbiAgfSk7XG4gIGNvbnN0IHBhcnNlciA9IG5ldyBIVE1MUGFyc2VyKGRvbSwgSFRNTF9QQVJTRVJfT1BUUyk7XG4gIHBhcnNlci53cml0ZShzb3VyY2UpO1xuICBwYXJzZXIuZW5kKCk7XG4gIGlmIChlcnIpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gcnY7XG59XG5cbmZ1bmN0aW9uIGlkZW50SlNUcmFuc2Zvcm0oZjogc3RyaW5nLCBzOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHM7XG59XG5cbi8qKlxuICogSW5qZWN0IHRoZSBpbmplY3Rpb24gc3RyaW5nIGludG8gdGhlIDxoZWFkPiBwb3J0aW9uIG9mIHRoZSBIVE1MIHNvdXJjZS5cbiAqXG4gKiBJZiA8aGVhZD4gaXMgbWlzc2luZywgYXR0ZW1wdHMgdG8gaW5qZWN0IGFmdGVyIHRoZSA8aHRtbD4gdGFnLlxuICpcbiAqIEBwYXJhbSBmaWxlbmFtZSBQYXRoIHRvIHRoZSBIVE1MIGZpbGUuXG4gKiBAcGFyYW0gc291cmNlIFNvdXJjZSBvZiBhbiBIVE1MIGZpbGUuXG4gKiBAcGFyYW0gaW5qZWN0aW9uIENvbnRlbnQgdG8gaW5qZWN0IGludG8gdGhlIGhlYWQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RJbnRvSGVhZChmaWxlbmFtZTogc3RyaW5nLCBzb3VyY2U6IHN0cmluZywgaW5qZWN0aW9uOiBIVE1MTm9kZVtdLCBqc1RyYW5zZm9ybTogKGZpbGVuYW1lOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nKSA9PiBzdHJpbmcgPSBpZGVudEpTVHJhbnNmb3JtKTogc3RyaW5nIHtcbiAgY29uc3QgcGFyc2VkSFRNTCA9IHBhcnNlSFRNTChzb3VyY2UpO1xuICBpZiAocGFyc2VkSFRNTCA9PT0gbnVsbCkge1xuICAgIC8vIFBhcnNpbmcgZmFpbGVkLlxuICAgIHJldHVybiBzb3VyY2U7XG4gIH1cblxuICBsZXQgaHRtbE5vZGU6IEhUTUxOb2RlO1xuICBsZXQgaGVhZE5vZGU6IEhUTUxOb2RlO1xuICBsZXQgaW5saW5lU2NyaXB0czogSFRNTE5vZGVbXSA9IFtdO1xuICBmdW5jdGlvbiBzZWFyY2gobjogSFRNTE5vZGUpIHtcbiAgICAvLyBUcmF2ZXJzZSBjaGlsZHJlbiBmaXJzdCB0byBhdm9pZCBtdXRhdGluZyBzdGF0ZVxuICAgIC8vIGJlZm9yZSBpdCBpcyB0cmF2ZXJzZWQuXG4gICAgaWYgKG4uY2hpbGRyZW4pIHtcbiAgICAgIG4uY2hpbGRyZW4uZm9yRWFjaChzZWFyY2gpO1xuICAgIH1cblxuICAgIGlmIChuLm5hbWUpIHtcbiAgICAgIHN3aXRjaCAobi5uYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgY2FzZSAnaGVhZCc6XG4gICAgICAgICAgaWYgKCFoZWFkTm9kZSkge1xuICAgICAgICAgICAgaGVhZE5vZGUgPSBuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnaHRtbCc6XG4gICAgICAgICAgaWYgKCFodG1sTm9kZSkge1xuICAgICAgICAgICAgaHRtbE5vZGUgPSBuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnc2NyaXB0JzpcbiAgICAgICAgICBjb25zdCBhdHRyaWJzID0gT2JqZWN0LmtleXMobi5hdHRyaWJzKTtcbiAgICAgICAgICBjb25zdCBhdHRyaWJzTG93ZXIgPSBhdHRyaWJzLm1hcCgocykgPT4gcy50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgICBpZiAobi5hdHRyaWJzICYmIGF0dHJpYnNMb3dlci5pbmRleE9mKFwic3JjXCIpID09PSAtMSkge1xuICAgICAgICAgICAgY29uc3QgdHlwZUluZGV4ID0gYXR0cmlic0xvd2VyLmluZGV4T2YoXCJ0eXBlXCIpO1xuICAgICAgICAgICAgaWYgKHR5cGVJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IG4uYXR0cmlic1thdHRyaWJzW3R5cGVJbmRleF1dLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgIHN3aXRjaCh0eXBlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAnYXBwbGljYXRpb24vamF2YXNjcmlwdCc6XG4gICAgICAgICAgICAgICAgY2FzZSAndGV4dC9qYXZhc2NyaXB0JzpcbiAgICAgICAgICAgICAgICBjYXNlICd0ZXh0L3gtamF2YXNjcmlwdCc6XG4gICAgICAgICAgICAgICAgY2FzZSAndGV4dC94LWphdmFzY3JpcHQnOlxuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgIC8vIElHTk9SRSBub24tSlMgc2NyaXB0IHRhZ3MuXG4gICAgICAgICAgICAgICAgICAvLyBUaGVzZSBhcmUgdXNlZCBmb3IgdGhpbmdzIGxpa2UgdGVtcGxhdGVzLlxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmxpbmVTY3JpcHRzLnB1c2gobik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBwYXJzZWRIVE1MLmZvckVhY2goc2VhcmNoKTtcblxuICBpZiAoaGVhZE5vZGUgfHwgaHRtbE5vZGUpIHtcbiAgICBjb25zdCBpbmplY3Rpb25UYXJnZXQgPSBoZWFkTm9kZSA/IGhlYWROb2RlIDogaHRtbE5vZGU7XG4gICAgaWYgKCFpbmplY3Rpb25UYXJnZXQuY2hpbGRyZW4pIHtcbiAgICAgIGluamVjdGlvblRhcmdldC5jaGlsZHJlbiA9IFtdO1xuICAgIH1cbiAgICBpbmplY3Rpb25UYXJnZXQuY2hpbGRyZW4gPSBpbmplY3Rpb24uY29uY2F0KGluamVjdGlvblRhcmdldC5jaGlsZHJlbik7XG4gIH0gZWxzZSB7XG4gICAgLy8gQW5ndWxhckpTPz9cbiAgICByZXR1cm4gc291cmNlO1xuICB9XG4gIGlubGluZVNjcmlwdHMuZm9yRWFjaCgobiwgaSkgPT4ge1xuICAgIGlmICghbi5jaGlsZHJlbiB8fCBuLmNoaWxkcmVuLmxlbmd0aCAhPT0gMSkge1xuICAgICAgY29uc29sZS5sb2coYFdlaXJkISBGb3VuZCBKUyBub2RlIHdpdGggdGhlIGZvbGxvd2luZyBjaGlsZHJlbjogJHtKU09OLnN0cmluZ2lmeShuLmNoaWxkcmVuKX1gKTtcbiAgICB9XG4gICAgbi5jaGlsZHJlblswXS5kYXRhID0ganNUcmFuc2Zvcm0oYCR7ZmlsZW5hbWV9LWlubGluZSR7aX0uanNgLCBuLmNoaWxkcmVuWzBdLmRhdGEpO1xuICB9KTtcbiAgcmV0dXJuIERvbVV0aWxzLmdldE91dGVySFRNTChwYXJzZWRIVE1MKTtcbn1cbiJdfQ==