"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const growth_graph_1 = require("../../lib/growth_graph");
const path_to_string_1 = require("../../lib/path_to_string");
const fs_1 = require("fs");
const readline = require("readline");
const interfaces_1 = require("../../common/interfaces");
const util_1 = require("../../common/util");
const heap_snapshot_parser_1 = require("../../lib/heap_snapshot_parser");
const zlib_1 = require("zlib");
function getHeapSnapshotParser(file) {
    const parser = new heap_snapshot_parser_1.default();
    const stream = fs_1.createReadStream(file).pipe(zlib_1.createGunzip());
    stream.on('data', function (d) {
        parser.addSnapshotChunk(d.toString());
    });
    return parser;
}
async function main(files) {
    const t = new growth_graph_1.HeapGrowthTracker();
    for (const file of files) {
        console.log(`Processing ${file}...`);
        await t.addSnapshot(getHeapSnapshotParser(file));
    }
    const growth = util_1.time('Get Growing Objects', console, () => t.findLeakPaths());
    console.log(`Found ${growth.length} growing paths.`);
    console.log(``);
    console.log(`Report`);
    console.log(`======`);
    console.log(``);
    growth.sort((a, b) => b.scores.leakShare - a.scores.leakShare).forEach((obj) => {
        console.log(`* LeakShare: ${obj.scores.leakShare}, Retained Size: ${obj.scores.retainedSize}, Transitive Closure Size: ${obj.scores.transitiveClosureSize}`);
        obj.paths.slice(0, 5).forEach((p, i) => {
            console.log(`   * ${path_to_string_1.default(p)}`);
        });
        if (obj.paths.length > 5) {
            console.log(`   * (${obj.paths.length - 5} more...)`);
        }
    });
    console.log(`Exploring the heap!`);
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });
    let heap = t.getGraph();
    let node = heap.getRoot();
    let path = [node];
    let hide = true;
    const MAX_COL_SIZE = 25;
    function pad(str, len) {
        let str2 = str.replace(/\n/g, ' ').slice(0, len);
        for (let i = str.length; i < len; i++) {
            str2 += " ";
        }
        return str2;
    }
    function column(strs, lens) {
        let out = "";
        for (let i = 0; i < strs.length; i++) {
            out += pad(strs[i], lens[i]) + " ";
        }
        return out;
    }
    function runRound(filter) {
        console.log(`Current Node: ${node.name} [${interfaces_1.SnapshotNodeTypeToString(node.type)}]`);
        console.log(`[..] Previous node, [h] ${hide ? "unhide system properties" : "hide system properties"}, [f (string)] Filter, [q] Quit`);
        let choices = [];
        let sizes = [0, 0, 0, 0, 0];
        let i = -1;
        for (const it = node.children; it.hasNext(); it.next()) {
            i++;
            const child = it.item();
            const to = child.to;
            // Skip some types of children.
            if (hide) {
                switch (to.type) {
                    //case SnapshotNodeType.Code:
                    case 10 /* ConsString */:
                    case 7 /* HeapNumber */:
                    case 0 /* Hidden */:
                    case 6 /* RegExp */:
                    case 11 /* SlicedString */:
                    case 2 /* String */:
                        continue;
                }
            }
            if (!filter || `${child.indexOrName}`.toLowerCase().indexOf(filter) !== -1) {
                let choice = [`[${i}]`, `${child.indexOrName}`, `=[${interfaces_1.SnapshotEdgeTypeToString(child.snapshotType)}]=>`, to.name, `[${interfaces_1.SnapshotNodeTypeToString(to.type)}]${t.isGrowing(to.nodeIndex) ? "*" : ""}`, `[Count: ${to.numProperties()}]`, `[Non-leak-reachable? ${t._nonLeakVisits.get(to.nodeIndex)}, Leak visits: ${t._leakRefs[to.nodeIndex]}, NI: ${to.nodeIndex}]`];
                choices.push(choice);
                for (let j = 0; j < choice.length; j++) {
                    if (choice[j].length > sizes[j]) {
                        sizes[j] = choice[j].length;
                        if (sizes[j] > MAX_COL_SIZE) {
                            sizes[j] = MAX_COL_SIZE;
                        }
                    }
                }
            }
        }
        for (const choice of choices) {
            console.log(column(choice, sizes));
        }
        rl.question("? ", (a) => {
            const a2 = a.trim().toLowerCase();
            let filter = undefined;
            switch (a2[0]) {
                case '.':
                    if (a2[1] === '.') {
                        path.pop();
                    }
                    break;
                case 'q':
                    rl.close();
                    process.exit();
                    break;
                case 'h':
                    hide = !hide;
                    break;
                case 'f': {
                    filter = a2.slice(2).trim();
                    break;
                }
                case 's': {
                    const latest = path[path.length - 1];
                    latest.nodeIndex = parseInt(a2.slice(2).trim(), 10);
                    path = [heap.getRoot(), latest];
                    break;
                }
                default:
                    const choice = parseInt(a2, 10);
                    const child = node.getChild(choice);
                    if (!child) {
                        console.log(`Invalid choice: ${choice}.`);
                    }
                    else {
                        path.push(child.to);
                    }
                    break;
            }
            if (path.length === 0) {
                path.push(heap.getRoot());
            }
            node = path[path.length - 1];
            runRound(filter);
        });
    }
    runRound();
}
const FindGrowingPaths = {
    command: 'find-growing-paths [snapshots...]',
    describe: 'Locates growing paths in a set of heap snapshots on disk. Useful for debugging BLeak.',
    handler: (args) => {
        if (args.snapshots.length === 0) {
            console.log(`No heap snapshots specified; nothing to do.`);
            return;
        }
        main(args.snapshots);
    },
    builder: (argv) => {
        return argv.positional('snapshots', {
            describe: 'Paths to heap snapshots (Gzipped) on disk, and in-order',
            type: 'string'
        });
    }
};
exports.default = FindGrowingPaths;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmluZF9ncm93aW5nX3BhdGhzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaS9jb21tYW5kcy9maW5kX2dyb3dpbmdfcGF0aHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5REFBeUQ7QUFDekQsNkRBQW9EO0FBQ3BELDJCQUFvQztBQUNwQyxxQ0FBcUM7QUFDckMsd0RBQTZHO0FBQzdHLDRDQUF1QztBQUN2Qyx5RUFBZ0U7QUFDaEUsK0JBQWtDO0FBR2xDLCtCQUErQixJQUFZO0lBQ3pDLE1BQU0sTUFBTSxHQUFHLElBQUksOEJBQWtCLEVBQUUsQ0FBQztJQUN4QyxNQUFNLE1BQU0sR0FBRyxxQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQVksRUFBRSxDQUFDLENBQUM7SUFDM0QsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBUyxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUN4QyxDQUFDLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQUVELEtBQUssZUFBZSxLQUFlO0lBQ2pDLE1BQU0sQ0FBQyxHQUFHLElBQUksZ0NBQWlCLEVBQUUsQ0FBQztJQUNsQyxHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCxNQUFNLE1BQU0sR0FBRyxXQUFJLENBQUMscUJBQXFCLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO0lB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LEVBQUUsdUZBQXVGO0lBQ2pHLE9BQU8sRUFBRSxDQUFDLElBQXdCLEVBQUUsRUFBRTtRQUNwQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLENBQUMsQ0FBQztZQUMzRCxNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFO1lBQ2xDLFFBQVEsRUFBRSx5REFBeUQ7WUFDbkUsSUFBSSxFQUFFLFFBQVE7U0FDZixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQztBQUVGLGtCQUFlLGdCQUFnQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtIZWFwR3Jvd3RoVHJhY2tlcn0gZnJvbSAnLi4vLi4vbGliL2dyb3d0aF9ncmFwaCc7XG5pbXBvcnQgcGF0aFRvU3RyaW5nIGZyb20gJy4uLy4uL2xpYi9wYXRoX3RvX3N0cmluZyc7XG5pbXBvcnQge2NyZWF0ZVJlYWRTdHJlYW19IGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcbmltcG9ydCB7U25hcHNob3ROb2RlVHlwZVRvU3RyaW5nLCBTbmFwc2hvdEVkZ2VUeXBlVG9TdHJpbmcsIFNuYXBzaG90Tm9kZVR5cGV9IGZyb20gJy4uLy4uL2NvbW1vbi9pbnRlcmZhY2VzJztcbmltcG9ydCB7dGltZX0gZnJvbSAnLi4vLi4vY29tbW9uL3V0aWwnO1xuaW1wb3J0IEhlYXBTbmFwc2hvdFBhcnNlciBmcm9tICcuLi8uLi9saWIvaGVhcF9zbmFwc2hvdF9wYXJzZXInO1xuaW1wb3J0IHtjcmVhdGVHdW56aXB9IGZyb20gJ3psaWInO1xuaW1wb3J0IHtDb21tYW5kTW9kdWxlfSBmcm9tICd5YXJncyc7XG5cbmZ1bmN0aW9uIGdldEhlYXBTbmFwc2hvdFBhcnNlcihmaWxlOiBzdHJpbmcpOiBIZWFwU25hcHNob3RQYXJzZXIge1xuICBjb25zdCBwYXJzZXIgPSBuZXcgSGVhcFNuYXBzaG90UGFyc2VyKCk7XG4gIGNvbnN0IHN0cmVhbSA9IGNyZWF0ZVJlYWRTdHJlYW0oZmlsZSkucGlwZShjcmVhdGVHdW56aXAoKSk7XG4gIHN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGQpIHtcbiAgICBwYXJzZXIuYWRkU25hcHNob3RDaHVuayhkLnRvU3RyaW5nKCkpO1xuICB9KTtcbiAgcmV0dXJuIHBhcnNlcjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbWFpbihmaWxlczogc3RyaW5nW10pIHtcbiAgY29uc3QgdCA9IG5ldyBIZWFwR3Jvd3RoVHJhY2tlcigpO1xuICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyAke2ZpbGV9Li4uYCk7XG4gICAgYXdhaXQgdC5hZGRTbmFwc2hvdChnZXRIZWFwU25hcHNob3RQYXJzZXIoZmlsZSkpO1xuICB9XG5cbiAgY29uc3QgZ3Jvd3RoID0gdGltZSgnR2V0IEdyb3dpbmcgT2JqZWN0cycsIGNvbnNvbGUsICgpID0+IHQuZmluZExlYWtQYXRocygpKTtcbiAgY29uc29sZS5sb2coYEZvdW5kICR7Z3Jvd3RoLmxlbmd0aH0gZ3Jvd2luZyBwYXRocy5gKTtcbiAgY29uc29sZS5sb2coYGApO1xuICBjb25zb2xlLmxvZyhgUmVwb3J0YCk7XG4gIGNvbnNvbGUubG9nKGA9PT09PT1gKTtcbiAgY29uc29sZS5sb2coYGApO1xuICBncm93dGguc29ydCgoYSwgYikgPT4gYi5zY29yZXMubGVha1NoYXJlIC0gYS5zY29yZXMubGVha1NoYXJlKS5mb3JFYWNoKChvYmopID0+IHtcbiAgICBjb25zb2xlLmxvZyhgKiBMZWFrU2hhcmU6ICR7b2JqLnNjb3Jlcy5sZWFrU2hhcmV9LCBSZXRhaW5lZCBTaXplOiAke29iai5zY29yZXMucmV0YWluZWRTaXplfSwgVHJhbnNpdGl2ZSBDbG9zdXJlIFNpemU6ICR7b2JqLnNjb3Jlcy50cmFuc2l0aXZlQ2xvc3VyZVNpemV9YCk7XG4gICAgb2JqLnBhdGhzLnNsaWNlKDAsIDUpLmZvckVhY2goKHAsIGkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGAgICAqICR7cGF0aFRvU3RyaW5nKHApfWApO1xuICAgIH0pO1xuICAgIGlmIChvYmoucGF0aHMubGVuZ3RoID4gNSkge1xuICAgICAgY29uc29sZS5sb2coYCAgICogKCR7b2JqLnBhdGhzLmxlbmd0aCAtIDV9IG1vcmUuLi4pYCk7XG4gICAgfVxuICB9KTtcblxuICBjb25zb2xlLmxvZyhgRXhwbG9yaW5nIHRoZSBoZWFwIWApO1xuICBjb25zdCBybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG4gICAgaW5wdXQ6IHByb2Nlc3Muc3RkaW4sXG4gICAgb3V0cHV0OiBwcm9jZXNzLnN0ZG91dFxuICB9KTtcbiAgbGV0IGhlYXAgPSB0LmdldEdyYXBoKCk7XG4gIGxldCBub2RlID0gaGVhcC5nZXRSb290KCk7XG4gIGxldCBwYXRoID0gW25vZGVdO1xuICBsZXQgaGlkZSA9IHRydWU7XG4gIGNvbnN0IE1BWF9DT0xfU0laRSA9IDI1O1xuICBmdW5jdGlvbiBwYWQoc3RyOiBzdHJpbmcsIGxlbjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBsZXQgc3RyMiA9IHN0ci5yZXBsYWNlKC9cXG4vZywgJyAnKS5zbGljZSgwLCBsZW4pO1xuICAgIGZvciAobGV0IGkgPSBzdHIubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIHN0cjIgKz0gXCIgXCI7XG4gICAgfVxuICAgIHJldHVybiBzdHIyO1xuICB9XG4gIGZ1bmN0aW9uIGNvbHVtbihzdHJzOiBzdHJpbmdbXSwgbGVuczogbnVtYmVyW10pOiBzdHJpbmcge1xuICAgIGxldCBvdXQgPSBcIlwiO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3Rycy5sZW5ndGg7IGkrKykge1xuICAgICAgb3V0ICs9IHBhZChzdHJzW2ldLCBsZW5zW2ldKSArIFwiIFwiO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG4gIGZ1bmN0aW9uIHJ1blJvdW5kKGZpbHRlcj86IHN0cmluZykge1xuICAgIGNvbnNvbGUubG9nKGBDdXJyZW50IE5vZGU6ICR7bm9kZS5uYW1lfSBbJHtTbmFwc2hvdE5vZGVUeXBlVG9TdHJpbmcobm9kZS50eXBlKX1dYCk7XG4gICAgY29uc29sZS5sb2coYFsuLl0gUHJldmlvdXMgbm9kZSwgW2hdICR7aGlkZSA/IFwidW5oaWRlIHN5c3RlbSBwcm9wZXJ0aWVzXCIgOiBcImhpZGUgc3lzdGVtIHByb3BlcnRpZXNcIn0sIFtmIChzdHJpbmcpXSBGaWx0ZXIsIFtxXSBRdWl0YCk7XG4gICAgbGV0IGNob2ljZXM6IHN0cmluZ1tdW10gPSBbXTtcbiAgICBsZXQgc2l6ZXM6IG51bWJlcltdID0gWzAsIDAsIDAsIDAsIDBdO1xuICAgIGxldCBpID0gLTE7XG4gICAgZm9yIChjb25zdCBpdCA9IG5vZGUuY2hpbGRyZW47IGl0Lmhhc05leHQoKTsgaXQubmV4dCgpKSB7XG4gICAgICBpKys7XG4gICAgICBjb25zdCBjaGlsZCA9IGl0Lml0ZW0oKTtcbiAgICAgIGNvbnN0IHRvID0gY2hpbGQudG87XG4gICAgICAvLyBTa2lwIHNvbWUgdHlwZXMgb2YgY2hpbGRyZW4uXG4gICAgICBpZiAoaGlkZSkge1xuICAgICAgICBzd2l0Y2ggKHRvLnR5cGUpIHtcbiAgICAgICAgICAvL2Nhc2UgU25hcHNob3ROb2RlVHlwZS5Db2RlOlxuICAgICAgICAgIGNhc2UgU25hcHNob3ROb2RlVHlwZS5Db25zU3RyaW5nOlxuICAgICAgICAgIGNhc2UgU25hcHNob3ROb2RlVHlwZS5IZWFwTnVtYmVyOlxuICAgICAgICAgIGNhc2UgU25hcHNob3ROb2RlVHlwZS5IaWRkZW46XG4gICAgICAgICAgY2FzZSBTbmFwc2hvdE5vZGVUeXBlLlJlZ0V4cDpcbiAgICAgICAgICBjYXNlIFNuYXBzaG90Tm9kZVR5cGUuU2xpY2VkU3RyaW5nOlxuICAgICAgICAgIGNhc2UgU25hcHNob3ROb2RlVHlwZS5TdHJpbmc6XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmaWx0ZXIgfHwgYCR7Y2hpbGQuaW5kZXhPck5hbWV9YC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoZmlsdGVyKSAhPT0gLTEpIHtcbiAgICAgICAgbGV0IGNob2ljZSA9IFtgWyR7aX1dYCwgYCR7Y2hpbGQuaW5kZXhPck5hbWV9YCwgYD1bJHtTbmFwc2hvdEVkZ2VUeXBlVG9TdHJpbmcoY2hpbGQuc25hcHNob3RUeXBlKX1dPT5gLCB0by5uYW1lLCBgWyR7U25hcHNob3ROb2RlVHlwZVRvU3RyaW5nKHRvLnR5cGUpfV0ke3QuaXNHcm93aW5nKHRvLm5vZGVJbmRleCkgPyBcIipcIiA6IFwiXCJ9YCwgYFtDb3VudDogJHt0by5udW1Qcm9wZXJ0aWVzKCl9XWAsIGBbTm9uLWxlYWstcmVhY2hhYmxlPyAke3QuX25vbkxlYWtWaXNpdHMuZ2V0KHRvLm5vZGVJbmRleCl9LCBMZWFrIHZpc2l0czogJHt0Ll9sZWFrUmVmc1t0by5ub2RlSW5kZXhdfSwgTkk6ICR7dG8ubm9kZUluZGV4fV1gXTtcbiAgICAgICAgY2hvaWNlcy5wdXNoKGNob2ljZSk7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY2hvaWNlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgaWYgKGNob2ljZVtqXS5sZW5ndGggPiBzaXplc1tqXSkge1xuICAgICAgICAgICAgc2l6ZXNbal0gPSBjaG9pY2Vbal0ubGVuZ3RoO1xuICAgICAgICAgICAgaWYgKHNpemVzW2pdID4gTUFYX0NPTF9TSVpFKSB7XG4gICAgICAgICAgICAgIHNpemVzW2pdID0gTUFYX0NPTF9TSVpFO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGNob2ljZSBvZiBjaG9pY2VzKSB7XG4gICAgICBjb25zb2xlLmxvZyhjb2x1bW4oY2hvaWNlLCBzaXplcykpO1xuICAgIH1cblxuICAgIHJsLnF1ZXN0aW9uKFwiPyBcIiwgKGEpID0+IHtcbiAgICAgIGNvbnN0IGEyID0gYS50cmltKCkudG9Mb3dlckNhc2UoKTtcbiAgICAgIGxldCBmaWx0ZXI6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgIHN3aXRjaCAoYTJbMF0pIHtcbiAgICAgICAgY2FzZSAnLic6XG4gICAgICAgICAgaWYgKGEyWzFdID09PSAnLicpIHtcbiAgICAgICAgICAgIHBhdGgucG9wKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdxJzpcbiAgICAgICAgICBybC5jbG9zZSgpO1xuICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdoJzpcbiAgICAgICAgICBoaWRlID0gIWhpZGU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2YnOiB7XG4gICAgICAgICAgZmlsdGVyID0gYTIuc2xpY2UoMikudHJpbSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgJ3MnOiB7XG4gICAgICAgICAgY29uc3QgbGF0ZXN0ID0gcGF0aFtwYXRoLmxlbmd0aCAtIDFdO1xuICAgICAgICAgIGxhdGVzdC5ub2RlSW5kZXggPSA8YW55PiBwYXJzZUludChhMi5zbGljZSgyKS50cmltKCksIDEwKTtcbiAgICAgICAgICBwYXRoID0gW2hlYXAuZ2V0Um9vdCgpLCBsYXRlc3RdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29uc3QgY2hvaWNlID0gcGFyc2VJbnQoYTIsIDEwKTtcbiAgICAgICAgICBjb25zdCBjaGlsZCA9IG5vZGUuZ2V0Q2hpbGQoY2hvaWNlKTtcbiAgICAgICAgICBpZiAoIWNoaWxkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgSW52YWxpZCBjaG9pY2U6ICR7Y2hvaWNlfS5gKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGF0aC5wdXNoKGNoaWxkLnRvKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcGF0aC5wdXNoKGhlYXAuZ2V0Um9vdCgpKTtcbiAgICAgIH1cbiAgICAgIG5vZGUgPSBwYXRoW3BhdGgubGVuZ3RoIC0gMV07XG4gICAgICBydW5Sb3VuZChmaWx0ZXIpO1xuICAgIH0pO1xuICB9XG4gIHJ1blJvdW5kKCk7XG59XG5cbmludGVyZmFjZSBDb21tYW5kTGluZU9wdGlvbnMge1xuICBzbmFwc2hvdHM6IHN0cmluZ1tdO1xufVxuXG5jb25zdCBGaW5kR3Jvd2luZ1BhdGhzOiBDb21tYW5kTW9kdWxlID0ge1xuICBjb21tYW5kOiAnZmluZC1ncm93aW5nLXBhdGhzIFtzbmFwc2hvdHMuLi5dJyxcbiAgZGVzY3JpYmU6ICdMb2NhdGVzIGdyb3dpbmcgcGF0aHMgaW4gYSBzZXQgb2YgaGVhcCBzbmFwc2hvdHMgb24gZGlzay4gVXNlZnVsIGZvciBkZWJ1Z2dpbmcgQkxlYWsuJyxcbiAgaGFuZGxlcjogKGFyZ3M6IENvbW1hbmRMaW5lT3B0aW9ucykgPT4ge1xuICAgIGlmIChhcmdzLnNuYXBzaG90cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKGBObyBoZWFwIHNuYXBzaG90cyBzcGVjaWZpZWQ7IG5vdGhpbmcgdG8gZG8uYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIG1haW4oYXJncy5zbmFwc2hvdHMpO1xuICB9LFxuICBidWlsZGVyOiAoYXJndikgPT4ge1xuICAgIHJldHVybiBhcmd2LnBvc2l0aW9uYWwoJ3NuYXBzaG90cycsIHtcbiAgICAgIGRlc2NyaWJlOiAnUGF0aHMgdG8gaGVhcCBzbmFwc2hvdHMgKEd6aXBwZWQpIG9uIGRpc2ssIGFuZCBpbi1vcmRlcicsXG4gICAgICB0eXBlOiAnc3RyaW5nJ1xuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBGaW5kR3Jvd2luZ1BhdGhzO1xuXG4iXX0=