"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const stack_frame_1 = require("./stack_frame");
class StackFrameStats {
    constructor(
    // This stack frame's unique ID
    id, 
    // The LeakRoots that reference this stack frame
    leaks, 
    // The number of stacks that reference this stack frame
    count) {
        this.id = id;
        this.leaks = leaks;
        this.count = count;
    }
}
/**
 * Stores a set of stack traces associated with specific memory leaks.
 *
 * Supports:
 * - Looking up the leaks associated with a given source location
 * - Returning all of the stack frames located in a specific file
 * - Returning the stack traces associated with a specific leak
 */
class StackTraceManager {
    constructor(sfm, frames, _leaks) {
        this._leaks = _leaks;
        this._fileStackFrames = new Map();
        this._locationToId = new Map();
        this._frames = frames.map((f) => new stack_frame_1.default(sfm.getSourceFile(f[0]), f[3], f[1], f[2]));
        this._frameStats = this._frames.map((f, id) => new StackFrameStats(id, [], 0));
        this._leaks.forEach((l) => {
            l.stacks.forEach((s) => {
                for (const sf of s) {
                    const stats = this._frameStats[sf];
                    stats.count++;
                    if (stats.leaks.indexOf(l) === -1) {
                        stats.leaks.push(l);
                    }
                    const sfObj = this._frames[sf];
                    let fileStackFrames = this._fileStackFrames.get(sfObj.file);
                    if (!fileStackFrames) {
                        fileStackFrames = [];
                        this._fileStackFrames.set(sfObj.file, fileStackFrames);
                    }
                    // TODO: Could use a set, but these arrays are expected to be small.
                    if (fileStackFrames.indexOf(sf) === -1) {
                        fileStackFrames.push(sf);
                    }
                    this._locationToId.set(sfObj.key, sf);
                }
            });
        });
    }
    static FromBLeakResults(sourceFileManager, results) {
        return new StackTraceManager(sourceFileManager, results.stackFrames, results.leaks);
    }
    _getFrameForLocation(location) {
        return this._locationToId.get(location.key);
    }
    getLeaksForLocation(location) {
        const sfId = this._getFrameForLocation(location.getOriginalLocation());
        return this._frameStats[sfId].leaks;
    }
    getFramesForFile(file) {
        const fileInfo = this._fileStackFrames.get(file);
        if (!fileInfo) {
            return [];
        }
        // Filter out locations at invalid locations (0, -1, etc).
        return fileInfo.map((sf) => this._frames[sf]).filter((sf) => sf.line > 0 && sf.column > 0);
    }
    getTracesForLeak(l) {
        return l.stacks.map((s) => s.map((sf) => this._frames[sf]));
    }
    stackToFrames(s) {
        return s.map((s) => this._frames[s]);
    }
}
exports.default = StackTraceManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfdHJhY2VfbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy92aWV3ZXIvbW9kZWwvc3RhY2tfdHJhY2VfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLCtDQUF1QztBQUt2QztJQUNFO0lBQ0UsK0JBQStCO0lBQ2YsRUFBVTtJQUMxQixnREFBZ0Q7SUFDaEMsS0FBaUI7SUFDakMsdURBQXVEO0lBQ2hELEtBQWE7UUFKSixPQUFFLEdBQUYsRUFBRSxDQUFRO1FBRVYsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUUxQixVQUFLLEdBQUwsS0FBSyxDQUFRO0lBQUcsQ0FBQztDQUMzQjtBQUVEOzs7Ozs7O0dBT0c7QUFDSDtJQVNFLFlBQ0UsR0FBc0IsRUFDdEIsTUFBcUIsRUFDYixNQUFrQjtRQUFsQixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBTnBCLHFCQUFnQixHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO1FBQ25ELGtCQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFPaEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLHFCQUFVLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUYsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksZUFBZSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRSxJQUFJLENBQUMsTUFBTSxDQUFDLE9B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QVc7UUFDakMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRU0sYUFBYSxDQUFDLENBQVc7UUFDOUIsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUFqRUQsb0NBaUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJU3RhY2tGcmFtZX0gZnJvbSAnLi4vLi4vY29tbW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IEJMZWFrUmVzdWx0cyBmcm9tICcuLi8uLi9saWIvYmxlYWtfcmVzdWx0cyc7XG5pbXBvcnQgTGVha1Jvb3QgZnJvbSAnLi4vLi4vbGliL2xlYWtfcm9vdCc7XG5pbXBvcnQgU3RhY2tGcmFtZSBmcm9tICcuL3N0YWNrX2ZyYW1lJztcbmltcG9ydCBTb3VyY2VGaWxlTWFuYWdlciBmcm9tICcuL3NvdXJjZV9maWxlX21hbmFnZXInO1xuaW1wb3J0IFNvdXJjZUZpbGUgZnJvbSAnLi9zb3VyY2VfZmlsZSc7XG5pbXBvcnQgTG9jYXRpb24gZnJvbSAnLi9sb2NhdGlvbic7XG5cbmNsYXNzIFN0YWNrRnJhbWVTdGF0cyB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIC8vIFRoaXMgc3RhY2sgZnJhbWUncyB1bmlxdWUgSURcbiAgICBwdWJsaWMgcmVhZG9ubHkgaWQ6IG51bWJlcixcbiAgICAvLyBUaGUgTGVha1Jvb3RzIHRoYXQgcmVmZXJlbmNlIHRoaXMgc3RhY2sgZnJhbWVcbiAgICBwdWJsaWMgcmVhZG9ubHkgbGVha3M6IExlYWtSb290W10sXG4gICAgLy8gVGhlIG51bWJlciBvZiBzdGFja3MgdGhhdCByZWZlcmVuY2UgdGhpcyBzdGFjayBmcmFtZVxuICAgIHB1YmxpYyBjb3VudDogbnVtYmVyKSB7fVxufVxuXG4vKipcbiAqIFN0b3JlcyBhIHNldCBvZiBzdGFjayB0cmFjZXMgYXNzb2NpYXRlZCB3aXRoIHNwZWNpZmljIG1lbW9yeSBsZWFrcy5cbiAqXG4gKiBTdXBwb3J0czpcbiAqIC0gTG9va2luZyB1cCB0aGUgbGVha3MgYXNzb2NpYXRlZCB3aXRoIGEgZ2l2ZW4gc291cmNlIGxvY2F0aW9uXG4gKiAtIFJldHVybmluZyBhbGwgb2YgdGhlIHN0YWNrIGZyYW1lcyBsb2NhdGVkIGluIGEgc3BlY2lmaWMgZmlsZVxuICogLSBSZXR1cm5pbmcgdGhlIHN0YWNrIHRyYWNlcyBhc3NvY2lhdGVkIHdpdGggYSBzcGVjaWZpYyBsZWFrXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFN0YWNrVHJhY2VNYW5hZ2VyIHtcbiAgcHVibGljIHN0YXRpYyBGcm9tQkxlYWtSZXN1bHRzKHNvdXJjZUZpbGVNYW5hZ2VyOiBTb3VyY2VGaWxlTWFuYWdlciwgcmVzdWx0czogQkxlYWtSZXN1bHRzKTogU3RhY2tUcmFjZU1hbmFnZXIge1xuICAgIHJldHVybiBuZXcgU3RhY2tUcmFjZU1hbmFnZXIoc291cmNlRmlsZU1hbmFnZXIsIHJlc3VsdHMuc3RhY2tGcmFtZXMsIHJlc3VsdHMubGVha3MpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZnJhbWVTdGF0czogU3RhY2tGcmFtZVN0YXRzW107XG4gIHByaXZhdGUgX2ZpbGVTdGFja0ZyYW1lcyA9IG5ldyBNYXA8U291cmNlRmlsZSwgbnVtYmVyW10+KCk7XG4gIHByaXZhdGUgX2xvY2F0aW9uVG9JZCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gIHByaXZhdGUgX2ZyYW1lczogU3RhY2tGcmFtZVtdO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzZm06IFNvdXJjZUZpbGVNYW5hZ2VyLFxuICAgIGZyYW1lczogSVN0YWNrRnJhbWVbXSxcbiAgICBwcml2YXRlIF9sZWFrczogTGVha1Jvb3RbXVxuICApIHtcbiAgICB0aGlzLl9mcmFtZXMgPSBmcmFtZXMubWFwKChmKSA9PiBuZXcgU3RhY2tGcmFtZShzZm0uZ2V0U291cmNlRmlsZShmWzBdKSwgZlszXSwgZlsxXSwgZlsyXSkpO1xuICAgIHRoaXMuX2ZyYW1lU3RhdHMgPSB0aGlzLl9mcmFtZXMubWFwKChmLCBpZCkgPT4gbmV3IFN0YWNrRnJhbWVTdGF0cyhpZCwgW10sIDApKTtcbiAgICB0aGlzLl9sZWFrcy5mb3JFYWNoKChsKSA9PiB7XG4gICAgICBsLnN0YWNrcy5mb3JFYWNoKChzKSA9PiB7XG4gICAgICAgIGZvciAoY29uc3Qgc2Ygb2Ygcykge1xuICAgICAgICAgIGNvbnN0IHN0YXRzID0gdGhpcy5fZnJhbWVTdGF0c1tzZl07XG4gICAgICAgICAgc3RhdHMuY291bnQrKztcbiAgICAgICAgICBpZiAoc3RhdHMubGVha3MuaW5kZXhPZihsKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHN0YXRzLmxlYWtzLnB1c2gobCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHNmT2JqID0gdGhpcy5fZnJhbWVzW3NmXTtcbiAgICAgICAgICBsZXQgZmlsZVN0YWNrRnJhbWVzID0gdGhpcy5fZmlsZVN0YWNrRnJhbWVzLmdldChzZk9iai5maWxlKTtcbiAgICAgICAgICBpZiAoIWZpbGVTdGFja0ZyYW1lcykge1xuICAgICAgICAgICAgZmlsZVN0YWNrRnJhbWVzID0gW107XG4gICAgICAgICAgICB0aGlzLl9maWxlU3RhY2tGcmFtZXMuc2V0KHNmT2JqLmZpbGUsIGZpbGVTdGFja0ZyYW1lcyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFRPRE86IENvdWxkIHVzZSBhIHNldCwgYnV0IHRoZXNlIGFycmF5cyBhcmUgZXhwZWN0ZWQgdG8gYmUgc21hbGwuXG4gICAgICAgICAgaWYgKGZpbGVTdGFja0ZyYW1lcy5pbmRleE9mKHNmKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGZpbGVTdGFja0ZyYW1lcy5wdXNoKHNmKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5fbG9jYXRpb25Ub0lkLnNldChzZk9iai5rZXksIHNmKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRGcmFtZUZvckxvY2F0aW9uKGxvY2F0aW9uOiBMb2NhdGlvbik6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2xvY2F0aW9uVG9JZC5nZXQobG9jYXRpb24ua2V5KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRMZWFrc0ZvckxvY2F0aW9uKGxvY2F0aW9uOiBMb2NhdGlvbik6IExlYWtSb290W10ge1xuICAgIGNvbnN0IHNmSWQgPSB0aGlzLl9nZXRGcmFtZUZvckxvY2F0aW9uKGxvY2F0aW9uLmdldE9yaWdpbmFsTG9jYXRpb24oKSk7XG4gICAgcmV0dXJuIHRoaXMuX2ZyYW1lU3RhdHNbc2ZJZF0ubGVha3M7XG4gIH1cblxuICBwdWJsaWMgZ2V0RnJhbWVzRm9yRmlsZShmaWxlOiBTb3VyY2VGaWxlKTogU3RhY2tGcmFtZVtdIHtcbiAgICBjb25zdCBmaWxlSW5mbyA9IHRoaXMuX2ZpbGVTdGFja0ZyYW1lcy5nZXQoZmlsZSk7XG4gICAgaWYgKCFmaWxlSW5mbykge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICAvLyBGaWx0ZXIgb3V0IGxvY2F0aW9ucyBhdCBpbnZhbGlkIGxvY2F0aW9ucyAoMCwgLTEsIGV0YykuXG4gICAgcmV0dXJuIGZpbGVJbmZvLm1hcCgoc2YpID0+IHRoaXMuX2ZyYW1lc1tzZl0pLmZpbHRlcigoc2YpID0+IHNmLmxpbmUgPiAwICYmIHNmLmNvbHVtbiA+IDApO1xuICB9XG5cbiAgcHVibGljIGdldFRyYWNlc0ZvckxlYWsobDogTGVha1Jvb3QpOiBTdGFja0ZyYW1lW11bXSB7XG4gICAgcmV0dXJuIGwuc3RhY2tzLm1hcCgocykgPT4gcy5tYXAoKHNmKSA9PiB0aGlzLl9mcmFtZXNbc2ZdKSk7XG4gIH1cblxuICBwdWJsaWMgc3RhY2tUb0ZyYW1lcyhzOiBudW1iZXJbXSk6IFN0YWNrRnJhbWVbXSB7XG4gICAgcmV0dXJuIHMubWFwKChzKSA9PiB0aGlzLl9mcmFtZXNbc10pO1xuICB9XG59Il19